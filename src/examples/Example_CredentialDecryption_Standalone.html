<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmegaFramework - Standalone Credential Decryption</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f4f4f4; }
        .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .section { margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 4px; border-left: 4px solid #3498db; }
        pre { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 4px; overflow-x: auto; }
        .success { color: #27ae60; font-weight: bold; }
        .error { color: #c0392b; font-weight: bold; }
        .warning { color: #f39c12; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Standalone Credential Decryption</h1>
        <p>This example demonstrates how to use the <code>CredentialStore</code> component directly to decrypt credentials from the <code>OMG_FW_Credentials</code> Data Extension without instantiating a full Integration class.</p>

<script runat="server">
    Platform.Load("core", "1.1.1");

    // 1. Load OmegaFramework Core
    // This will automatically handle the loading of dependencies like ResponseWrapper and CredentialStore
    Platform.Function.ContentBlockByName("OMG_FW_OmegaFramework");

    try {
        Write('<div class="section">');
        Write('<h3>1. Initialize CredentialStore</h3>');
        
        // Define the name of the integration record in OMG_FW_Credentials Data Extension
        // In a real scenario, this would be 'SFMC_Production', 'VeevaVault_Amer', etc.
        var integrationName = "SFMC_Production"; 
        
        // Factory creation of CredentialStore
        // We pass the integrationName so the store knows which record to look up
        var credStore = OmegaFramework.create('CredentialStore', {
            integrationName: integrationName
        });

        Write('<p>‚úÖ CredentialStore initialized for: <strong>' + integrationName + '</strong></p>');
        Write('</div>');

        // 2. Retrieve and Decrypt Credentials
        Write('<div class="section">');
        Write('<h3>2. Retrieve & Decrypt Credentials</h3>');
        
        var result = credStore.getCredentials();

        if (result.success) {
            var creds = result.data;
            
            Write('<p class="success">‚úÖ Credentials retrieved and decrypted successfully!</p>');
            
            // Display non-sensitive info
            Write('<ul>');
            Write('<li><strong>Name:</strong> ' + creds.name + '</li>');
            Write('<li><strong>Platform:</strong> ' + creds.platform + '</li>');
            Write('<li><strong>Auth Type:</strong> ' + creds.authType + '</li>');
            Write('<li><strong>Base URL:</strong> ' + creds.baseUrl + '</li>');
            Write('</ul>');

            // Display decrypted sensitive info (masked for security in this example)
            Write('<h4>Decrypted Values (Masked):</h4>');
            Write('<pre>');
            
            if (creds.clientId) {
                Write('ClientId:     ' + maskString(creds.clientId) + '\n');
            }
            if (creds.clientSecret) {
                Write('ClientSecret: ' + maskString(creds.clientSecret) + '\n');
            }
            if (creds.username) {
                Write('Username:     ' + maskString(creds.username) + '\n');
            }
            if (creds.password) {
                Write('Password:     ' + maskString(creds.password) + '\n');
            }
            
            Write('</pre>');

        } else {
            Write('<p class="error">‚ùå Error retrieving credentials:</p>');
            Write('<pre>' + Stringify(result.error) + '</pre>');
            
            if (result.error.code === 'NOT_FOUND' || (result.error.message && result.error.message.indexOf('not found') > -1)) {
                 Write('<p class="warning">‚ö†Ô∏è Tip: Ensure a record with Name="' + integrationName + '" exists in the OMG_FW_Credentials Data Extension.</p>');
            }
        }
        Write('</div>');

        // 3. Manual Decryption (Optional)
        // If you have an encrypted string from elsewhere and want to decrypt it manually
        Write('<div class="section">');
        Write('<h3>3. Manual Decryption (Advanced)</h3>');
        Write('<p>You can also decrypt individual strings if needed using the <code>decrypt()</code> method.</p>');
        
        // Example: We encrypt a test string first to have something valid to decrypt
        // Note: In a real scenario, you would have the encrypted string from a database or file
        var originalText = "SuperSecretValue123!";
        var encrypted = credStore.encrypt(originalText); // Helper method to encrypt
        
        if (encrypted) {
            Write('<p><strong>Original:</strong> ' + originalText + '</p>');
            Write('<p><strong>Encrypted:</strong> ' + encrypted + '</p>');
            
            // Now decrypt it back
            var decrypted = credStore.decrypt(encrypted);
            Write('<p><strong>Decrypted:</strong> ' + decrypted + '</p>');
            
            if (originalText === decrypted) {
                Write('<p class="success">‚úÖ Manual decryption verified!</p>');
            } else {
                Write('<p class="error">‚ùå Decryption mismatch</p>');
            }
        } else {
            Write('<p class="warning">‚ö†Ô∏è Encryption skipped (requires valid keys configured in SFMC)</p>');
        }
        Write('</div>');

    } catch (e) {
        Write('<div class="error">');
        Write('<h3>‚ùå Critical Error</h3>');
        Write('<pre>' + Stringify(e) + '</pre>');
        Write('</div>');
    }

    /**
     * Helper to mask sensitive strings
     */
    function maskString(str) {
        if (!str || str.length < 4) return "****";
        return str.substring(0, 4) + "****" + str.substring(str.length - 4);
    }
</script>

    </div>
</body>
</html>
