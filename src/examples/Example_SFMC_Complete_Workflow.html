<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmegaFramework - Example: Complete Workflow</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #e74c3c;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th {
            background: #e74c3c;
            color: white;
            padding: 12px;
            text-align: left;
        }
        td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        tr:hover {
            background: #f5f5f5;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .workflow-step {
            background: #f8f9fa;
            border-left: 4px solid #e74c3c;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ OmegaFramework - Complete Workflow Example</h1>
        <p><strong>Use Case:</strong> Customer Onboarding System - Read pending customers, process them, update their status, and log the activity.</p>

        <div class="info">
            <strong>üì¶ Required Content Blocks (only 3!):</strong>
            <ul>
                <li><code>OMG_FW_ResponseWrapper</code> - Standardized response handling</li>
                <li><code>OMG_FW_SFMCIntegration</code> - SFMC authentication and API access</li>
                <li><code>OMG_FW_DataExtensionHandler</code> - Data Extension operations</li>
            </ul>
            <strong>üìã Data Extensions Used:</strong>
            <ul>
                <li><code>Customers_Pending</code> - Customers awaiting processing</li>
                <li><code>Customers_Active</code> - Processed and active customers</li>
                <li><code>ProcessingLog</code> - Audit log of processing activities</li>
            </ul>
        </div>

        <div class="warning">
            <strong>‚ö†Ô∏è Mock Data Notice:</strong> This example uses mock credentials and data. Replace with your actual SFMC credentials and Data Extension keys.
        </div>

<script runat="server">
    Platform.Load("core", "1.1.1");

    try {
        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        Write('<h2>üöÄ Step 1: Initialize Framework</h2>');

        // Load only 3 Content Blocks - no duplicate dependencies!
        Platform.Function.ContentBlockByKey("OMG_FW_ResponseWrapper");
        Platform.Function.ContentBlockByKey("OMG_FW_SFMCIntegration");
        Platform.Function.ContentBlockByKey("OMG_FW_DataExtensionHandler");

        Write('<div class="success">‚úÖ Framework components loaded</div>');

        // ============================================================================
        // AUTHENTICATION
        // ============================================================================
        Write('<h2>üîê Step 2: Authenticate with SFMC</h2>');

        /**
         * MOCK DATA - Replace with your actual credentials
         */
        var sfmcConfig = {
            clientId: 'your-client-id-here',
            clientSecret: 'your-client-secret-here',
            authBaseUrl: 'https://YOUR_SUBDOMAIN.auth.marketingcloudapis.com/'
        };

        var sfmc = new SFMCIntegration(sfmcConfig);
        var deHandler = new DataExtensionHandler(sfmc);

        // Verify authentication
        var tokenResult = sfmc.getToken();

        if (!tokenResult.success) {
            throw new Error('Authentication failed: ' + tokenResult.error.message);
        }

        Write('<div class="success">‚úÖ Authenticated successfully</div>');

        // ============================================================================
        // WORKFLOW EXECUTION
        // ============================================================================
        Write('<h2>üìã Step 3: Execute Customer Onboarding Workflow</h2>');

        /**
         * MOCK DATA EXTENSIONS - Replace with your actual DE keys
         */
        var DE_PENDING = 'Customers_Pending';
        var DE_ACTIVE = 'Customers_Active';
        var DE_LOG = 'ProcessingLog';

        // Workflow statistics
        var stats = {
            total: 0,
            processed: 0,
            failed: 0,
            errors: []
        };

        // ============================================================================
        // STEP 3A: Read pending customers
        // ============================================================================
        Write('<div class="workflow-step">');
        Write('<h3>üìñ Reading pending customers from <code>' + DE_PENDING + '</code>...</h3>');

        var pendingCustomersResult = deHandler.query(DE_PENDING);

        if (!pendingCustomersResult.success) {
            Write('<div class="error">‚ùå Failed to read pending customers: ' + pendingCustomersResult.error.message + '</div>');
            throw new Error('Cannot proceed without pending customers data');
        }

        var pendingCustomers = pendingCustomersResult.data.items || [];
        stats.total = pendingCustomers.length;

        Write('<div class="success">');
        Write('‚úÖ Found <strong>' + stats.total + '</strong> pending customers to process');
        Write('</div>');
        Write('</div>');

        /**
         * MOCK DATA - If no real data exists, create mock customers for demonstration
         */
        if (pendingCustomers.length === 0) {
            Write('<div class="info">No pending customers found in Data Extension. Creating mock data for demonstration...</div>');

            pendingCustomers = [
                {
                    CustomerID: 'C' + new Date().getTime() + '001',
                    FirstName: 'Juan',
                    LastName: 'P√©rez',
                    Email: 'juan.perez@example.com',
                    Phone: '+34 123 456 789',
                    Country: 'Spain',
                    SignupDate: new Date().toISOString()
                },
                {
                    CustomerID: 'C' + new Date().getTime() + '002',
                    FirstName: 'Mar√≠a',
                    LastName: 'Garc√≠a',
                    Email: 'maria.garcia@example.com',
                    Phone: '+34 987 654 321',
                    Country: 'Spain',
                    SignupDate: new Date().toISOString()
                },
                {
                    CustomerID: 'C' + new Date().getTime() + '003',
                    FirstName: 'Carlos',
                    LastName: 'Rodr√≠guez',
                    Email: 'carlos.rodriguez@example.com',
                    Phone: '+34 555 123 456',
                    Country: 'Spain',
                    SignupDate: new Date().toISOString()
                }
            ];

            stats.total = pendingCustomers.length;
        }

        // ============================================================================
        // STEP 3B: Process each customer
        // ============================================================================
        Write('<div class="workflow-step">');
        Write('<h3>‚öôÔ∏è Processing customers...</h3>');

        // Display customers in table
        Write('<table>');
        Write('<tr><th>Customer ID</th><th>Name</th><th>Email</th><th>Status</th></tr>');

        for (var i = 0; i < pendingCustomers.length; i++) {
            var customer = pendingCustomers[i];

            try {
                // Business logic: Enrich customer data
                var enrichedCustomer = {
                    CustomerID: customer.CustomerID,
                    FirstName: customer.FirstName,
                    LastName: customer.LastName,
                    Email: customer.Email,
                    Phone: customer.Phone || '',
                    Country: customer.Country || 'Unknown',
                    SignupDate: customer.SignupDate || new Date().toISOString(),
                    ActivationDate: new Date().toISOString(),
                    Status: 'Active',
                    WelcomeEmailSent: false,
                    AccountTier: 'Standard'
                };

                // ============================================================================
                // STEP 3C: Insert into active customers
                // ============================================================================
                var insertResult = deHandler.insertRow(DE_ACTIVE, enrichedCustomer);

                if (!insertResult.success) {
                    throw new Error('Insert failed: ' + insertResult.error.message);
                }

                // ============================================================================
                // STEP 3D: Log the processing activity
                // ============================================================================
                var logEntry = {
                    LogID: 'LOG_' + new Date().getTime() + '_' + i,
                    CustomerID: customer.CustomerID,
                    Action: 'CustomerActivated',
                    Status: 'Success',
                    Details: 'Customer successfully activated and moved to active customers',
                    ProcessedAt: new Date().toISOString(),
                    ProcessedBy: 'OmegaFramework_Workflow'
                };

                var logResult = deHandler.insertRow(DE_LOG, logEntry);

                // ============================================================================
                // STEP 3E: Remove from pending (optional - could also update status)
                // ============================================================================
                var deleteResult = deHandler.deleteRow(DE_PENDING, { CustomerID: customer.CustomerID });

                // Update statistics
                stats.processed++;

                // Display success
                Write('<tr style="background: #d4edda;">');
                Write('<td>' + customer.CustomerID + '</td>');
                Write('<td>' + customer.FirstName + ' ' + customer.LastName + '</td>');
                Write('<td>' + customer.Email + '</td>');
                Write('<td><strong style="color: green;">‚úÖ Processed</strong></td>');
                Write('</tr>');

            } catch (error) {
                // Handle processing error
                stats.failed++;
                stats.errors.push({
                    customerID: customer.CustomerID,
                    error: error.message || error.toString()
                });

                // Log the error
                var errorLogEntry = {
                    LogID: 'LOG_' + new Date().getTime() + '_ERR_' + i,
                    CustomerID: customer.CustomerID,
                    Action: 'CustomerActivation',
                    Status: 'Error',
                    Details: error.message || error.toString(),
                    ProcessedAt: new Date().toISOString(),
                    ProcessedBy: 'OmegaFramework_Workflow'
                };

                deHandler.insertRow(DE_LOG, errorLogEntry);

                // Display error
                Write('<tr style="background: #f8d7da;">');
                Write('<td>' + customer.CustomerID + '</td>');
                Write('<td>' + customer.FirstName + ' ' + customer.LastName + '</td>');
                Write('<td>' + customer.Email + '</td>');
                Write('<td><strong style="color: red;">‚ùå Failed</strong></td>');
                Write('</tr>');
            }
        }

        Write('</table>');
        Write('</div>');

        // ============================================================================
        // STEP 4: Display Results
        // ============================================================================
        Write('<h2>üìä Step 4: Processing Results</h2>');

        var successRate = stats.total > 0 ? Math.round((stats.processed / stats.total) * 100) : 0;

        Write('<div class="' + (stats.failed === 0 ? 'success' : 'warning') + '">');
        Write('<h3>Summary Statistics</h3>');
        Write('<table style="background: transparent; margin: 0;">');
        Write('<tr><td><strong>Total Customers:</strong></td><td>' + stats.total + '</td></tr>');
        Write('<tr><td><strong>Successfully Processed:</strong></td><td style="color: green;">' + stats.processed + '</td></tr>');
        Write('<tr><td><strong>Failed:</strong></td><td style="color: red;">' + stats.failed + '</td></tr>');
        Write('<tr><td><strong>Success Rate:</strong></td><td><strong>' + successRate + '%</strong></td></tr>');
        Write('</table>');

        if (stats.errors.length > 0) {
            Write('<h4>Error Details:</h4>');
            Write('<ul>');
            for (var e = 0; e < stats.errors.length; e++) {
                Write('<li>Customer <code>' + stats.errors[e].customerID + '</code>: ' + stats.errors[e].error + '</li>');
            }
            Write('</ul>');
        }
        Write('</div>');

        // ============================================================================
        // STEP 5: Verify Data
        // ============================================================================
        Write('<h2>üîç Step 5: Verify Results</h2>');

        Write('<div class="workflow-step">');
        Write('<h3>Checking Active Customers Data Extension...</h3>');

        var activeCustomersResult = deHandler.query(DE_ACTIVE);

        if (activeCustomersResult.success) {
            Write('<div class="success">');
            Write('‚úÖ Active Customers DE now contains: <strong>' + activeCustomersResult.data.count + '</strong> customers');
            Write('</div>');
        }
        Write('</div>');

        Write('<div class="workflow-step">');
        Write('<h3>Checking Processing Log...</h3>');

        var logResult = deHandler.query(DE_LOG);

        if (logResult.success) {
            Write('<div class="success">');
            Write('‚úÖ Processing Log contains: <strong>' + logResult.data.count + '</strong> log entries');
            Write('</div>');

            // Display recent log entries
            if (logResult.data.items && logResult.data.items.length > 0) {
                Write('<h4>Recent Log Entries:</h4>');
                Write('<table>');
                Write('<tr><th>Time</th><th>Customer ID</th><th>Action</th><th>Status</th></tr>');

                var recentLogs = logResult.data.items.slice(-5).reverse(); // Last 5 entries
                for (var l = 0; l < recentLogs.length; l++) {
                    var log = recentLogs[l];
                    var statusColor = log.Status === 'Success' ? 'green' : 'red';

                    Write('<tr>');
                    Write('<td>' + (log.ProcessedAt || 'N/A') + '</td>');
                    Write('<td>' + (log.CustomerID || 'N/A') + '</td>');
                    Write('<td>' + (log.Action || 'N/A') + '</td>');
                    Write('<td style="color: ' + statusColor + ';"><strong>' + (log.Status || 'N/A') + '</strong></td>');
                    Write('</tr>');
                }

                Write('</table>');
            }
        }
        Write('</div>');

        // ============================================================================
        // SUMMARY AND BEST PRACTICES
        // ============================================================================
        Write('<h2>‚ú® Workflow Summary</h2>');

        Write('<div class="success">');
        Write('<h3>What This Workflow Demonstrated:</h3>');
        Write('<ol>');
        Write('<li>‚úÖ <strong>Single-load pattern</strong> - Only 3 Content Block imports, no duplicates</li>');
        Write('<li>‚úÖ <strong>Authentication</strong> - Automatic OAuth2 token management</li>');
        Write('<li>‚úÖ <strong>Read operations</strong> - Query pending customers from Data Extension</li>');
        Write('<li>‚úÖ <strong>Write operations</strong> - Insert processed customers and log entries</li>');
        Write('<li>‚úÖ <strong>Delete operations</strong> - Remove processed customers from pending queue</li>');
        Write('<li>‚úÖ <strong>Error handling</strong> - Graceful error handling with detailed logging</li>');
        Write('<li>‚úÖ <strong>Data enrichment</strong> - Business logic to enhance customer data</li>');
        Write('<li>‚úÖ <strong>Audit logging</strong> - Track all processing activities</li>');
        Write('<li>‚úÖ <strong>Verification</strong> - Confirm results after processing</li>');
        Write('</ol>');
        Write('</div>');

        Write('<h2>üí° Best Practices</h2>');

        Write('<div class="info">');
        Write('<h3>Production Recommendations:</h3>');
        Write('<ul>');
        Write('<li>üîê <strong>Credentials:</strong> Use <code>CredentialStore</code> instead of hardcoded credentials</li>');
        Write('<li>üìù <strong>Logging:</strong> Always log operations for audit trails and debugging</li>');
        Write('<li>üõ°Ô∏è <strong>Error Handling:</strong> Check <code>result.success</code> before using <code>result.data</code></li>');
        Write('<li>‚ö° <strong>Performance:</strong> Use filters to reduce data transfer when possible</li>');
        Write('<li>üîÑ <strong>Idempotency:</strong> Use upsert operations when rerunning workflows</li>');
        Write('<li>üìä <strong>Monitoring:</strong> Track success rates and set up alerts for failures</li>');
        Write('<li>üß™ <strong>Testing:</strong> Always test with small datasets first</li>');
        Write('<li>üì¶ <strong>Batch Processing:</strong> Process in batches for large datasets</li>');
        Write('</ul>');
        Write('</div>');

        Write('<h2>üéì Code Template</h2>');

        Write('<div class="info">');
        Write('<strong>Use this template for your own workflows:</strong>');
        Write('<pre>');
        Write('// 1. Load framework (only 3 imports!)\n');
        Write('Platform.Function.ContentBlockByKey("OMG_FW_ResponseWrapper");\n');
        Write('Platform.Function.ContentBlockByKey("OMG_FW_SFMCIntegration");\n');
        Write('Platform.Function.ContentBlockByKey("OMG_FW_DataExtensionHandler");\n\n');

        Write('// 2. Initialize\n');
        Write('var sfmc = new SFMCIntegration(config);\n');
        Write('var deHandler = new DataExtensionHandler(sfmc);\n\n');

        Write('// 3. Read data\n');
        Write('var result = deHandler.query("YourDE_Key");\n');
        Write('if (!result.success) {\n');
        Write('    // Handle error\n');
        Write('    throw new Error(result.error.message);\n');
        Write('}\n\n');

        Write('// 4. Process data\n');
        Write('var items = result.data.items;\n');
        Write('for (var i = 0; i < items.length; i++) {\n');
        Write('    // Your business logic here\n');
        Write('    var processedItem = processItem(items[i]);\n\n');

        Write('    // 5. Write results\n');
        Write('    var insertResult = deHandler.insertRow("TargetDE_Key", processedItem);\n');
        Write('    if (!insertResult.success) {\n');
        Write('        // Handle error\n');
        Write('    }\n');
        Write('}\n');
        Write('</pre>');
        Write('</div>');

    } catch (ex) {
        Write('<div class="error">');
        Write('<strong>‚ùå Critical Error:</strong><br>');
        Write(Stringify(ex));
        Write('</div>');
    }
</script>

    </div>
</body>
</html>
