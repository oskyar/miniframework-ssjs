<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmegaFramework - Example: Read Data Extension</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th {
            background: #3498db;
            color: white;
            padding: 12px;
            text-align: left;
        }
        td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        tr:hover {
            background: #f5f5f5;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç OmegaFramework - Read Data Extension Example</h1>
        <p><strong>Purpose:</strong> This example demonstrates how to read data from a Salesforce Marketing Cloud Data Extension using only 3 Content Block imports.</p>

        <div class="info">
            <strong>üì¶ Required Content Blocks:</strong>
            <ul>
                <li><code>OMG_FW_ResponseWrapper</code> - Standardized response handling</li>
                <li><code>OMG_FW_SFMCIntegration</code> - SFMC authentication and API access</li>
                <li><code>OMG_FW_DataExtensionHandler</code> - Data Extension operations</li>
            </ul>
            <strong>üìã Prerequisites:</strong>
            <ul>
                <li>Data Extension: <code>OMG_FW_Credentials</code> with your SFMC API credentials</li>
                <li>Target Data Extension to query (example uses <code>Customers_DE</code>)</li>
            </ul>
        </div>

<script runat="server">
    Platform.Load("core", "1.1.1");

    try {
        Write('<h2>üìù Step 1: Load Framework Components</h2>');

        // Load only 3 Content Blocks - no duplicate dependencies!
        Platform.Function.ContentBlockByKey("OMG_FW_ResponseWrapper");
        Platform.Function.ContentBlockByKey("OMG_FW_SFMCIntegration");
        Platform.Function.ContentBlockByKey("OMG_FW_DataExtensionHandler");

        Write('<div class="success">‚úÖ All framework components loaded successfully</div>');

        // ============================================================================
        // Step 2: Configure SFMC Integration
        // ============================================================================
        Write('<h2>üîê Step 2: Configure SFMC Authentication</h2>');

        /**
         * MOCK DATA - Replace with your actual SFMC credentials
         * In production, these should come from CredentialStore or secure storage
         */
        var sfmcConfig = {
            clientId: 'your-client-id-here',
            clientSecret: 'your-client-secret-here',
            authBaseUrl: 'https://YOUR_SUBDOMAIN.auth.marketingcloudapis.com/',
            accountId: '123456',  // Optional: Your SFMC Account MID
            scope: null  // Optional: OAuth scope
        };

        Write('<div class="info">');
        Write('<strong>Configuration:</strong><br>');
        Write('Auth URL: ' + sfmcConfig.authBaseUrl + '<br>');
        Write('Client ID: ' + sfmcConfig.clientId.substring(0, 8) + '...<br>');
        Write('Account ID: ' + (sfmcConfig.accountId || 'Not specified'));
        Write('</div>');

        // Initialize SFMC Integration
        var sfmc = new SFMCIntegration(sfmcConfig);

        Write('<div class="success">‚úÖ SFMC Integration initialized</div>');

        // ============================================================================
        // Step 3: Initialize Data Extension Handler
        // ============================================================================
        Write('<h2>üìä Step 3: Initialize Data Extension Handler</h2>');

        var deHandler = new DataExtensionHandler(sfmc);

        Write('<div class="success">‚úÖ DataExtensionHandler ready</div>');

        // ============================================================================
        // Step 4: Query Data Extension - Example 1: Get All Rows
        // ============================================================================
        Write('<h2>üîé Step 4: Query Data Extension (All Rows)</h2>');

        /**
         * MOCK DATA - Replace with your actual Data Extension key
         */
        var dataExtensionKey = 'Customers_DE';

        Write('<div class="info">Querying Data Extension: <code>' + dataExtensionKey + '</code></div>');

        var queryResult = deHandler.query(dataExtensionKey);

        if (queryResult.success) {
            Write('<div class="success">');
            Write('<strong>‚úÖ Query Successful</strong><br>');
            Write('Rows returned: ' + queryResult.data.count);
            Write('</div>');

            // Display results in table
            if (queryResult.data.items && queryResult.data.items.length > 0) {
                Write('<h3>üìã Results:</h3>');
                Write('<table>');

                // Table header - dynamically get columns from first row
                var firstRow = queryResult.data.items[0];
                Write('<tr>');
                for (var col in firstRow) {
                    if (firstRow.hasOwnProperty(col)) {
                        Write('<th>' + col + '</th>');
                    }
                }
                Write('</tr>');

                // Table rows
                for (var i = 0; i < queryResult.data.items.length; i++) {
                    var row = queryResult.data.items[i];
                    Write('<tr>');
                    for (var col in row) {
                        if (row.hasOwnProperty(col)) {
                            Write('<td>' + (row[col] || '') + '</td>');
                        }
                    }
                    Write('</tr>');
                }

                Write('</table>');
            } else {
                Write('<div class="info">No rows found in Data Extension</div>');
            }

        } else {
            Write('<div class="error">');
            Write('<strong>‚ùå Query Failed</strong><br>');
            Write('Error Code: ' + queryResult.error.code + '<br>');
            Write('Message: ' + queryResult.error.message + '<br>');
            Write('Details: ' + Stringify(queryResult.error.details));
            Write('</div>');
        }

        // ============================================================================
        // Step 5: Query with Filter - Example 2: Filtered Query
        // ============================================================================
        Write('<h2>üîé Step 5: Query with Filter</h2>');

        /**
         * MOCK DATA - Example filter
         * This will look up rows where CustomerID = 'C001'
         */
        var filterOptions = {
            filter: {
                columns: ['CustomerID'],
                values: ['C001']
            }
        };

        Write('<div class="info">');
        Write('Filtering by: <code>CustomerID = "C001"</code>');
        Write('</div>');

        var filteredResult = deHandler.query(dataExtensionKey, filterOptions);

        if (filteredResult.success) {
            Write('<div class="success">');
            Write('<strong>‚úÖ Filtered Query Successful</strong><br>');
            Write('Rows returned: ' + filteredResult.data.count);
            Write('</div>');

            if (filteredResult.data.items && filteredResult.data.items.length > 0) {
                Write('<h3>üìã Filtered Results:</h3>');
                Write('<pre>' + Stringify(filteredResult.data.items, null, 2) + '</pre>');
            } else {
                Write('<div class="info">No rows matched the filter criteria</div>');
            }

        } else {
            Write('<div class="error">');
            Write('<strong>‚ùå Filtered Query Failed</strong><br>');
            Write('Error: ' + filteredResult.error.message);
            Write('</div>');
        }

        // ============================================================================
        // Step 6: Response Structure Documentation
        // ============================================================================
        Write('<h2>üìö Understanding the Response Structure</h2>');

        Write('<div class="info">');
        Write('<strong>All framework methods return a standardized response:</strong>');
        Write('<pre>');
        Write('{\n');
        Write('  success: boolean,      // Operation success status\n');
        Write('  data: {                // Response data (null if error)\n');
        Write('    items: [],           // Array of rows\n');
        Write('    count: number        // Number of rows returned\n');
        Write('  },\n');
        Write('  error: {               // Error details (null if success)\n');
        Write('    code: string,        // Error type identifier\n');
        Write('    message: string,     // Human-readable error\n');
        Write('    details: object      // Additional context\n');
        Write('  },\n');
        Write('  meta: {                // Operation metadata\n');
        Write('    datetime: date,      // Timestamp\n');
        Write('    handler: string,     // Handler name\n');
        Write('    operation: string    // Method name\n');
        Write('  }\n');
        Write('}');
        Write('</pre>');
        Write('</div>');

        // ============================================================================
        // Summary
        // ============================================================================
        Write('<h2>‚ú® Summary</h2>');
        Write('<div class="success">');
        Write('<strong>Key Benefits:</strong>');
        Write('<ul>');
        Write('<li>‚úÖ Only 3 Content Block imports required</li>');
        Write('<li>‚úÖ No duplicate dependencies</li>');
        Write('<li>‚úÖ Standardized error handling via ResponseWrapper</li>');
        Write('<li>‚úÖ Dual-strategy approach: SSJS first, REST API fallback</li>');
        Write('<li>‚úÖ Works with both enterprise and non-enterprise Data Extensions</li>');
        Write('</ul>');
        Write('</div>');

    } catch (ex) {
        Write('<div class="error">');
        Write('<strong>‚ùå Critical Error:</strong><br>');
        Write(Stringify(ex));
        Write('</div>');
    }
</script>

    </div>
</body>
</html>
