<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmegaFramework - Example: SFMC Authentication</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #9b59b6;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .token-display {
            background: #f8f9fa;
            border-left: 4px solid #9b59b6;
            padding: 15px;
            margin: 15px 0;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê OmegaFramework - SFMC Authentication Complete Example</h1>
        <p><strong>Purpose:</strong> This example demonstrates complete OAuth2 authentication with Salesforce Marketing Cloud, including token management, caching, and refresh.</p>

        <div class="info">
            <strong>üì¶ Required Content Blocks:</strong>
            <ul>
                <li><code>OMG_FW_OmegaFramework</code> - Core framework loader</li>
                <li><code>OMG_FW_ResponseWrapper</code> - Standardized response handling</li>
                <li><code>OMG_FW_ConnectionHandler</code> - HTTP request management</li>
                <li><code>OMG_FW_DataExtensionTokenCache</code> - Token caching in Data Extensions</li>
                <li><code>OMG_FW_BaseIntegration</code> - Base integration logic</li>
                <li><code>OMG_FW_SFMCIntegration</code> - SFMC integration (handles OAuth2 internally)</li>
            </ul>
            <strong>üìã Prerequisites:</strong>
            <ul>
                <li>SFMC Installed Package with Server-to-Server authentication</li>
                <li>Client ID and Client Secret from your Installed Package</li>
                <li>Data Extension: <code>OMG_FW_TokenCache</code> (created by AutomatedInstaller)</li>
            </ul>
        </div>

<script runat="server">
    Platform.Load("core", "1.1.1");

    try {
        Write('<h2>üìù Step 1: Load Framework Components</h2>');

        // Load OmegaFramework first
        Platform.Function.ContentBlockByName("OMG_FW_OmegaFramework");

        // Load all necessary components for authentication
        // Note: SFMCIntegration now handles OAuth2 internally - no separate auth strategy needed
        Platform.Function.ContentBlockByName("OMG_FW_ResponseWrapper");
        Platform.Function.ContentBlockByName("OMG_FW_ConnectionHandler");
        Platform.Function.ContentBlockByName("OMG_FW_DataExtensionTokenCache");
        Platform.Function.ContentBlockByName("OMG_FW_BaseIntegration");
        Platform.Function.ContentBlockByName("OMG_FW_SFMCIntegration");

        Write('<div class="success">‚úÖ All framework components loaded successfully</div>');

        // ============================================================================
        // Step 2: Configure SFMC Credentials
        // ============================================================================
        Write('<h2>üîë Step 2: Configure SFMC Credentials</h2>');

        Write('<div class="warning">');
        Write('<strong>‚ö†Ô∏è Important:</strong> Replace these mock credentials with your actual SFMC Installed Package credentials.');
        Write('</div>');

        /**
         * MOCK DATA - REPLACE WITH YOUR ACTUAL CREDENTIALS
         *
         * How to get these values:
         * 1. Go to SFMC Setup > Apps > Installed Packages
         * 2. Create or open an Installed Package
         * 3. Add/edit a Server-to-Server component
         * 4. Copy the Client ID and Client Secret
         * 5. The Auth Base URL follows this pattern:
         *    https://YOUR_SUBDOMAIN.auth.marketingcloudapis.com/
         *    (Replace YOUR_SUBDOMAIN with your SFMC subdomain)
         */
        var sfmcCredentials = {
            clientId: 'abc123def456ghi789jkl012mno345pq',
            clientSecret: 'rstuvwxyz1234567890ABCDEFGHIJK',
            authBaseUrl: 'https://mc123456789.auth.marketingcloudapis.com/',
            accountId: '123456789',  // Optional: Your SFMC Account MID
            scope: null  // Optional: Specific scopes (null = all granted scopes)
        };

        Write('<div class="info">');
        Write('<strong>Configuration loaded:</strong><br>');
        Write('Auth Base URL: <code>' + sfmcCredentials.authBaseUrl + '</code><br>');
        Write('Client ID: <code>' + sfmcCredentials.clientId.substring(0, 12) + '...</code><br>');
        Write('Account ID: <code>' + (sfmcCredentials.accountId || 'Not specified') + '</code><br>');
        Write('Scope: <code>' + (sfmcCredentials.scope || 'All granted scopes') + '</code>');
        Write('</div>');

        // ============================================================================
        // Step 3: Initialize SFMC Integration
        // ============================================================================
        Write('<h2>üöÄ Step 3: Initialize SFMC Integration</h2>');

        var sfmc = new SFMCIntegration(sfmcCredentials);

        Write('<div class="success">');
        Write('‚úÖ SFMCIntegration instance created<br>');
        Write('The integration is now ready to authenticate and make API calls.');
        Write('</div>');

        // ============================================================================
        // Step 4: Obtain OAuth2 Token
        // ============================================================================
        Write('<h2>üé´ Step 4: Obtain OAuth2 Access Token</h2>');

        Write('<div class="info">');
        Write('<strong>How it works:</strong><br>');
        Write('1. First call checks the <code>OMG_FW_TokenCache</code> Data Extension<br>');
        Write('2. If valid cached token exists, returns it immediately (fast!)<br>');
        Write('3. If no cache or expired, requests new token from SFMC OAuth endpoint<br>');
        Write('4. New token is cached automatically for future requests<br>');
        Write('5. Token refresh happens automatically when needed');
        Write('</div>');

        var tokenResult = sfmc.getToken();

        if (tokenResult.success) {
            Write('<div class="success">');
            Write('<strong>‚úÖ Authentication Successful!</strong>');
            Write('</div>');

            // Display token information (safely)
            var tokenData = tokenResult.data;

            Write('<div class="token-display">');
            Write('<strong>Token Information:</strong><br><br>');
            Write('<strong>Access Token:</strong> ' + tokenData.accessToken.substring(0, 20) + '...[truncated for security]<br>');
            Write('<strong>Token Type:</strong> ' + tokenData.tokenType + '<br>');
            Write('<strong>Expires In:</strong> ' + tokenData.expiresIn + ' seconds (' + Math.round(tokenData.expiresIn / 60) + ' minutes)<br>');
            Write('<strong>Issued At:</strong> ' + new Date(tokenData.issuedAt).toISOString() + '<br>');
            Write('<strong>Expires At:</strong> ' + new Date(tokenData.expiresAt).toISOString() + '<br>');

            if (tokenData.restInstanceUrl) {
                Write('<strong>REST Instance URL:</strong> <code>' + tokenData.restInstanceUrl + '</code><br>');
            }

            if (tokenData.soapInstanceUrl) {
                Write('<strong>SOAP Instance URL:</strong> <code>' + tokenData.soapInstanceUrl + '</code><br>');
            }

            Write('</div>');

            // ============================================================================
            // Step 5: Check Token Expiration Status
            // ============================================================================
            Write('<h2>‚è∞ Step 5: Token Expiration Status</h2>');

            var isExpired = sfmc.isTokenExpired();

            Write('<div class="' + (isExpired ? 'error' : 'success') + '">');
            Write('<strong>Token Status:</strong> ' + (isExpired ? '‚ùå Expired' : '‚úÖ Valid') + '<br>');

            if (!isExpired) {
                var now = new Date().getTime();
                var expiresAt = tokenData.expiresAt;
                var timeRemaining = Math.round((expiresAt - now) / 1000);
                var minutesRemaining = Math.floor(timeRemaining / 60);
                var secondsRemaining = timeRemaining % 60;

                Write('<strong>Time Remaining:</strong> ' + minutesRemaining + ' minutes, ' + secondsRemaining + ' seconds');
            }
            Write('</div>');

            // ============================================================================
            // Step 6: Get REST API Instance URL
            // ============================================================================
            Write('<h2>üåê Step 6: REST API Instance URL</h2>');

            var restUrlResult = sfmc.getRestUrl();

            if (restUrlResult.success) {
                Write('<div class="success">');
                Write('<strong>‚úÖ REST Instance URL Retrieved:</strong><br>');
                Write('<code>' + restUrlResult.data + '</code>');
                Write('</div>');

                Write('<div class="info">');
                Write('<strong>üí° What is this?</strong><br>');
                Write('This is the base URL for all REST API calls to your specific SFMC instance. ');
                Write('The framework automatically uses this URL for all API requests, so you don\'t need to worry about it!');
                Write('</div>');
            }

            // ============================================================================
            // Step 7: Test API Call - List Assets
            // ============================================================================
            Write('<h2>üß™ Step 7: Test API Call (List Assets)</h2>');

            Write('<div class="info">');
            Write('Making a test API call to verify authentication is working...<br>');
            Write('Endpoint: <code>GET /asset/v1/content/assets</code>');
            Write('</div>');

            var assetsResult = sfmc.listAssets({ '$page': 1, '$pageSize': 5 });

            if (assetsResult.success) {
                Write('<div class="success">');
                Write('<strong>‚úÖ API Call Successful!</strong><br>');

                if (assetsResult.data.items && assetsResult.data.items.length > 0) {
                    Write('Retrieved ' + assetsResult.data.items.length + ' assets from Content Builder.<br><br>');
                    Write('<strong>Sample Assets:</strong>');
                    Write('<ul>');
                    for (var i = 0; i < Math.min(assetsResult.data.items.length, 3); i++) {
                        var asset = assetsResult.data.items[i];
                        Write('<li><strong>' + asset.name + '</strong> (Type: ' + asset.assetType.name + ')</li>');
                    }
                    Write('</ul>');
                } else {
                    Write('No assets found in Content Builder, but authentication is working correctly!');
                }

                Write('</div>');
            } else {
                Write('<div class="error">');
                Write('<strong>‚ùå API Call Failed</strong><br>');
                Write('Error: ' + assetsResult.error.message + '<br>');
                Write('Code: ' + assetsResult.error.code);
                Write('</div>');
            }

        } else {
            // Authentication failed
            Write('<div class="error">');
            Write('<strong>‚ùå Authentication Failed</strong><br>');
            Write('<strong>Error Code:</strong> ' + tokenResult.error.code + '<br>');
            Write('<strong>Message:</strong> ' + tokenResult.error.message + '<br>');

            if (tokenResult.error.details) {
                Write('<strong>Details:</strong><br>');
                Write('<pre>' + Stringify(tokenResult.error.details, null, 2) + '</pre>');
            }

            Write('</div>');

            Write('<div class="warning">');
            Write('<strong>Common Issues:</strong>');
            Write('<ul>');
            Write('<li>Verify Client ID and Client Secret are correct</li>');
            Write('<li>Ensure Auth Base URL matches your SFMC subdomain</li>');
            Write('<li>Check that the Installed Package has proper scopes enabled</li>');
            Write('<li>Verify the <code>OMG_FW_TokenCache</code> Data Extension exists</li>');
            Write('</ul>');
            Write('</div>');
        }

        // ============================================================================
        // Step 8: Token Management Operations
        // ============================================================================
        Write('<h2>üîß Step 8: Token Management Operations</h2>');

        Write('<div class="info">');
        Write('<strong>Available Token Management Methods:</strong>');
        Write('<ul>');
        Write('<li><code>sfmc.getToken()</code> - Get current token (from cache or new)</li>');
        Write('<li><code>sfmc.isTokenExpired()</code> - Check if token is expired</li>');
        Write('<li><code>sfmc.refreshToken()</code> - Force new token request</li>');
        Write('<li><code>sfmc.clearTokenCache()</code> - Clear cached token</li>');
        Write('</ul>');
        Write('</div>');

        // Example: Force token refresh
        Write('<h3>Force Token Refresh Example:</h3>');
        Write('<pre>');
        Write('// Clear the cache and get a fresh token\n');
        Write('var clearResult = sfmc.clearTokenCache();\n');
        Write('if (clearResult.success) {\n');
        Write('    // Request new token\n');
        Write('    var newTokenResult = sfmc.refreshToken();\n');
        Write('    if (newTokenResult.success) {\n');
        Write('        Write("New token obtained!");\n');
        Write('    }\n');
        Write('}\n');
        Write('</pre>');

        // ============================================================================
        // Step 9: Making Custom API Requests
        // ============================================================================
        Write('<h2>üîå Step 9: Making Custom API Requests</h2>');

        Write('<div class="info">');
        Write('<strong>You can make any SFMC REST API call using:</strong><br>');
        Write('<code>sfmc.makeRestRequest(method, endpoint, data, options)</code>');
        Write('</div>');

        Write('<h3>Example API Calls:</h3>');
        Write('<pre>');
        Write('// Get all Data Extensions\n');
        Write('var result = sfmc.makeRestRequest("GET", "/data/v1/customobjectdata");\n\n');

        Write('// Query a Data Extension\n');
        Write('var deResult = sfmc.makeRestRequest(\n');
        Write('    "GET",\n');
        Write('    "/data/v1/customobjectdata/key/MyDE_Key/rowset"\n');
        Write(');\n\n');

        Write('// Create an asset\n');
        Write('var assetData = {\n');
        Write('    name: "My Asset",\n');
        Write('    assetType: { name: "htmlblock" },\n');
        Write('    content: "<h1>Hello World</h1>"\n');
        Write('};\n');
        Write('var createResult = sfmc.makeRestRequest(\n');
        Write('    "POST",\n');
        Write('    "/asset/v1/content/assets",\n');
        Write('    assetData\n');
        Write(');\n');
        Write('</pre>');

        // ============================================================================
        // Summary
        // ============================================================================
        Write('<h2>‚ú® Summary</h2>');
        Write('<div class="success">');
        Write('<strong>What We Accomplished:</strong>');
        Write('<ul>');
        Write('<li>‚úÖ Loaded framework components without duplicate dependencies</li>');
        Write('<li>‚úÖ Configured SFMC OAuth2 credentials</li>');
        Write('<li>‚úÖ Obtained access token with automatic caching</li>');
        Write('<li>‚úÖ Retrieved REST API instance URL</li>');
        Write('<li>‚úÖ Made authenticated API call to verify authentication</li>');
        Write('<li>‚úÖ Learned token management operations</li>');
        Write('</ul>');

        Write('<strong>Key Features:</strong>');
        Write('<ul>');
        Write('<li>üöÄ Automatic token caching in Data Extension</li>');
        Write('<li>üîÑ Automatic token refresh when expired</li>');
        Write('<li>üåê Automatic REST instance URL discovery</li>');
        Write('<li>üõ°Ô∏è Standardized error handling with ResponseWrapper</li>');
        Write('<li>‚ö° Optimized performance with persistent cache</li>');
        Write('</ul>');

        Write('<strong>Next Steps:</strong>');
        Write('<ul>');
        Write('<li>üìñ See <code>Example_SFMC_DataExtension_Read.html</code> to learn how to read Data Extensions</li>');
        Write('<li>‚úçÔ∏è See <code>Example_SFMC_DataExtension_Write.html</code> to learn how to write to Data Extensions</li>');
        Write('<li>üîê Use <code>CredentialStore</code> for secure credential management in production</li>');
        Write('</ul>');
        Write('</div>');

    } catch (ex) {
        Write('<div class="error">');
        Write('<strong>‚ùå Critical Error:</strong><br>');
        Write(Stringify(ex));
        Write('</div>');
    }
</script>

    </div>
</body>
</html>
