<!DOCTYPE html>
<html>
<head>
    <title>OmegaFramework - Ejemplo SFMCIntegration</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        h1 { color: #0176d3; }
        h2 { color: #16325c; border-bottom: 2px solid #0176d3; padding-bottom: 10px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .code { background: #f4f4f4; border-left: 4px solid #0176d3; padding: 10px; margin: 10px 0; font-family: monospace; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #0176d3; color: white; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
<script runat="server">
Platform.Load("core", "1.1.1");

/**
 * Ejemplo completo de SFMCIntegration usando OmegaFramework v3.0
 *
 * Este ejemplo demuestra:
 * - Inicialización con CredentialStore (producción)
 * - Inicialización con configuración directa (desarrollo)
 * - Operaciones con Assets
 * - Operaciones con Data Extensions
 * - Operaciones con Journeys
 * - Envío de emails transaccionales
 * - Manejo de errores estandarizado
 */

// ============================================================================
// CARGA DE OMEGAFRAMEWORK (SOLO ESTO - no cargar dependencias manualmente)
// ============================================================================
Platform.Function.ContentBlockByKey("OMG_FW_OmegaFramework");

// ============================================================================
// CONFIGURACIÓN
// ============================================================================

// OPCIÓN 1: Usar CredentialStore (RECOMENDADO PARA PRODUCCIÓN)
var USE_CREDENTIAL_STORE = false; // Cambiar a true para usar CredentialStore
var CREDENTIAL_NAME = 'SFMC_Production'; // Nombre en OMG_FW_Credentials DE

// OPCIÓN 2: Configuración directa (DESARROLLO/TESTING)
var DIRECT_CONFIG = {
    clientId: 'tu-client-id-aqui',
    clientSecret: 'tu-client-secret-aqui',
    authBaseUrl: 'https://TU_SUBDOMAIN.auth.marketingcloudapis.com/'
};

// Configuración de ejemplos
var EXAMPLE_CONFIG = {
    // Cambiar por tus Data Extensions
    testDataExtension: 'MiDE_Test',

    // Cambiar por un Journey ID real para pruebas
    testJourneyId: 'journey-id-ejemplo',

    // Cambiar por una definición de email transaccional
    testEmailKey: 'welcome-email-key'
};

// ============================================================================
// UTILIDADES
// ============================================================================

function printSection(title) {
    Write('<div class="section">');
    Write('<h2>' + title + '</h2>');
}

function printSuccess(message) {
    Write('<div class="success">✓ ' + message + '</div>');
}

function printError(message) {
    Write('<div class="error">✗ ' + message + '</div>');
}

function printCode(code) {
    Write('<div class="code">' + code + '</div>');
}

function printResult(result) {
    if (result.success) {
        printSuccess('Operación exitosa');
        Write('<pre>' + Stringify(result.data, null, 2) + '</pre>');
    } else {
        printError('Error [' + result.error.code + ']: ' + result.error.message);
        if (result.error.details) {
            Write('<pre>' + Stringify(result.error.details, null, 2) + '</pre>');
        }
    }
}

// ============================================================================
// EJECUCIÓN PRINCIPAL
// ============================================================================

Write('<div class="container">');
Write('<h1>OmegaFramework - Ejemplo SFMCIntegration</h1>');

try {
    // ------------------------------------------------------------------------
    // 1. INICIALIZACIÓN
    // ------------------------------------------------------------------------

    printSection('1. Inicialización de SFMCIntegration');

    var sfmc;

    if (USE_CREDENTIAL_STORE) {
        printCode('var sfmc = OmegaFramework.create(\'SFMCIntegration\', { integrationName: \'' + CREDENTIAL_NAME + '\' });');

        sfmc = OmegaFramework.create('SFMCIntegration', {
            integrationName: CREDENTIAL_NAME
        });

        printSuccess('Integración inicializada usando CredentialStore');

    } else {
        printCode('var sfmc = OmegaFramework.create(\'SFMCIntegration\', { clientId: \'...\', clientSecret: \'...\', authBaseUrl: \'...\' });');

        sfmc = OmegaFramework.create('SFMCIntegration', DIRECT_CONFIG);

        printSuccess('Integración inicializada con configuración directa');
    }

    Write('</div>');

    // ------------------------------------------------------------------------
    // 2. AUTENTICACIÓN Y TOKEN
    // ------------------------------------------------------------------------

    printSection('2. Autenticación y Gestión de Token');

    printCode('var tokenResult = sfmc.getToken();');

    var tokenResult = sfmc.getToken();

    if (tokenResult.success) {
        printSuccess('Token obtenido correctamente');
        Write('<p><strong>Access Token:</strong> ' + tokenResult.data.access_token.substring(0, 20) + '...</p>');
        Write('<p><strong>Token Type:</strong> ' + tokenResult.data.token_type + '</p>');
        Write('<p><strong>Expires In:</strong> ' + tokenResult.data.expires_in + ' segundos</p>');
        Write('<p><strong>REST Instance URL:</strong> ' + tokenResult.data.rest_instance_url + '</p>');
    } else {
        printError('Error obteniendo token: ' + tokenResult.error.message);
        Write('</div></div></body></html>');
        return;
    }

    Write('</div>');

    // ------------------------------------------------------------------------
    // 3. OPERACIONES CON ASSETS
    // ------------------------------------------------------------------------

    printSection('3. Operaciones con Assets (Content Builder)');

    // 3.1. Listar Assets
    Write('<h3>3.1. Listar Assets</h3>');
    printCode('var listResult = sfmc.listAssets({ pageSize: 10 });');

    var listResult = sfmc.listAssets({ pageSize: 10 });

    if (listResult.success) {
        printSuccess('Assets recuperados: ' + listResult.data.count);

        if (listResult.data.items && listResult.data.items.length > 0) {
            Write('<table>');
            Write('<tr><th>ID</th><th>Name</th><th>Type</th><th>Status</th></tr>');

            for (var i = 0; i < Math.min(5, listResult.data.items.length); i++) {
                var asset = listResult.data.items[i];
                Write('<tr>');
                Write('<td>' + asset.id + '</td>');
                Write('<td>' + asset.name + '</td>');
                Write('<td>' + (asset.assetType ? asset.assetType.name : 'N/A') + '</td>');
                Write('<td>' + (asset.status ? asset.status.name : 'N/A') + '</td>');
                Write('</tr>');
            }

            Write('</table>');
        }
    } else {
        printError('Error listando assets: ' + listResult.error.message);
    }

    // 3.2. Búsqueda avanzada de Assets
    Write('<h3>3.2. Búsqueda Avanzada de Assets</h3>');
    printCode('var searchResult = sfmc.advancedAssetQuery({ query: { property: \'assetType.id\', simpleOperator: \'equals\', value: 208 }});');

    var searchResult = sfmc.advancedAssetQuery({
        query: {
            property: 'assetType.id',
            simpleOperator: 'equals',
            value: 208  // 208 = HTML Email
        },
        page: { page: 1, pageSize: 5 }
    });

    if (searchResult.success) {
        printSuccess('Búsqueda completada: ' + searchResult.data.count + ' emails HTML encontrados');
    } else {
        printError('Error en búsqueda: ' + searchResult.error.message);
    }

    Write('</div>');

    // ------------------------------------------------------------------------
    // 4. OPERACIONES CON DATA EXTENSIONS (via REST API)
    // ------------------------------------------------------------------------

    printSection('4. Operaciones con Data Extensions (REST API)');

    // 4.1. Query Data Extension
    Write('<h3>4.1. Query Data Extension</h3>');
    printCode('var queryResult = sfmc.queryDataExtension(\'' + EXAMPLE_CONFIG.testDataExtension + '\');');

    var queryResult = sfmc.queryDataExtension(EXAMPLE_CONFIG.testDataExtension);

    if (queryResult.success) {
        printSuccess('Query ejecutado correctamente');
        Write('<p>Total de filas: ' + queryResult.data.items.length + '</p>');

        if (queryResult.data.items.length > 0) {
            Write('<p><strong>Ejemplo de fila:</strong></p>');
            Write('<pre>' + Stringify(queryResult.data.items[0], null, 2) + '</pre>');
        }
    } else {
        printError('Error en query: ' + queryResult.error.message);
        Write('<p><em>Nota: Asegúrate de que la Data Extension \'' + EXAMPLE_CONFIG.testDataExtension + '\' existe</em></p>');
    }

    // 4.2. Insert Row
    Write('<h3>4.2. Insert Row en Data Extension</h3>');

    var rowData = {
        Email: 'test@ejemplo.com',
        Nombre: 'Usuario Test',
        FechaRegistro: new Date().toISOString()
    };

    printCode('var insertResult = sfmc.insertDataExtensionRow(\'' + EXAMPLE_CONFIG.testDataExtension + '\', ' + Stringify(rowData) + ');');

    Write('<p><em>Nota: Este es un ejemplo de código. No se ejecuta para evitar insertar datos de prueba.</em></p>');
    Write('<p>Para ejecutar, descomenta el código en el ejemplo.</p>');

    // Descomentar para ejecutar realmente:
    // var insertResult = sfmc.insertDataExtensionRow(EXAMPLE_CONFIG.testDataExtension, rowData);
    // printResult(insertResult);

    Write('</div>');

    // ------------------------------------------------------------------------
    // 5. OPERACIONES CON JOURNEYS
    // ------------------------------------------------------------------------

    printSection('5. Operaciones con Journeys');

    Write('<h3>5.1. Obtener Journey</h3>');
    printCode('var journeyResult = sfmc.getJourney(\'' + EXAMPLE_CONFIG.testJourneyId + '\');');

    var journeyResult = sfmc.getJourney(EXAMPLE_CONFIG.testJourneyId);

    if (journeyResult.success) {
        printSuccess('Journey recuperado');
        Write('<p><strong>ID:</strong> ' + journeyResult.data.id + '</p>');
        Write('<p><strong>Name:</strong> ' + journeyResult.data.name + '</p>');
        Write('<p><strong>Status:</strong> ' + journeyResult.data.status + '</p>');
    } else {
        printError('Error obteniendo journey: ' + journeyResult.error.message);
        Write('<p><em>Nota: Asegúrate de usar un Journey ID válido en EXAMPLE_CONFIG.testJourneyId</em></p>');
    }

    Write('</div>');

    // ------------------------------------------------------------------------
    // 6. EMAIL TRANSACCIONAL
    // ------------------------------------------------------------------------

    printSection('6. Envío de Email Transaccional');

    var emailPayload = {
        To: {
            Address: 'destinatario@ejemplo.com',
            SubscriberKey: 'subscriber-123',
            ContactAttributes: {
                SubscriberAttributes: {
                    FirstName: 'Juan',
                    LastName: 'Pérez'
                }
            }
        }
    };

    printCode('var emailResult = sfmc.sendTransactionalEmail(\'' + EXAMPLE_CONFIG.testEmailKey + '\', emailPayload);');

    Write('<p><em>Nota: Este es un ejemplo de código. No se ejecuta para evitar enviar emails de prueba.</em></p>');
    Write('<p>Para ejecutar, descomenta el código y configura un email transaccional válido.</p>');

    // Descomentar para ejecutar realmente:
    // var emailResult = sfmc.sendTransactionalEmail(EXAMPLE_CONFIG.testEmailKey, emailPayload);
    // printResult(emailResult);

    Write('</div>');

    // ------------------------------------------------------------------------
    // 7. MANEJO DE ERRORES
    // ------------------------------------------------------------------------

    printSection('7. Ejemplo de Manejo de Errores');

    Write('<p>Todos los métodos de SFMCIntegration devuelven un ResponseWrapper estándar:</p>');

    Write('<pre>');
    Write('{
    success: true/false,
    data: { ... },           // null si error
    error: {                 // null si success
        code: \'ERROR\' | \'VALIDATION_ERROR\' | \'AUTH_ERROR\' | \'HTTP_ERROR\',
        message: \'Descripción del error\',
        details: { ... }
    },
    meta: {
        datetime: timestamp,
        handler: \'SFMCIntegration\',
        operation: \'nombreMetodo\'
    }
}');
    Write('</pre>');

    Write('<p><strong>Ejemplo de manejo de errores:</strong></p>');

    printCode('var result = sfmc.listAssets({ pageSize: 50 });\n\nif (result.success) {\n    var assets = result.data.items;\n    // Procesar assets...\n} else {\n    Write(\'Error [\' + result.error.code + \']: \' + result.error.message);\n    \n    if (result.error.code === \'AUTH_ERROR\') {\n        // Manejar error de autenticación\n    } else if (result.error.code === \'HTTP_ERROR\') {\n        // Manejar error HTTP\n        Write(\'Status Code: \' + result.error.details.statusCode);\n    }\n}');

    Write('</div>');

    // ------------------------------------------------------------------------
    // RESUMEN FINAL
    // ------------------------------------------------------------------------

    printSection('Resumen de Capacidades de SFMCIntegration');

    Write('<h3>Métodos Disponibles</h3>');
    Write('<ul>');
    Write('<li><strong>getToken()</strong> - Obtener/refrescar token OAuth2</li>');
    Write('<li><strong>listAssets(options)</strong> - Listar assets de Content Builder</li>');
    Write('<li><strong>getAsset(assetId)</strong> - Obtener asset por ID</li>');
    Write('<li><strong>createAsset(assetData)</strong> - Crear nuevo asset</li>');
    Write('<li><strong>updateAsset(assetId, assetData)</strong> - Actualizar asset</li>');
    Write('<li><strong>deleteAsset(assetId)</strong> - Eliminar asset</li>');
    Write('<li><strong>advancedAssetQuery(queryOptions)</strong> - Búsqueda avanzada de assets</li>');
    Write('<li><strong>queryDataExtension(deKey)</strong> - Query DE via REST API</li>');
    Write('<li><strong>insertDataExtensionRow(deKey, rowData)</strong> - Insertar fila en DE</li>');
    Write('<li><strong>updateDataExtensionRow(deKey, rowData)</strong> - Actualizar fila en DE</li>');
    Write('<li><strong>deleteDataExtensionRow(deKey, primaryKeys)</strong> - Eliminar fila de DE</li>');
    Write('<li><strong>getJourney(journeyId)</strong> - Obtener journey por ID</li>');
    Write('<li><strong>publishJourney(journeyId)</strong> - Publicar journey</li>');
    Write('<li><strong>stopJourney(journeyId)</strong> - Detener journey</li>');
    Write('<li><strong>sendTransactionalEmail(emailKey, payload)</strong> - Enviar email transaccional</li>');
    Write('</ul>');

    Write('</div>');

} catch (ex) {
    printError('Error en ejecución: ' + (ex.message || String(ex)));
    Write('<pre>' + String(ex) + '</pre>');
}

Write('</div>');
</script>
</body>
</html>
