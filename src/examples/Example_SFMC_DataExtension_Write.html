<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmegaFramework - Example: Write to Data Extension</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #27ae60;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚úçÔ∏è OmegaFramework - Write to Data Extension Example</h1>
        <p><strong>Purpose:</strong> This example demonstrates how to insert, update, and upsert data in a Salesforce Marketing Cloud Data Extension using only 3 Content Block imports.</p>

        <div class="info">
            <strong>üì¶ Required Content Blocks:</strong>
            <ul>
                <li><code>OMG_FW_ResponseWrapper</code> - Standardized response handling</li>
                <li><code>OMG_FW_SFMCIntegration</code> - SFMC authentication and API access</li>
                <li><code>OMG_FW_DataExtensionHandler</code> - Data Extension operations</li>
            </ul>
            <strong>üìã Prerequisites:</strong>
            <ul>
                <li>Data Extension: <code>OMG_FW_Credentials</code> with your SFMC API credentials</li>
                <li>Target Data Extension (example uses <code>Customers_DE</code>)</li>
            </ul>
        </div>

<script runat="server">
    Platform.Load("core", "1.1.1");

    try {
        Write('<h2>üìù Step 1: Load Framework Components</h2>');

        // Load only 3 Content Blocks - no duplicate dependencies!
        Platform.Function.ContentBlockByName("OMG_FW_ResponseWrapper");
        Platform.Function.ContentBlockByName("OMG_FW_SFMCIntegration");
        Platform.Function.ContentBlockByName("OMG_FW_DataExtensionHandler");

        Write('<div class="success">‚úÖ All framework components loaded successfully</div>');

        // ============================================================================
        // Step 2: Configure SFMC Integration
        // ============================================================================
        Write('<h2>üîê Step 2: Configure SFMC Authentication</h2>');

        /**
         * MOCK DATA - Replace with your actual SFMC credentials
         * In production, these should come from CredentialStore or secure storage
         */
        var sfmcConfig = {
            clientId: 'your-client-id-here',
            clientSecret: 'your-client-secret-here',
            authBaseUrl: 'https://YOUR_SUBDOMAIN.auth.marketingcloudapis.com/',
            accountId: '123456'
        };

        Write('<div class="info">');
        Write('<strong>Configuration:</strong><br>');
        Write('Auth URL: ' + sfmcConfig.authBaseUrl + '<br>');
        Write('Client ID: ' + sfmcConfig.clientId.substring(0, 8) + '...');
        Write('</div>');

        var sfmc = new SFMCIntegration(sfmcConfig);
        var deHandler = new DataExtensionHandler(sfmc);

        Write('<div class="success">‚úÖ SFMC Integration and DataExtensionHandler initialized</div>');

        // ============================================================================
        // Step 3: Insert New Row
        // ============================================================================
        Write('<h2>‚ûï Step 3: Insert New Row</h2>');

        /**
         * MOCK DATA - Replace with your actual Data Extension key and structure
         * Ensure the fields match your Data Extension schema
         */
        var dataExtensionKey = 'Customers_DE';

        var newCustomer = {
            CustomerID: 'C001',
            FirstName: 'Juan',
            LastName: 'P√©rez',
            Email: 'juan.perez@example.com',
            Status: 'Active',
            CreatedDate: new Date().toISOString()
        };

        Write('<div class="info">');
        Write('<strong>Inserting row into:</strong> <code>' + dataExtensionKey + '</code><br>');
        Write('<strong>Data:</strong>');
        Write('<pre>' + Stringify(newCustomer, null, 2) + '</pre>');
        Write('</div>');

        var insertResult = deHandler.insertRow(dataExtensionKey, newCustomer);

        if (insertResult.success) {
            Write('<div class="success">');
            Write('<strong>‚úÖ Insert Successful</strong><br>');
            Write('Row inserted: ' + Stringify(insertResult.data));
            Write('</div>');
        } else {
            Write('<div class="error">');
            Write('<strong>‚ùå Insert Failed</strong><br>');
            Write('Error Code: ' + insertResult.error.code + '<br>');
            Write('Message: ' + insertResult.error.message + '<br>');
            Write('Details: ' + Stringify(insertResult.error.details));
            Write('</div>');
        }

        // ============================================================================
        // Step 4: Update Existing Row
        // ============================================================================
        Write('<h2>üîÑ Step 4: Update Existing Row</h2>');

        /**
         * MOCK DATA - Update requires the primary key field(s)
         * In this example, CustomerID is the primary key
         */
        var updateCustomer = {
            CustomerID: 'C001',  // Primary key - identifies which row to update
            Status: 'Premium',
            Email: 'juan.perez.updated@example.com'
        };

        Write('<div class="info">');
        Write('<strong>Updating row in:</strong> <code>' + dataExtensionKey + '</code><br>');
        Write('<strong>Update data:</strong>');
        Write('<pre>' + Stringify(updateCustomer, null, 2) + '</pre>');
        Write('</div>');

        var updateResult = deHandler.updateRow(dataExtensionKey, updateCustomer);

        if (updateResult.success) {
            Write('<div class="success">');
            Write('<strong>‚úÖ Update Successful</strong><br>');
            Write('Row updated: ' + Stringify(updateResult.data));
            Write('</div>');
        } else {
            Write('<div class="error">');
            Write('<strong>‚ùå Update Failed</strong><br>');
            Write('Error Code: ' + updateResult.error.code + '<br>');
            Write('Message: ' + updateResult.error.message);
            Write('</div>');
        }

        // ============================================================================
        // Step 5: Upsert Row (Insert or Update)
        // ============================================================================
        Write('<h2>üîÄ Step 5: Upsert Row (Insert or Update)</h2>');

        Write('<div class="info">');
        Write('<strong>What is Upsert?</strong> Upsert attempts to update first. If the row doesn\'t exist, it inserts a new one.');
        Write('</div>');

        /**
         * MOCK DATA - Upsert example
         * Will update if CustomerID exists, insert if it doesn't
         */
        var upsertCustomer = {
            CustomerID: 'C002',
            FirstName: 'Mar√≠a',
            LastName: 'Garc√≠a',
            Email: 'maria.garcia@example.com',
            Status: 'Active',
            CreatedDate: new Date().toISOString()
        };

        Write('<div class="info">');
        Write('<strong>Upserting row into:</strong> <code>' + dataExtensionKey + '</code><br>');
        Write('<strong>Data:</strong>');
        Write('<pre>' + Stringify(upsertCustomer, null, 2) + '</pre>');
        Write('</div>');

        var upsertResult = deHandler.upsertRow(dataExtensionKey, upsertCustomer);

        if (upsertResult.success) {
            Write('<div class="success">');
            Write('<strong>‚úÖ Upsert Successful</strong><br>');
            Write('Result: ' + Stringify(upsertResult.data));
            Write('</div>');
        } else {
            Write('<div class="error">');
            Write('<strong>‚ùå Upsert Failed</strong><br>');
            Write('Error: ' + upsertResult.error.message);
            Write('</div>');
        }

        // ============================================================================
        // Step 6: Delete Row
        // ============================================================================
        Write('<h2>üóëÔ∏è Step 6: Delete Row</h2>');

        Write('<div class="warning">');
        Write('<strong>‚ö†Ô∏è Warning:</strong> This operation permanently deletes data!');
        Write('</div>');

        /**
         * MOCK DATA - Delete requires primary key values
         */
        var primaryKeyValues = {
            CustomerID: 'C002'
        };

        Write('<div class="info">');
        Write('<strong>Deleting row from:</strong> <code>' + dataExtensionKey + '</code><br>');
        Write('<strong>Primary key values:</strong>');
        Write('<pre>' + Stringify(primaryKeyValues, null, 2) + '</pre>');
        Write('</div>');

        var deleteResult = deHandler.deleteRow(dataExtensionKey, primaryKeyValues);

        if (deleteResult.success) {
            Write('<div class="success">');
            Write('<strong>‚úÖ Delete Successful</strong><br>');
            Write('Result: ' + Stringify(deleteResult.data));
            Write('</div>');
        } else {
            Write('<div class="error">');
            Write('<strong>‚ùå Delete Failed</strong><br>');
            Write('Error: ' + deleteResult.error.message);
            Write('</div>');
        }

        // ============================================================================
        // Step 7: Batch Insert (Multiple Rows)
        // ============================================================================
        Write('<h2>üì¶ Step 7: Batch Insert Multiple Rows</h2>');

        /**
         * MOCK DATA - Insert multiple customers
         */
        var customers = [
            {
                CustomerID: 'C003',
                FirstName: 'Carlos',
                LastName: 'Rodr√≠guez',
                Email: 'carlos.rodriguez@example.com',
                Status: 'Active',
                CreatedDate: new Date().toISOString()
            },
            {
                CustomerID: 'C004',
                FirstName: 'Ana',
                LastName: 'Mart√≠nez',
                Email: 'ana.martinez@example.com',
                Status: 'Active',
                CreatedDate: new Date().toISOString()
            },
            {
                CustomerID: 'C005',
                FirstName: 'Luis',
                LastName: 'Gonz√°lez',
                Email: 'luis.gonzalez@example.com',
                Status: 'Trial',
                CreatedDate: new Date().toISOString()
            }
        ];

        Write('<div class="info">');
        Write('<strong>Inserting ' + customers.length + ' rows...</strong>');
        Write('</div>');

        var batchResults = {
            success: 0,
            failed: 0,
            errors: []
        };

        for (var i = 0; i < customers.length; i++) {
            var result = deHandler.insertRow(dataExtensionKey, customers[i]);
            if (result.success) {
                batchResults.success++;
            } else {
                batchResults.failed++;
                batchResults.errors.push({
                    customer: customers[i].CustomerID,
                    error: result.error.message
                });
            }
        }

        Write('<div class="' + (batchResults.failed === 0 ? 'success' : 'warning') + '">');
        Write('<strong>Batch Insert Results:</strong><br>');
        Write('‚úÖ Successful: ' + batchResults.success + '<br>');
        Write('‚ùå Failed: ' + batchResults.failed);
        if (batchResults.errors.length > 0) {
            Write('<br><strong>Errors:</strong>');
            Write('<pre>' + Stringify(batchResults.errors, null, 2) + '</pre>');
        }
        Write('</div>');

        // ============================================================================
        // Step 8: Error Handling Best Practices
        // ============================================================================
        Write('<h2>üõ°Ô∏è Step 8: Error Handling Best Practices</h2>');

        Write('<div class="info">');
        Write('<strong>Always check the response.success property:</strong>');
        Write('<pre>');
        Write('var result = deHandler.insertRow(deKey, rowData);\n\n');
        Write('if (result.success) {\n');
        Write('    // Handle success\n');
        Write('    var insertedData = result.data;\n');
        Write('    Write("Success: " + Stringify(insertedData));\n');
        Write('} else {\n');
        Write('    // Handle error\n');
        Write('    Write("Error Code: " + result.error.code);\n');
        Write('    Write("Message: " + result.error.message);\n');
        Write('    Write("Details: " + Stringify(result.error.details));\n');
        Write('}\n');
        Write('</pre>');
        Write('</div>');

        // ============================================================================
        // Summary
        // ============================================================================
        Write('<h2>‚ú® Summary</h2>');
        Write('<div class="success">');
        Write('<strong>Operations Demonstrated:</strong>');
        Write('<ul>');
        Write('<li>‚úÖ Insert new row with <code>insertRow()</code></li>');
        Write('<li>‚úÖ Update existing row with <code>updateRow()</code></li>');
        Write('<li>‚úÖ Upsert (insert or update) with <code>upsertRow()</code></li>');
        Write('<li>‚úÖ Delete row with <code>deleteRow()</code></li>');
        Write('<li>‚úÖ Batch insert multiple rows</li>');
        Write('<li>‚úÖ Proper error handling with ResponseWrapper</li>');
        Write('</ul>');
        Write('<strong>Key Benefits:</strong>');
        Write('<ul>');
        Write('<li>‚úÖ Only 3 Content Block imports required</li>');
        Write('<li>‚úÖ No duplicate dependencies</li>');
        Write('<li>‚úÖ Dual-strategy: SSJS first, REST API fallback</li>');
        Write('<li>‚úÖ Standardized responses for consistent error handling</li>');
        Write('</ul>');
        Write('</div>');

    } catch (ex) {
        Write('<div class="error">');
        Write('<strong>‚ùå Critical Error:</strong><br>');
        Write(Stringify(ex));
        Write('</div>');
    }
</script>

    </div>
</body>
</html>
