<script runat="server">
  Platform.Load("Core","1.1.1");
  try{
  </script>
  %%[
  VAR @submitted, @name, @authType, @platform, @description, @isActive
  VAR @clientId, @clientSecret, @username, @password, @staticToken, @apiKey, @apiSecret
  VAR @authUrl, @tokenEndpoint, @grantType, @scope, @baseUrl, @domain, @mid
  VAR @clientIdEnc, @clientSecretEnc, @usernameEnc, @passwordEnc, @staticTokenEnc, @apiKeyEnc, @apiSecretEnc
  VAR @passwordExtKey, @saltExtKey, @initVectorExtKey
  VAR @createdBy

  SET @passwordExtKey = "Sym_Cred"
  SET @saltExtKey = "Salt_Cred"
  SET @initVectorExtKey = "IV_Cred"

  IF RequestParameter("submitted") == "true" THEN
    SET @name = RequestParameter("name")
    SET @authType = RequestParameter("authType")
    SET @platform = RequestParameter("platform")
    SET @description = RequestParameter("description")
    SET @isActive = IIF(RequestParameter("isActive") == "true", "true", "false")

    /* OAuth2 Fields */
    SET @clientId = RequestParameter("clientId")
    SET @clientSecret = RequestParameter("clientSecret")
    SET @authUrl = RequestParameter("authUrl")
    SET @tokenEndpoint = RequestParameter("tokenEndpoint")
    SET @grantType = RequestParameter("grantType")
    SET @scope = RequestParameter("scope")

    /* Basic Auth Fields */
    SET @username = RequestParameter("username")
    SET @password = RequestParameter("password")

    /* Bearer Token */
    SET @staticToken = RequestParameter("staticToken")

    /* ApiKey */
    SET @apiKey = RequestParameter("apiKey")
    SET @apiSecret = RequestParameter("apiSecret")

    /* Common Fields */
    SET @baseUrl = RequestParameter("baseUrl")
    SET @domain = RequestParameter("domain")

    /* SFMC-Specific Fields */
    SET @mid = RequestParameter("mid")

    /* Encrypt sensitive fields */
    SET @clientIdEnc = IIF(NOT EMPTY(@clientId), EncryptSymmetric(@clientId, "aes", @passwordExtKey, null, @saltExtKey, null, @initVectorExtKey, null), "")
    SET @clientSecretEnc = IIF(NOT EMPTY(@clientSecret), EncryptSymmetric(@clientSecret, "aes", @passwordExtKey, null, @saltExtKey, null, @initVectorExtKey, null), "")
    SET @usernameEnc = IIF(NOT EMPTY(@username), EncryptSymmetric(@username, "aes", @passwordExtKey, null, @saltExtKey, null, @initVectorExtKey, null), "")
    SET @passwordEnc = IIF(NOT EMPTY(@password), EncryptSymmetric(@password, "aes", @passwordExtKey, null, @saltExtKey, null, @initVectorExtKey, null), "")
    SET @staticTokenEnc = IIF(NOT EMPTY(@staticToken), EncryptSymmetric(@staticToken, "aes", @passwordExtKey, null, @saltExtKey, null, @initVectorExtKey, null), "")
    SET @apiKeyEnc = IIF(NOT EMPTY(@apiKey), EncryptSymmetric(@apiKey, "aes", @passwordExtKey, null, @saltExtKey, null, @initVectorExtKey, null), "")
    SET @apiSecretEnc = IIF(NOT EMPTY(@apiSecret), EncryptSymmetric(@apiSecret, "aes", @passwordExtKey, null, @saltExtKey, null, @initVectorExtKey, null), "")

    /* Set defaults */
    IF EMPTY(@grantType) THEN
      SET @grantType = "client_credentials"
    ENDIF

    SET @createdBy = "CloudPage"

    /* Insert into OMG_FW_Credentials */
    InsertData("OMG_FW_Credentials",
      "Name", @name,
      "Description", @description,
      "AuthType", @authType,
      "Platform", @platform,
      "IsActive", @isActive,
      "ClientId", @clientIdEnc,
      "ClientSecret", @clientSecretEnc,
      "Username", @usernameEnc,
      "Password", @passwordEnc,
      "StaticToken", @staticTokenEnc,
      "ApiKey", @apiKeyEnc,
      "ApiSecret", @apiSecretEnc,
      "AuthUrl", @authUrl,
      "TokenEndpoint", @tokenEndpoint,
      "GrantType", @grantType,
      "Scope", @scope,
      "BaseUrl", @baseUrl,
      "Domain", @domain,
      "MID", @mid,
      "CreatedAt", Now(),
      "UpdatedAt", Now(),
      "CreatedBy", @createdBy
    )

  ]%%
    <div class="success-message">
          <p><strong>Credentials saved successfully and encrypted!</strong></p>
          <p>Integration: <strong>%%=v(@name)=%%</strong></p>
          <p>Platform: <strong>%%=v(@platform)=%%</strong></p>
          <p>Auth Type: <strong>%%=v(@authType)=%%</strong></p>
      </div>
  %%[
  ENDIF
  ]%%


  <script runat="server">
  }catch(e){
  Write(Stringify(e));
  }
  </script>

  <!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>OmegaFramework - Encrypt Credentials</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 40px;
        background-color: #f5f5f5;
      }
      h1 {
        text-align: center;
        color: #333;
      }
      .subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 30px;
      }
      form {
        background: #fff;
        padding: 30px;
        border-radius: 8px;
        max-width: 700px;
        margin: auto;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      .form-section {
        margin-bottom: 25px;
        padding: 15px;
        background-color: #f9f9f9;
        border-left: 4px solid #00E47C;
        border-radius: 4px;
      }
      .form-section h3 {
        margin-top: 0;
        color: #333;
      }
      label {
        display: block;
        margin-top: 12px;
        font-weight: bold;
        color: #555;
      }
      input, select, textarea {
        width: 100%;
        padding: 10px;
        margin-top: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .checkbox-container {
        display: flex;
        align-items: center;
        margin-top: 15px;
      }
      .checkbox-container input[type="checkbox"] {
        width: auto;
        margin-right: 10px;
      }
      .hidden { display: none; }
      .success-message {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        padding: 15px;
        margin: 20px auto;
        border-radius: 5px;
        max-width: 700px;
        text-align: center;
      }
      input[type="submit"] {
        margin-top: 25px;
        background-color: #00E47C;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        width: 100%;
      }
      input[type="submit"]:hover {
        background-color: #00c969;
      }
      .help-text {
        font-size: 12px;
        color: #666;
        margin-top: 3px;
      }
      .encrypted-field {
        background-color: #fff3cd;
        border-left: 3px solid #ffc107;
      }
    </style>
  </head>
  <body>

  <h1>OmegaFramework - Encrypt Credentials</h1>
  <p class="subtitle">Securely store encrypted API credentials for integrations</p>

  <form action="%%=RequestParameter('PAGEURL')=%%" method="post">
      <input type="hidden" name="submitted" value="true" />

      <!-- Basic Information Section -->
      <div class="form-section">
        <h3>Basic Information</h3>

        <label for="name">Integration Name: *</label>
        <input type="text" id="name" name="name" required placeholder="e.g., MyAPIIntegration">
        <p class="help-text">Unique identifier for this integration (Primary Key)</p>

        <label for="platform">Platform: *</label>
        <select id="platform" name="platform" required>
          <option value="">-- Select Platform --</option>
          <option value="SFMC">Salesforce Marketing Cloud (SFMC)</option>
          <option value="DataCloud">Salesforce Data Cloud</option>
          <option value="VeevaCRM">Veeva CRM</option>
          <option value="VeevaVault">Veeva Vault</option>
          <option value="MDG">Master Data Governance (MDG)</option>
          <option value="Custom">Custom Platform</option>
        </select>

        <label for="authType">Authentication Type: *</label>
        <select id="authType" name="authType" required>
          <option value="">-- Select Auth Type --</option>
          <option value="OAuth2">OAuth2 (Client Credentials)</option>
          <option value="Basic">Basic Authentication</option>
          <option value="Bearer">Bearer Token (Static)</option>
          <option value="ApiKey">API Key</option>
        </select>

        <label for="description">Description:</label>
        <textarea id="description" name="description" rows="3" placeholder="Brief description of this integration"></textarea>

        <div class="checkbox-container">
          <input type="checkbox" id="isActive" name="isActive" value="true" checked>
          <label for="isActive" style="margin-top: 0;">Active</label>
        </div>
      </div>

      <!-- OAuth2 Fields -->
      <div id="oauth2Fields" class="form-section hidden">
        <h3>OAuth2 Configuration</h3>

        <label for="clientId">Client ID: * üîí</label>
        <input type="text" id="clientId" name="clientId" class="encrypted-field" placeholder="Enter Client ID">
        <p class="help-text">Will be encrypted using AES</p>

        <label for="clientSecret">Client Secret: * üîí</label>
        <input type="password" id="clientSecret" name="clientSecret" class="encrypted-field" placeholder="Enter Client Secret">
        <p class="help-text">Will be encrypted using AES</p>

        <label for="authUrl">Authorization URL:</label>
        <input type="text" id="authUrl" name="authUrl" placeholder="https://auth.example.com/oauth/authorize">

        <label for="grantType">Grant Type:</label>
        <select id="grantType" name="grantType">
          <option value="client_credentials" selected>client_credentials</option>
          <option value="password">password</option>
          <option value="authorization_code">authorization_code</option>
        </select>

        <label for="scope">Scope:</label>
        <input type="text" id="scope" name="scope" placeholder="e.g., read write admin">
      </div>

      <!-- Basic Auth Fields -->
      <div id="basicAuthFields" class="form-section hidden">
        <h3>Basic Authentication</h3>

        <label for="username">Username: * üîí</label>
        <input type="text" id="username" name="username" class="encrypted-field" placeholder="Enter username">
        <p class="help-text">Will be encrypted using AES</p>

        <label for="password">Password: * üîí</label>
        <input type="password" id="password" name="password" class="encrypted-field" placeholder="Enter password">
        <p class="help-text">Will be encrypted using AES</p>
      </div>

      <!-- Bearer Token Fields -->
      <div id="bearerFields" class="form-section hidden">
        <h3>Bearer Token</h3>

        <label for="staticToken">Static Token: * üîí</label>
        <textarea id="staticToken" name="staticToken" rows="4" class="encrypted-field" placeholder="Enter Bearer token (long-lived access token)"></textarea>
        <p class="help-text">Will be encrypted using AES</p>
      </div>

      <!-- API Key Fields -->
      <div id="apiKeyFields" class="form-section hidden">
        <h3>API Key Authentication</h3>

        <label for="apiKey">API Key: * üîí</label>
        <input type="text" id="apiKey" name="apiKey" class="encrypted-field" placeholder="Enter API Key">
        <p class="help-text">Will be encrypted using AES</p>

        <label for="apiSecret">API Secret: üîí</label>
        <input type="password" id="apiSecret" name="apiSecret" class="encrypted-field" placeholder="Enter API Secret (if required)">
        <p class="help-text">Optional - Will be encrypted using AES</p>
      </div>

      <!-- SFMC-Specific Fields -->
      <div id="sfmcFields" class="form-section hidden">
        <h3>SFMC Configuration</h3>

        <label for="mid">Business Unit MID (Optional):</label>
        <input type="text" id="mid" name="mid" placeholder="e.g., 12345678">
        <p class="help-text">Leave empty for parent Business Unit, or enter child BU MID for multi-BU access</p>
      </div>

      <!-- API Endpoints Section -->
      <div class="form-section" id="endpointsSection">
        <h3>API Endpoints</h3>

        <label for="tokenEndpoint" id="tokenEndpointLabel">Token/Auth Endpoint:</label>
        <input type="text" id="tokenEndpoint" name="tokenEndpoint" placeholder="https://auth.example.com/oauth/token">
        <p class="help-text" id="tokenEndpointHelp">OAuth2: token endpoint | Basic Auth: authentication endpoint</p>

        <label for="baseUrl" id="baseUrlLabel">Base URL: *</label>
        <input type="text" id="baseUrl" name="baseUrl" required placeholder="https://api.example.com">
        <p class="help-text" id="baseUrlHelp">Base URL for API requests</p>

        <div id="domainContainer">
          <label for="domain">Domain:</label>
          <input type="text" id="domain" name="domain" placeholder="example.com">
        </div>
      </div>

      <input type="submit" value="Save Encrypted Credentials">
  </form>

  <div style="max-width: 700px; margin: 30px auto; padding: 15px; background-color: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 4px;">
    <strong>üîê Security Information:</strong>
    <ul style="margin: 10px 0;">
      <li>All sensitive fields are encrypted using SFMC's AES symmetric encryption</li>
      <li>Encryption keys are stored securely in SFMC Platform Variables: <code>Sym_Cred</code>, <code>Salt_Cred</code>, <code>IV_Cred</code></li>
      <li>Credentials are stored in the <strong>OMG_FW_Credentials</strong> Data Extension</li>
      <li>Use <strong>CredentialStore</strong> class to retrieve and decrypt credentials in your code</li>
    </ul>
  </div>

  %%=Concat('<s','cript>')=%%
  /**
   * Generates a random password with mixed case, numbers, and punctuation
   * @param {number} len - Length of password to generate
   * @returns {string} Generated password
   */
  function createPassword(len) {
    var length = (len) ? (len) : (10);
    var string = "abcdefghijklmnopqrstuvwxyz";
    var numeric = '0123456789';
    var punctuation = '!#$^&%@*';
    var password = "";
    var character = "";
    while (password.length < length) {
      entity1 = Math.ceil(string.length * Math.random() * Math.random());
      entity2 = Math.ceil(numeric.length * Math.random() * Math.random());
      entity3 = Math.ceil(punctuation.length * Math.random() * Math.random());
      hold = string.charAt(entity1);
      hold = (password.length % 2 == 0) ? (hold.toUpperCase()) : (hold);
      character += hold;
      character += numeric.charAt(entity2);
      character += punctuation.charAt(entity3);
      password = character;
    }
    password = password.split('').sort(function() { return 0.5 - Math.random() }).join('');
    return password.substring(0, len);
  }

  /**
   * Generates random bytes using random.org API
   * @param {number} len - Number of bytes to generate
   * @param {string} format - Format (h=hex, f=base64, d=decimal)
   * @returns {string} Random bytes in specified format
   */
  function createRandomBytes(len, format) {
    var format = format || "h";
    try {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', "https://www.random.org/cgi-bin/randbyte?nbytes=" + len + "&format=" + format, false);
      xhr.send();
      if (xhr.status === 200) {
        return xhr.responseText.replace(" \n", "").replace(/^\s+|\s+$/g, '');
      } else {
        // Fallback to client-side generation if random.org fails
        var result = '';
        for (var i = 0; i < len * 2; i++) {
          result += Math.floor(Math.random() * 16).toString(16);
        }
        return result.substring(0, len * 2);
      }
    } catch (e) {
      // Fallback to client-side generation
      var result = '';
      for (var i = 0; i < len * 2; i++) {
        result += Math.floor(Math.random() * 16).toString(16);
      }
      return result.substring(0, len * 2);
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    var authTypeSelect = document.getElementById("authType");
    var platformSelect = document.getElementById("platform");
    var oauth2Fields = document.getElementById("oauth2Fields");
    var basicAuthFields = document.getElementById("basicAuthFields");
    var bearerFields = document.getElementById("bearerFields");
    var apiKeyFields = document.getElementById("apiKeyFields");
    var sfmcFields = document.getElementById("sfmcFields");
    var domainContainer = document.getElementById("domainContainer");
    var baseUrlInput = document.getElementById("baseUrl");
    var baseUrlHelp = document.getElementById("baseUrlHelp");
    var authUrlInput = document.getElementById("authUrl");
    var tokenEndpointInput = document.getElementById("tokenEndpoint");

    // Platform-specific presets configuration
    var PLATFORM_PRESETS = {
      'SFMC': {
        defaultAuthType: 'OAuth2',
        showMID: true,
        showDomain: false,
        authUrlPlaceholder: 'https://YOUR_SUBDOMAIN.auth.marketingcloudapis.com',
        tokenEndpointHint: 'Usually: Auth URL + /v2/token',
        baseUrlPlaceholder: 'Auto-discovered from token response (optional)',
        baseUrlRequired: false
      },
      'DataCloud': {
        defaultAuthType: 'OAuth2',
        showMID: false,
        showDomain: false,
        authUrlPlaceholder: 'https://login.salesforce.com',
        baseUrlPlaceholder: 'https://YOUR_INSTANCE.salesforce.com',
        baseUrlRequired: true
      },
      'VeevaCRM': {
        defaultAuthType: 'OAuth2',
        showMID: false,
        showDomain: true,
        authUrlPlaceholder: 'https://YOUR_DOMAIN.veevanetwork.com/auth/oauth/token',
        baseUrlPlaceholder: 'https://YOUR_DOMAIN.veevanetwork.com',
        baseUrlRequired: true
      },
      'VeevaVault': {
        defaultAuthType: 'Basic',
        showMID: false,
        showDomain: false,
        tokenEndpointPlaceholder: 'https://YOUR_VAULT.veevavault.com/api/v24.1/auth',
        baseUrlPlaceholder: 'https://YOUR_VAULT.veevavault.com',
        baseUrlRequired: true
      },
      'MDG': {
        defaultAuthType: 'OAuth2',
        showMID: false,
        showDomain: true,
        authUrlPlaceholder: 'Your MDG auth URL',
        baseUrlPlaceholder: 'Your MDG API base URL',
        baseUrlRequired: true
      },
      'Custom': {
        defaultAuthType: null,
        showMID: false,
        showDomain: true,
        authUrlPlaceholder: 'https://auth.example.com/oauth/authorize',
        baseUrlPlaceholder: 'https://api.example.com',
        baseUrlRequired: true
      }
    };

    // Handle platform change
    platformSelect.addEventListener("change", function () {
      var platform = this.value;
      var preset = PLATFORM_PRESETS[platform];

      if (!preset) {
        // Default behavior if platform not in presets
        sfmcFields.classList.add("hidden");
        domainContainer.classList.remove("hidden");
        return;
      }

      // Show/hide MID field (SFMC only)
      if (preset.showMID) {
        sfmcFields.classList.remove("hidden");
      } else {
        sfmcFields.classList.add("hidden");
        document.getElementById("mid").value = '';
      }

      // Show/hide Domain field
      if (preset.showDomain) {
        domainContainer.classList.remove("hidden");
      } else {
        domainContainer.classList.add("hidden");
      }

      // Update placeholders
      if (authUrlInput) {
        authUrlInput.placeholder = preset.authUrlPlaceholder || '';
      }
      if (tokenEndpointInput) {
        tokenEndpointInput.placeholder = preset.tokenEndpointPlaceholder || preset.authUrlPlaceholder || '';
      }
      if (baseUrlInput) {
        baseUrlInput.placeholder = preset.baseUrlPlaceholder || '';
        baseUrlInput.required = preset.baseUrlRequired;
      }

      // Auto-select default auth type if set
      if (preset.defaultAuthType && authTypeSelect.value === '') {
        authTypeSelect.value = preset.defaultAuthType;
        authTypeSelect.dispatchEvent(new Event('change'));
      }
    });

    // Handle auth type change
    authTypeSelect.addEventListener("change", function () {
      // Hide all auth-specific sections
      oauth2Fields.classList.add("hidden");
      basicAuthFields.classList.add("hidden");
      bearerFields.classList.add("hidden");
      apiKeyFields.classList.add("hidden");

      // Show relevant section based on selection
      if (this.value === "OAuth2") {
        oauth2Fields.classList.remove("hidden");
      } else if (this.value === "Basic") {
        basicAuthFields.classList.remove("hidden");
      } else if (this.value === "Bearer") {
        bearerFields.classList.remove("hidden");
      } else if (this.value === "ApiKey") {
        apiKeyFields.classList.remove("hidden");
      }
    });

    // Trigger platform change if pre-selected
    if (platformSelect.value) {
      platformSelect.dispatchEvent(new Event('change'));
    }
  });
  %%=Concat('</s','cript>')=%%

  </script>

  </body>
  </html>