<script runat="server">
    Platform.Load("core", "1.1.1");
    try{
    /**
     * AutomatedInstaller - Hybrid CloudPage for OmegaFramework Installation
     *
     * This page works in two modes:
     * 1. Without parameters: Shows HTML form for configuration
     * 2. With install=1: Executes SSJS backend to install Content Blocks
     *
     * @version 2.0.0
     * @author OmegaFramework
     */
    
    // Check if this is an installation request
    var isInstallRequest = Request.GetQueryStringParameter('install') === '1' ||
                           Request.GetFormField('install') === '1';
    var version = 2
    
    if (isInstallRequest) {
        // BACKEND MODE: Execute installation
    
        Write('<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8">');
        Write('<meta name="viewport" content="width=device-width, initial-scale=1.0">');
        Write('<title>OmegaFramework v2.0 - Installation Progress</title>');
        Write('<style>');
        Write('body { font-family: Arial, sans-serif; max-width: 1200px; margin: 50px auto; padding: 20px; background-color: #f5f5f5; }');
        Write('.container { background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }');
        Write('h1 { color: #0176d3; border-bottom: 3px solid #0176d3; padding-bottom: 10px; }');
        Write('.progress-item { padding: 10px; margin: 10px 0; border-radius: 4px; border-left: 4px solid #ccc; }');
        Write('.success { background-color: #d4edda; border-left-color: #28a745; color: #155724; }');
        Write('.error { background-color: #f8d7da; border-left-color: #dc3545; color: #721c24; }');
        Write('.info { background-color: #d1ecf1; border-left-color: #0c5460; color: #0c5460; }');
        Write('.summary { margin-top: 30px; padding: 20px; background-color: #f0f0f0; border-radius: 5px; }');
        Write('</style></head><body><div class="container">');
    
        Write('<h1>üöÄ OmegaFramework v2.0 - Installation Progress</h1>');
        Write('<hr>');
    
        try {
            // Get parameters from POST
            var clientId = Request.GetFormField('clientId');
            var clientSecret = Request.GetFormField('clientSecret');
            var authBaseUrl = Request.GetFormField('authBaseUrl');
            var githubRepo = Request.GetFormField('githubRepo');
    
            // Validate parameters
            if (!clientId || !clientSecret || !authBaseUrl || !githubRepo) {
                Write('<div class="progress-item error">');
                Write('<strong>‚ùå Error:</strong> Missing required parameters.<br>');
                Write('Please go back and fill in all required fields.');
                Write('</div>');
                Write('</div></body></html>');
            } else {
                Write('<div class="progress-item info">');
                Write('<strong>üìã Configuration:</strong><br>');
                Write('Auth Base URL: ' + authBaseUrl + '<br>');
                Write('GitHub Repository: ' + githubRepo + '<br>');
                Write('Client ID: ' + clientId.substring(0, 8) + '...');
                Write('</div>');
    
                // Step 1: Get OAuth2 token
                Write('<h2>Step 1: Obtaining Access Token</h2>');
    
                var tokenUrl = authBaseUrl;
                if (tokenUrl.charAt(tokenUrl.length - 1) !== '/') {
                    tokenUrl += '/';
                }
                tokenUrl += 'v2/token';
    
                var tokenPayload = {
                    grant_type: 'client_credentials',
                    client_id: clientId,
                    client_secret: clientSecret,
                    account_id: "518006929"
                };
    
                var tokenRequest = new Script.Util.HttpRequest(tokenUrl);
                tokenRequest.emptyContentHandling = 0;
                tokenRequest.retries = 2;
                tokenRequest.continueOnError = true;
                tokenRequest.contentType = 'application/json';
                tokenRequest.method = 'POST';
                tokenRequest.postData = Stringify(tokenPayload);
    
                var tokenResponse = tokenRequest.send();
                //Write(Stringify(tokenResponse.statusCode))
                if (tokenResponse.statusCode != 200) {
                    Write('<div class="progress-item error">');
                    Write('<strong>‚ùå Authentication Failed</strong><br>');
                    Write('Status Code: ' + tokenResponse.statusCode + '<br>');
                    Write('Response: ' + tokenResponse.content);
                    Write('</div>');
                    Write('</div></body></html>');
                } else {
                    var tokenData = Platform.Function.ParseJSON(String(tokenResponse.content));
                    var accessToken = tokenData.access_token;
                    var restInstanceUrl = tokenData.rest_instance_url;
    
                    Write('<div class="progress-item success">');
                    Write('<strong>‚úÖ Access Token Obtained</strong><br>');
                    Write('REST Instance: ' + restInstanceUrl);
                    Write('</div>');

                    // Step 2: Create folder structure (OPTIMIZED)
                    Write('<h2>Step 2: Creating Folder Structure</h2>');

                    var folderIds = {};
                    var rootFolderId = 0;

                    try {
                        // Step 2.1: Get root folder ID
                        Write('<div class="progress-item info">');
                        Write('<strong>üîç Finding root folder...</strong>');
                        Write('</div>');

                        var rootUrl = restInstanceUrl + '/asset/v1/content/categories?$filter=parentId eq 0&$pageSize=1';
                        var rootRequest = new Script.Util.HttpRequest(rootUrl);
                        rootRequest.emptyContentHandling = 0;
                        rootRequest.retries = 2;
                        rootRequest.continueOnError = true;
                        rootRequest.method = 'GET';
                        rootRequest.setHeader('Authorization', 'Bearer ' + accessToken);

                        var rootResponse = rootRequest.send();
                        if (rootResponse.statusCode == 200) {
                            var rootData = Platform.Function.ParseJSON(String(rootResponse.content));
                            if (rootData.items && rootData.items.length > 0) {
                                rootFolderId = rootData.items[0].id;
                                Write('<div class="progress-item success">');
                                Write('<strong>‚úÖ Root folder found</strong> (ID: ' + rootFolderId + ')');
                                Write('</div>');
                            }
                        }

                        if (rootFolderId == 0) {
                            throw new Error('Could not find root folder ID');
                        }

                        // Step 2.2: Get ALL existing folders (with pagination)
                        Write('<div class="progress-item info">');
                        Write('<strong>üîç Loading all existing folders...</strong>');
                        Write('</div>');

                        var allFolders = [];
                        var pageSize = 500;
                        var page = 1;
                        var hasMore = true;

                        while (hasMore) {
                            var allFoldersUrl = restInstanceUrl + '/asset/v1/content/categories?$pageSize=' + pageSize + '&$page=' + page;
                            var allFoldersRequest = new Script.Util.HttpRequest(allFoldersUrl);
                            allFoldersRequest.emptyContentHandling = 0;
                            allFoldersRequest.retries = 2;
                            allFoldersRequest.continueOnError = true;
                            allFoldersRequest.method = 'GET';
                            allFoldersRequest.setHeader('Authorization', 'Bearer ' + accessToken);

                            var allFoldersResponse = allFoldersRequest.send();
                            if (allFoldersResponse.statusCode == 200) {
                                var foldersData = Platform.Function.ParseJSON(String(allFoldersResponse.content));
                                if (foldersData.items && foldersData.items.length > 0) {
                                    for (var f = 0; f < foldersData.items.length; f++) {
                                        allFolders.push(foldersData.items[f]);
                                    }

                                    // Check if there are more pages
                                    if (foldersData.count > page * pageSize) {
                                        page++;
                                    } else {
                                        hasMore = false;
                                    }
                                } else {
                                    hasMore = false;
                                }
                            } else {
                                hasMore = false;
                            }
                        }

                        Write('<div class="progress-item success">');
                        Write('<strong>‚úÖ Loaded ' + allFolders.length + ' existing folders</strong>');
                        Write('</div>');

                        // Step 2.3: Create folder map by name and parentId
                        var folderMap = {};
                        for (var i = 0; i < allFolders.length; i++) {
                            var folder = allFolders[i];
                            var key = folder.name + '_' + folder.parentId;
                            folderMap[key] = folder.id;
                        }

                        // Step 2.4: Check and create OmegaFramework folder
                        var omegaKey = 'OmegaFramework_' + rootFolderId;
                        var omegaFolderId = folderMap[omegaKey];

                        if (omegaFolderId) {
                            Write('<div class="progress-item info">');
                            Write('<strong>‚ÑπÔ∏è OmegaFramework</strong> folder already exists (ID: ' + omegaFolderId + ')');
                            Write('</div>');
                        } else {
                            Write('<div class="progress-item info">');
                            Write('<strong>üìÅ Creating folder:</strong> OmegaFramework...');
                            Write('</div>');

                            var omegaPayload = {
                                name: 'OmegaFramework',
                                parentId: rootFolderId,
                                description: 'OmegaFramework v1.1 - Main folder'
                            };

                            var folderUrl = restInstanceUrl + '/asset/v1/content/categories';
                            var omegaRequest = new Script.Util.HttpRequest(folderUrl);
                            omegaRequest.emptyContentHandling = 0;
                            omegaRequest.retries = 2;
                            omegaRequest.continueOnError = true;
                            omegaRequest.contentType = 'application/json';
                            omegaRequest.method = 'POST';
                            omegaRequest.setHeader('Authorization', 'Bearer ' + accessToken);
                            omegaRequest.postData = Stringify(omegaPayload);

                            var omegaResponse = omegaRequest.send();
                            if (omegaResponse.statusCode == 200 || omegaResponse.statusCode == 201) {
                                var omegaData = Platform.Function.ParseJSON(String(omegaResponse.content));
                                omegaFolderId = omegaData.id;

                                Write('<div class="progress-item success">');
                                Write('<strong>‚úÖ OmegaFramework</strong> folder created (ID: ' + omegaFolderId + ')');
                                Write('</div>');
                            } else {
                                Write('<div class="progress-item error">');
                                Write('<strong>‚ùå Failed to create OmegaFramework folder</strong><br>');
                                Write('Status: ' + omegaResponse.statusCode);
                                Write('</div>');
                            }
                        }

                        folderIds['OmegaFramework'] = omegaFolderId;

                        // Step 2.5: Create subfolders (core, auth, integrations, handlers, tests)
                        if (omegaFolderId) {
                            var subfolders = [
                                { name: 'core', description: 'Core framework modules (ResponseWrapper, ConnectionHandler, TokenCache)' },
                                { name: 'auth', description: 'Authentication strategies (Basic, Bearer, OAuth2)' },
                                { name: 'integrations', description: 'External system integrations (SFMC, DataCloud, Veeva)' },
                                { name: 'handlers', description: 'SFMC operation handlers (Asset, Email, DataExtension, etc.)' },
                                { name: 'tests', description: 'Test suites for all modules' }
                            ];

                            for (var s = 0; s < subfolders.length; s++) {
                                var subfolder = subfolders[s];
                                var subfolderKey = subfolder.name + '_' + omegaFolderId;
                                var subfolderId = folderMap[subfolderKey];

                                if (subfolderId) {
                                    Write('<div class="progress-item info">');
                                    Write('<strong>‚ÑπÔ∏è ' + subfolder.name + '</strong> subfolder already exists (ID: ' + subfolderId + ')');
                                    Write('</div>');
                                } else {
                                    Write('<div class="progress-item info">');
                                    Write('<strong>üìÅ Creating subfolder:</strong> OmegaFramework/' + subfolder.name + '...');
                                    Write('</div>');

                                    var subfolderPayload = {
                                        name: subfolder.name,
                                        parentId: omegaFolderId,
                                        description: subfolder.description
                                    };

                                    var subfolderRequest = new Script.Util.HttpRequest(folderUrl);
                                    subfolderRequest.emptyContentHandling = 0;
                                    subfolderRequest.retries = 2;
                                    subfolderRequest.continueOnError = true;
                                    subfolderRequest.contentType = 'application/json';
                                    subfolderRequest.method = 'POST';
                                    subfolderRequest.setHeader('Authorization', 'Bearer ' + accessToken);
                                    subfolderRequest.postData = Stringify(subfolderPayload);

                                    var subfolderResponse = subfolderRequest.send();
                                    if (subfolderResponse.statusCode == 200 || subfolderResponse.statusCode == 201) {
                                        var subfolderData = Platform.Function.ParseJSON(String(subfolderResponse.content));
                                        subfolderId = subfolderData.id;

                                        Write('<div class="progress-item success">');
                                        Write('<strong>‚úÖ ' + subfolder.name + '</strong> subfolder created (ID: ' + subfolderId + ')');
                                        Write('</div>');
                                    } else {
                                        Write('<div class="progress-item error">');
                                        Write('<strong>‚ùå Failed to create ' + subfolder.name + ' folder</strong><br>');
                                        Write('Status: ' + subfolderResponse.statusCode);
                                        Write('</div>');
                                    }
                                }

                                folderIds['OmegaFramework/' + subfolder.name] = subfolderId;
                            }

                            // Step 2.6: Create test subfolders (core, auth, handlers, integrations)
                            var testsFolderId = folderIds['OmegaFramework/tests'];
                            if (testsFolderId) {
                                var testSubfolders = [
                                    { name: 'core', description: 'Core module tests' },
                                    { name: 'auth', description: 'Authentication strategy tests' },
                                    { name: 'handlers', description: 'Handler tests' },
                                    { name: 'integrations', description: 'Integration tests' }
                                ];

                                for (var t = 0; t < testSubfolders.length; t++) {
                                    var testSubfolder = testSubfolders[t];
                                    var testSubfolderKey = testSubfolder.name + '_' + testsFolderId;
                                    var testSubfolderId = folderMap[testSubfolderKey];

                                    if (testSubfolderId) {
                                        Write('<div class="progress-item info">');
                                        Write('<strong>‚ÑπÔ∏è tests/' + testSubfolder.name + '</strong> subfolder already exists (ID: ' + testSubfolderId + ')');
                                        Write('</div>');
                                    } else {
                                        Write('<div class="progress-item info">');
                                        Write('<strong>üìÅ Creating test subfolder:</strong> OmegaFramework/tests/' + testSubfolder.name + '...');
                                        Write('</div>');

                                        var testSubfolderPayload = {
                                            name: testSubfolder.name,
                                            parentId: testsFolderId,
                                            description: testSubfolder.description
                                        };

                                        var testSubfolderRequest = new Script.Util.HttpRequest(folderUrl);
                                        testSubfolderRequest.emptyContentHandling = 0;
                                        testSubfolderRequest.retries = 2;
                                        testSubfolderRequest.continueOnError = true;
                                        testSubfolderRequest.contentType = 'application/json';
                                        testSubfolderRequest.method = 'POST';
                                        testSubfolderRequest.setHeader('Authorization', 'Bearer ' + accessToken);
                                        testSubfolderRequest.postData = Stringify(testSubfolderPayload);

                                        var testSubfolderResponse = testSubfolderRequest.send();
                                        if (testSubfolderResponse.statusCode == 200 || testSubfolderResponse.statusCode == 201) {
                                            var testSubfolderData = Platform.Function.ParseJSON(String(testSubfolderResponse.content));
                                            testSubfolderId = testSubfolderData.id;

                                            Write('<div class="progress-item success">');
                                            Write('<strong>‚úÖ tests/' + testSubfolder.name + '</strong> subfolder created (ID: ' + testSubfolderId + ')');
                                            Write('</div>');
                                        } else {
                                            Write('<div class="progress-item error">');
                                            Write('<strong>‚ùå Failed to create tests/' + testSubfolder.name + ' folder</strong><br>');
                                            Write('Status: ' + testSubfolderResponse.statusCode);
                                            Write('</div>');
                                        }
                                    }

                                    folderIds['OmegaFramework/tests/' + testSubfolder.name] = testSubfolderId;
                                }
                            }
                        }

                        Write('<hr>');
                        Write('<div class="progress-item success">');
                        Write('<strong>üìÅ Folder structure ready:</strong><br>');
                        Write('- OmegaFramework (ID: ' + folderIds['OmegaFramework'] + ')<br>');
                        Write('&nbsp;&nbsp;‚îú‚îÄ‚îÄ core (ID: ' + folderIds['OmegaFramework/core'] + ')<br>');
                        Write('&nbsp;&nbsp;‚îú‚îÄ‚îÄ auth (ID: ' + folderIds['OmegaFramework/auth'] + ')<br>');
                        Write('&nbsp;&nbsp;‚îú‚îÄ‚îÄ integrations (ID: ' + folderIds['OmegaFramework/integrations'] + ')<br>');
                        Write('&nbsp;&nbsp;‚îú‚îÄ‚îÄ handlers (ID: ' + folderIds['OmegaFramework/handlers'] + ')<br>');
                        Write('&nbsp;&nbsp;‚îî‚îÄ‚îÄ tests (ID: ' + folderIds['OmegaFramework/tests'] + ')<br>');
                        Write('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îú‚îÄ‚îÄ core (ID: ' + folderIds['OmegaFramework/tests/core'] + ')<br>');
                        Write('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îú‚îÄ‚îÄ auth (ID: ' + folderIds['OmegaFramework/tests/auth'] + ')<br>');
                        Write('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îú‚îÄ‚îÄ handlers (ID: ' + folderIds['OmegaFramework/tests/handlers'] + ')<br>');
                        Write('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îî‚îÄ‚îÄ integrations (ID: ' + folderIds['OmegaFramework/tests/integrations'] + ')');
                        Write('</div>');
                        Write('<hr>');

                    } catch (folderEx) {
                        Write('<div class="progress-item error">');
                        Write('<strong>‚ùå Error creating folders:</strong> ' + (folderEx.message || folderEx.toString()));
                        Write('</div>');
                    }

                    // Step 3: Define files to install
                    Write('<h2>Step 3: Installing Content Blocks</h2>');

                    var files = [
                        // Core Framework Files (NEW ARCHITECTURE)
                        { key: 'OMG_FW_ResponseWrapper', path: 'core/ResponseWrapper.ssjs', category: 'OmegaFramework/core' },
                        { key: 'OMG_FW_ConnectionHandler', path: 'core/ConnectionHandler.ssjs', category: 'OmegaFramework/core' },
                        { key: 'OMG_FW_DataExtensionTokenCache', path: 'core/DataExtensionTokenCache.ssjs', category: 'OmegaFramework/core' },

                        // Auth Strategies (NEW ARCHITECTURE)
                        { key: 'OMG_FW_BasicAuthStrategy', path: 'auth/BasicAuthStrategy.ssjs', category: 'OmegaFramework/auth' },
                        { key: 'OMG_FW_BearerAuthStrategy', path: 'auth/BearerAuthStrategy.ssjs', category: 'OmegaFramework/auth' },
                        { key: 'OMG_FW_OAuth2AuthStrategy', path: 'auth/OAuth2AuthStrategy.ssjs', category: 'OmegaFramework/auth' },

                        // Integrations (NEW ARCHITECTURE)
                        { key: 'OMG_FW_BaseIntegration', path: 'integrations/BaseIntegration.ssjs', category: 'OmegaFramework/integrations' },
                        { key: 'OMG_FW_SFMCIntegration', path: 'integrations/SFMCIntegration.ssjs', category: 'OmegaFramework/integrations' },
                        { key: 'OMG_FW_DataCloudIntegration', path: 'integrations/DataCloudIntegration.ssjs', category: 'OmegaFramework/integrations' },
                        { key: 'OMG_FW_VeevaCRMIntegration', path: 'integrations/VeevaCRMIntegration.ssjs', category: 'OmegaFramework/integrations' },
                        { key: 'OMG_FW_VeevaVaultIntegration', path: 'integrations/VeevaVaultIntegration.ssjs', category: 'OmegaFramework/integrations' },

                        // Handlers (NEW ARCHITECTURE)
                        { key: 'OMG_FW_AssetHandler', path: 'handlers/AssetHandler.ssjs', category: 'OmegaFramework/handlers' },
                        { key: 'OMG_FW_DataExtensionHandler', path: 'handlers/DataExtensionHandler.ssjs', category: 'OmegaFramework/handlers' },
                        { key: 'OMG_FW_EmailHandler', path: 'handlers/EmailHandler.ssjs', category: 'OmegaFramework/handlers' },
                        { key: 'OMG_FW_FolderHandler', path: 'handlers/FolderHandler.ssjs', category: 'OmegaFramework/handlers' },
                        { key: 'OMG_FW_JourneyHandler', path: 'handlers/JourneyHandler.ssjs', category: 'OmegaFramework/handlers' },

                        // Tests - Core
                        { key: 'Test_ResponseWrapper', path: 'tests/core/Test_ResponseWrapper.ssjs', category: 'OmegaFramework/tests/core' },
                        { key: 'Test_ConnectionHandler', path: 'tests/core/Test_ConnectionHandler.ssjs', category: 'OmegaFramework/tests/core' },
                        { key: 'Test_DataExtensionTokenCache', path: 'tests/core/Test_DataExtensionTokenCache.ssjs', category: 'OmegaFramework/tests/core' },

                        // Tests - Auth Strategies
                        { key: 'Test_BasicAuthStrategy', path: 'tests/auth/Test_BasicAuthStrategy.ssjs', category: 'OmegaFramework/tests/auth' },
                        { key: 'Test_BearerAuthStrategy', path: 'tests/auth/Test_BearerAuthStrategy.ssjs', category: 'OmegaFramework/tests/auth' },
                        { key: 'Test_OAuth2AuthStrategy', path: 'tests/auth/Test_OAuth2AuthStrategy.ssjs', category: 'OmegaFramework/tests/auth' },

                        // Tests - Handlers
                        { key: 'Test_AssetHandler', path: 'tests/handlers/Test_AssetHandler.ssjs', category: 'OmegaFramework/tests/handlers' },
                        { key: 'Test_DataExtensionHandler', path: 'tests/handlers/Test_DataExtensionHandler.ssjs', category: 'OmegaFramework/tests/handlers' },
                        { key: 'Test_EmailHandler', path: 'tests/handlers/Test_EmailHandler.ssjs', category: 'OmegaFramework/tests/handlers' },
                        { key: 'Test_FolderHandler', path: 'tests/handlers/Test_FolderHandler.ssjs', category: 'OmegaFramework/tests/handlers' },
                        { key: 'Test_JourneyHandler', path: 'tests/handlers/Test_JourneyHandler.ssjs', category: 'OmegaFramework/tests/handlers' },

                        // Tests - Integrations
                        { key: 'Test_BaseIntegration', path: 'tests/integrations/Test_BaseIntegration.ssjs', category: 'OmegaFramework/tests/integrations' },
                        { key: 'Test_SFMCIntegration', path: 'tests/integrations/Test_SFMCIntegration.ssjs', category: 'OmegaFramework/tests/integrations' },
                        { key: 'Test_DataCloudIntegration', path: 'tests/integrations/Test_DataCloudIntegration.ssjs', category: 'OmegaFramework/tests/integrations' },
                        { key: 'Test_VeevaCRMIntegration', path: 'tests/integrations/Test_VeevaCRMIntegration.ssjs', category: 'OmegaFramework/tests/integrations' },
                        { key: 'Test_VeevaVaultIntegration', path: 'tests/integrations/Test_VeevaVaultIntegration.ssjs', category: 'OmegaFramework/tests/integrations' }
                    ];
    
                    var successCount = 0;
                    var failCount = 0;
    
                    // Process each file
                    for (var i = 0; i < files.length; i++) {
                        var file = files[i];
    
                        Write('<div class="progress-item info">');
                        Write('<strong>üì¶ Installing ' + (i + 1) + '/' + files.length + ':</strong> ' + file.key + '...');
                        Write('</div>');
    
                        try {
                            // Step 3a: Fetch file from GitHub
                            var fileUrl = githubRepo;
                            if (fileUrl.charAt(fileUrl.length - 1) !== '/') {
                                fileUrl += '/';
                            }
                            fileUrl += file.path;
    
                            var fileRequest = new Script.Util.HttpRequest(fileUrl);
                            fileRequest.emptyContentHandling = 0;
                            fileRequest.retries = 2;
                            fileRequest.continueOnError = true;
                            fileRequest.method = 'GET';
    
                            var fileResponse = fileRequest.send();
    
                            if (fileResponse.statusCode != 200) {
                                Write('<div class="progress-item error">');
                                Write('<strong>‚ùå Failed to fetch from GitHub</strong><br>');
                                Write('URL: ' + fileUrl + '<br>');
                                Write('Status: ' + fileResponse.statusCode);
                                Write('</div>');
                                failCount++;
    
                            }else{
                            var fileContent = String(fileResponse.content);
    
                            // Step 3b: Create Content Block in SFMC
                            var categoryId = folderIds[file.category] || 0;

                            if (categoryId == 0) {
                                Write('<div class="progress-item error">');
                                Write('<strong>‚ö†Ô∏è Warning:</strong> Folder "' + file.category + '" not found, using root folder');
                                Write('</div>');
                            }

                            var assetPayload = {
                                name: file.key,
                                customerKey: file.key,
                                assetType: {
                                    name: 'codesnippetblock',
                                    id: 220
                                },
                                content: fileContent,
                                category: {
                                    id: categoryId
                                }
                            };
    
                            var assetUrl = restInstanceUrl + '/asset/v1/content/assets';
                            var assetRequest = new Script.Util.HttpRequest(assetUrl);
                            assetRequest.emptyContentHandling = 0;
                            assetRequest.retries = 2;
                            assetRequest.continueOnError = true;
                            assetRequest.contentType = 'application/json';
                            assetRequest.method = 'POST';
                            assetRequest.setHeader('Authorization', 'Bearer ' + accessToken);
                            assetRequest.postData = Stringify(assetPayload);
    
                            var assetResponse = assetRequest.send();
    Write(Stringify(assetResponse.content))
    Write(Stringify(assetResponse.statusCode))
    
                            if (assetResponse.statusCode == 200 || assetResponse.statusCode == 201) {
                                Write('<div class="progress-item success">');
                                Write('<strong>‚úÖ ' + file.key + '</strong> installed successfully');
                                Write('</div>');
                                successCount++;
                            } else {
                                Write('<div class="progress-item error">');
                                Write('<strong>‚ùå ' + file.key + '</strong> failed to install<br>');
                                Write('Status: ' + assetResponse.statusCode + '<br>');
                                Write('Response: ' + assetResponse.content.substring(0, 200));
                                Write('</div>');
                                failCount++;
                            }
                            }
    
                        } catch (ex) {
                            Write('<div class="progress-item error">');
                            Write('<strong>‚ùå Exception:</strong> ' + (ex.message || ex.toString()));
                            Write('</div>');
                            failCount++;
                        }
                    }
    
                    // Summary
                    Write('<hr>');
                    Write('<div class="summary">');
                    Write('<h2>üìä Installation Summary</h2>');
                    Write('<p><strong>Total Content Blocks:</strong> ' + files.length + '</p>');
                    Write('<p><strong style="color: green;">‚úÖ Successful:</strong> ' + successCount + '</p>');
                    Write('<p><strong style="color: red;">‚ùå Failed:</strong> ' + failCount + '</p>');
    
                    if (failCount == 0) {
                        Write('<h3 style="color: green;">üéâ ALL CONTENT BLOCKS INSTALLED SUCCESSFULLY!</h3>');
                        Write('<p>Next steps:</p>');
                        Write('<ol>');
                        Write('<li>Verify Content Blocks in Content Builder ‚Üí Folders: <strong>OmegaFramework/core</strong>, <strong>handlers</strong>, <strong>creators</strong>, and <strong>tests</strong></li>');
                        Write('<li>Load Core module in your CloudPage: <code>%%=ContentBlockByKey("OMG_FW_Core")=%%</code></li>');
                        Write('<li>Configure the framework: <code>OmegaFramework.configure({auth: {...}})</code></li>');
                        Write('<li>Run test files to validate installation (check OmegaFramework/tests folder)</li>');
                        Write('<li>Start building with OmegaFramework handlers!</li>');
                        Write('</ol>');
                    } else {
                        Write('<h3 style="color: orange;">‚ö†Ô∏è INSTALLATION COMPLETED WITH ERRORS</h3>');
                        Write('<p>Some Content Blocks failed to install. Please review the errors above and:</p>');
                        Write('<ul>');
                        Write('<li>Check your API permissions (Read & Write for Content Builder)</li>');
                        Write('<li>Verify the GitHub repository URL is correct</li>');
                        Write('<li>Try installing failed blocks manually</li>');
                        Write('<li>Run the installer again for failed blocks</li>');
                        Write('</ul>');
                    }
    
                    Write('</div>');
                }
            }
    
        } catch (ex) {
            Write('<div class="progress-item error">');
            Write('<strong>‚ùå Fatal Error:</strong><br>');
            Write(ex.message || ex.toString());
            Write('</div>');
        }
    
        Write('<hr>');
        Write('<p><a href="#" style="color: #0176d3; text-decoration: none; font-weight: bold;">‚Üê Back to Installer</a></p>');
        Write('</div></body></html>');
    
    } else {
        // FRONTEND MODE: Show HTML form
    </script>
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>OmegaFramework v2.0 - Automated Installer</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 1200px;
                margin: 50px auto;
                padding: 20px;
                background-color: #f5f5f5;
            }
            .container {
                background-color: white;
                padding: 30px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            h1 {
                color: #0176d3;
                border-bottom: 3px solid #0176d3;
                padding-bottom: 10px;
            }
            .section {
                margin: 20px 0;
                padding: 15px;
                background-color: #f9f9f9;
                border-left: 4px solid #0176d3;
            }
            .warning {
                background-color: #fff3cd;
                border-left-color: #ffc107;
                color: #856404;
            }
            .success {
                background-color: #d4edda;
                border-left-color: #28a745;
                color: #155724;
            }
            label {
                display: block;
                margin-top: 15px;
                margin-bottom: 5px;
                font-weight: bold;
            }
            input[type="text"], input[type="password"] {
                width: 100%;
                padding: 10px;
                margin: 5px 0;
                border: 1px solid #ddd;
                border-radius: 4px;
                box-sizing: border-box;
            }
            button {
                background-color: #0176d3;
                color: white;
                padding: 12px 30px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
                margin: 10px 5px 10px 0;
            }
            button:hover {
                background-color: #014b87;
            }
            button:disabled {
                background-color: #ccc;
                cursor: not-allowed;
            }
            .file-list {
                list-style-type: none;
                padding: 0;
            }
            .file-list li {
                padding: 8px;
                margin: 5px 0;
                background-color: #f9f9f9;
                border-left: 3px solid #0176d3;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üöÄ OmegaFramework v2.0 - Automated Installer</h1>
    
            <div class="section warning">
                <h3>‚ö†Ô∏è Important Prerequisites</h3>
                <ul>
                    <li>You need an <strong>Installed Package</strong> in SFMC with API permissions</li>
                    <li>Required permissions: <strong>Read</strong> and <strong>Write</strong> for Content Builder</li>
                    <li>This installer will create <strong>32 Content Blocks</strong> via REST API (16 source + 16 tests)</li>
                    <li>Installation happens server-side (no CORS issues)</li>
                    <li>Files will be organized in folders: <strong>OmegaFramework/core</strong>, <strong>auth</strong>, <strong>integrations</strong>, <strong>handlers</strong>, and <strong>tests</strong></li>
                </ul>
            </div>
    
            <form id="installForm" method="POST" action="">
                <input type="hidden" name="install" value="1">
    
                <div class="section">
                    <h3>Step 1: SFMC Credentials</h3>
                    <p>Enter your SFMC Installed Package credentials:</p>
    
                    <label for="clientId"><strong>Client ID:</strong></label>
                    <input type="text" id="clientId" name="clientId" placeholder="Enter your Client ID" value="zshou8dj8tykbtc58psf1bxq" required>
    
                    <label for="clientSecret"><strong>Client Secret:</strong></label>
                    <input type="password" id="clientSecret" name="clientSecret" placeholder="Enter your Client Secret" value="" required>
    
                    <label for="authBaseUrl"><strong>Auth Base URL:</strong></label>
                    <input type="text" id="authBaseUrl" name="authBaseUrl" placeholder="https://YOUR_SUBDOMAIN.auth.marketingcloudapis.com/" value="https://mcgwsh19xsfbh858gh-fc-cy7-w4.auth.marketingcloudapis.com/" required>
                </div>
    
                <div class="section">
                    <h3>Step 2: GitHub Repository Configuration</h3>
                    <p>Source files will be loaded from GitHub:</p>
    
                    <label for="githubRepo"><strong>GitHub Repository Base URL:</strong></label>
                    <input type="text" id="githubRepo" name="githubRepo" value="https://raw.githubusercontent.com/oskyar/miniframework-ssjs/main/" required>
    
                    <div class="section warning" style="margin-top: 15px;">
                        <strong>Note:</strong> Files will be organized in SFMC into: core/, handlers/, creators/, and tests/ folders.
                    </div>
                </div>
    
                <div class="section">
                    <h3>Step 3: Content Blocks to Install</h3>
                    <p>The following 32 Content Blocks will be created:</p>

                    <h4 style="margin-top: 20px; color: #0176d3;">üì¶ Core Modules (3 blocks) ‚Üí OmegaFramework/core</h4>
                    <ul class="file-list">
                        <li><strong>OMG_FW_ResponseWrapper</strong> - Standardized response handling</li>
                        <li><strong>OMG_FW_ConnectionHandler</strong> - HTTP requests with retry logic</li>
                        <li><strong>OMG_FW_DataExtensionTokenCache</strong> - Persistent token caching</li>
                    </ul>

                    <h4 style="margin-top: 20px; color: #6f42c1;">üîê Auth Strategies (3 blocks) ‚Üí OmegaFramework/auth</h4>
                    <ul class="file-list">
                        <li><strong>OMG_FW_BasicAuthStrategy</strong> - HTTP Basic authentication</li>
                        <li><strong>OMG_FW_BearerAuthStrategy</strong> - Bearer token authentication</li>
                        <li><strong>OMG_FW_OAuth2AuthStrategy</strong> - OAuth2 client credentials flow</li>
                    </ul>

                    <h4 style="margin-top: 20px; color: #17a2b8;">üîó Integrations (5 blocks) ‚Üí OmegaFramework/integrations</h4>
                    <ul class="file-list">
                        <li><strong>OMG_FW_BaseIntegration</strong> - Base class for all integrations</li>
                        <li><strong>OMG_FW_SFMCIntegration</strong> - Salesforce Marketing Cloud integration</li>
                        <li><strong>OMG_FW_DataCloudIntegration</strong> - Salesforce Data Cloud integration</li>
                        <li><strong>OMG_FW_VeevaCRMIntegration</strong> - Veeva CRM integration</li>
                        <li><strong>OMG_FW_VeevaVaultIntegration</strong> - Veeva Vault integration</li>
                    </ul>

                    <h4 style="margin-top: 20px; color: #28a745;">üîß Handlers (5 blocks) ‚Üí OmegaFramework/handlers</h4>
                    <ul class="file-list">
                        <li><strong>OMG_FW_AssetHandler</strong> - Content Builder asset management</li>
                        <li><strong>OMG_FW_DataExtensionHandler</strong> - Data Extension operations</li>
                        <li><strong>OMG_FW_EmailHandler</strong> - Email and template management</li>
                        <li><strong>OMG_FW_FolderHandler</strong> - Folder structure management</li>
                        <li><strong>OMG_FW_JourneyHandler</strong> - Journey Builder operations</li>
                    </ul>

                    <h4 style="margin-top: 20px; color: #28a745;">üß™ Test Suites (16 blocks) ‚Üí OmegaFramework/tests/</h4>
                    <ul class="file-list">
                        <li><strong>Core Tests (3):</strong> ResponseWrapper, ConnectionHandler, DataExtensionTokenCache</li>
                        <li><strong>Auth Tests (3):</strong> BasicAuthStrategy, BearerAuthStrategy, OAuth2AuthStrategy</li>
                        <li><strong>Handler Tests (5):</strong> AssetHandler, DataExtensionHandler, EmailHandler, FolderHandler, JourneyHandler</li>
                        <li><strong>Integration Tests (5):</strong> BaseIntegration, SFMCIntegration, DataCloudIntegration, VeevaCRMIntegration, VeevaVaultIntegration</li>
                    </ul>

                    <p style="margin-top: 20px;"><strong>Total: 32 Content Blocks (16 source + 16 tests)</strong></p>
                </div>
    
                <div class="section">
                    <button type="submit">üöÄ Start Installation</button>
                </div>
            </form>
    
            <div class="section success">
                <h3>‚úÖ What This Installer Does</h3>
                <ol>
                    <li>Authenticates with SFMC using your credentials</li>
                    <li>Fetches each file from GitHub (server-side, no CORS)</li>
                    <li>Creates Content Blocks one by one via REST API</li>
                    <li>Shows real-time progress for each file</li>
                    <li>Displays detailed success/error report</li>
                </ol>
            </div>
        </div>
    
        %%=Concat('<sc', 'ript>')=%%
            // Simple form validation
            document.getElementById('installForm').addEventListener('submit', function(e) {
                var clientId = document.getElementById('clientId').value;
                var clientSecret = document.getElementById('clientSecret').value;
                var authBaseUrl = document.getElementById('authBaseUrl').value;
                var githubRepo = document.getElementById('githubRepo').value;
    
                if (!clientId || !clientSecret || !authBaseUrl || !githubRepo) {
                    e.preventDefault();
                    alert('Please fill in all required fields');
                    return false;
                }
    
                // Confirm before starting
                if (!confirm('Ready to install 32 Content Blocks (16 source + 16 tests)?\n\nThis will take a few minutes.\n\nClick OK to proceed.')) {
                    e.preventDefault();
                    return false;
                }
    
                // Show loading message
                var button = this.querySelector('button[type="submit"]');
                button.disabled = true;
                button.textContent = '‚è≥ Installing... Please wait...';
            });
        %%=Concat('</sc', 'ript>')=%%
    </body>
    </html>
    <script runat="server">
    }
    }catch(ex){
        Write(Stringify(ex))
    }
    
    </script>
    