<script runat="server">
    Platform.Load("core", "1.1.1");
    try{
    /**
     * AutomatedInstaller - Hybrid CloudPage for OmegaFramework Installation
     *
     * This page works in two modes:
     * 1. Without parameters: Shows HTML form for configuration
     * 2. With install=1: Executes SSJS backend to install Content Blocks
     *
     * @version 2.0.0
     * @author OmegaFramework
     */
    
    // Check if this is an installation request
    var isInstallRequest = Request.GetQueryStringParameter('install') === '1' ||
                           Request.GetFormField('install') === '1';
    var version = 2
    
    if (isInstallRequest) {
        // BACKEND MODE: Execute installation
    
        Write('<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8">');
        Write('<meta name="viewport" content="width=device-width, initial-scale=1.0">');
        Write('<title>OmegaFramework v2.0 - Installation Progress</title>');
        Write('<style>');
        Write('body { font-family: Arial, sans-serif; max-width: 1200px; margin: 50px auto; padding: 20px; background-color: #f5f5f5; }');
        Write('.container { background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }');
        Write('h1 { color: #0176d3; border-bottom: 3px solid #0176d3; padding-bottom: 10px; }');
        Write('.progress-item { padding: 10px; margin: 10px 0; border-radius: 4px; border-left: 4px solid #ccc; }');
        Write('.success { background-color: #d4edda; border-left-color: #28a745; color: #155724; }');
        Write('.error { background-color: #f8d7da; border-left-color: #dc3545; color: #721c24; }');
        Write('.info { background-color: #d1ecf1; border-left-color: #0c5460; color: #0c5460; }');
        Write('.summary { margin-top: 30px; padding: 20px; background-color: #f0f0f0; border-radius: 5px; }');
        Write('</style></head><body><div class="container">');
    
        Write('<h1>üöÄ OmegaFramework v2.0 - Installation Progress</h1>');
        Write('<hr>');
    
        try {
            // Get parameters from POST
            var clientId = Request.GetFormField('clientId');
            var clientSecret = Request.GetFormField('clientSecret');
            var authBaseUrl = Request.GetFormField('authBaseUrl');
            var githubRepo = Request.GetFormField('githubRepo');
    
            // Validate parameters
            if (!clientId || !clientSecret || !authBaseUrl || !githubRepo) {
                Write('<div class="progress-item error">');
                Write('<strong>‚ùå Error:</strong> Missing required parameters.<br>');
                Write('Please go back and fill in all required fields.');
                Write('</div>');
                Write('</div></body></html>');
            } else {
                Write('<div class="progress-item info">');
                Write('<strong>üìã Configuration:</strong><br>');
                Write('Auth Base URL: ' + authBaseUrl + '<br>');
                Write('GitHub Repository: ' + githubRepo + '<br>');
                Write('Client ID: ' + clientId.substring(0, 8) + '...');
                Write('</div>');
    
                // Step 1: Get OAuth2 token
                Write('<h2>Step 1: Obtaining Access Token</h2>');
    
                var tokenUrl = authBaseUrl;
                if (tokenUrl.charAt(tokenUrl.length - 1) !== '/') {
                    tokenUrl += '/';
                }
                tokenUrl += 'v2/token';
    
                var tokenPayload = {
                    grant_type: 'client_credentials',
                    client_id: clientId,
                    client_secret: clientSecret,
                    account_id: "518006929"
                };
    
                var tokenRequest = new Script.Util.HttpRequest(tokenUrl);
                tokenRequest.emptyContentHandling = 0;
                tokenRequest.retries = 2;
                tokenRequest.continueOnError = true;
                tokenRequest.contentType = 'application/json';
                tokenRequest.method = 'POST';
                tokenRequest.postData = Stringify(tokenPayload);
    
                var tokenResponse = tokenRequest.send();
                //Write(Stringify(tokenResponse.statusCode))
                if (tokenResponse.statusCode != 200) {
                    Write('<div class="progress-item error">');
                    Write('<strong>‚ùå Authentication Failed</strong><br>');
                    Write('Status Code: ' + tokenResponse.statusCode + '<br>');
                    Write('Response: ' + tokenResponse.content);
                    Write('</div>');
                    Write('</div></body></html>');
                } else {
                    var tokenData = Platform.Function.ParseJSON(String(tokenResponse.content));
                    var accessToken = tokenData.access_token;
                    var restInstanceUrl = tokenData.rest_instance_url;
    
                    Write('<div class="progress-item success">');
                    Write('<strong>‚úÖ Access Token Obtained</strong><br>');
                    Write('REST Instance: ' + restInstanceUrl);
                    Write('</div>');

                    // Step 2: Create folder structure (OPTIMIZED)
                    Write('<h2>Step 2: Creating Folder Structure</h2>');

                    var folderIds = {};
                    var rootFolderId = 0;

                    try {
                        // Step 2.1: Get root folder ID
                        Write('<div class="progress-item info">');
                        Write('<strong>üîç Finding root folder...</strong>');
                        Write('</div>');

                        var rootUrl = restInstanceUrl + '/asset/v1/content/categories?$filter=parentId eq 0&$pageSize=1';
                        var rootRequest = new Script.Util.HttpRequest(rootUrl);
                        rootRequest.emptyContentHandling = 0;
                        rootRequest.retries = 2;
                        rootRequest.continueOnError = true;
                        rootRequest.method = 'GET';
                        rootRequest.setHeader('Authorization', 'Bearer ' + accessToken);

                        var rootResponse = rootRequest.send();
                        if (rootResponse.statusCode == 200) {
                            var rootData = Platform.Function.ParseJSON(String(rootResponse.content));
                            if (rootData.items && rootData.items.length > 0) {
                                rootFolderId = rootData.items[0].id;
                                Write('<div class="progress-item success">');
                                Write('<strong>‚úÖ Root folder found</strong> (ID: ' + rootFolderId + ')');
                                Write('</div>');
                            }
                        }

                        if (rootFolderId == 0) {
                            throw new Error('Could not find root folder ID');
                        }

                        // Step 2.2: Get ALL existing folders (with pagination)
                        Write('<div class="progress-item info">');
                        Write('<strong>üîç Loading all existing folders...</strong>');
                        Write('</div>');

                        var allFolders = [];
                        var pageSize = 500;
                        var page = 1;
                        var hasMore = true;

                        while (hasMore) {
                            var allFoldersUrl = restInstanceUrl + '/asset/v1/content/categories?$pageSize=' + pageSize + '&$page=' + page;
                            var allFoldersRequest = new Script.Util.HttpRequest(allFoldersUrl);
                            allFoldersRequest.emptyContentHandling = 0;
                            allFoldersRequest.retries = 2;
                            allFoldersRequest.continueOnError = true;
                            allFoldersRequest.method = 'GET';
                            allFoldersRequest.setHeader('Authorization', 'Bearer ' + accessToken);

                            var allFoldersResponse = allFoldersRequest.send();
                            if (allFoldersResponse.statusCode == 200) {
                                var foldersData = Platform.Function.ParseJSON(String(allFoldersResponse.content));
                                if (foldersData.items && foldersData.items.length > 0) {
                                    for (var f = 0; f < foldersData.items.length; f++) {
                                        allFolders.push(foldersData.items[f]);
                                    }

                                    // Check if there are more pages
                                    if (foldersData.count > page * pageSize) {
                                        page++;
                                    } else {
                                        hasMore = false;
                                    }
                                } else {
                                    hasMore = false;
                                }
                            } else {
                                hasMore = false;
                            }
                        }

                        Write('<div class="progress-item success">');
                        Write('<strong>‚úÖ Loaded ' + allFolders.length + ' existing folders</strong>');
                        Write('</div>');

                        // Step 2.3: Create folder map by name and parentId
                        var folderMap = {};
                        for (var i = 0; i < allFolders.length; i++) {
                            var folder = allFolders[i];
                            var key = folder.name + '_' + folder.parentId;
                            folderMap[key] = folder.id;
                        }

                        // Step 2.4: Check and create OmegaFramework folder
                        var omegaKey = 'OmegaFramework_' + rootFolderId;
                        var omegaFolderId = folderMap[omegaKey];

                        if (omegaFolderId) {
                            Write('<div class="progress-item info">');
                            Write('<strong>‚ÑπÔ∏è OmegaFramework</strong> folder already exists (ID: ' + omegaFolderId + ')');
                            Write('</div>');
                        } else {
                            Write('<div class="progress-item info">');
                            Write('<strong>üìÅ Creating folder:</strong> OmegaFramework...');
                            Write('</div>');

                            var omegaPayload = {
                                name: 'OmegaFramework',
                                parentId: rootFolderId,
                                description: 'OmegaFramework v1.1 - Main folder'
                            };

                            var folderUrl = restInstanceUrl + '/asset/v1/content/categories';
                            var omegaRequest = new Script.Util.HttpRequest(folderUrl);
                            omegaRequest.emptyContentHandling = 0;
                            omegaRequest.retries = 2;
                            omegaRequest.continueOnError = true;
                            omegaRequest.contentType = 'application/json';
                            omegaRequest.method = 'POST';
                            omegaRequest.setHeader('Authorization', 'Bearer ' + accessToken);
                            omegaRequest.postData = Stringify(omegaPayload);

                            var omegaResponse = omegaRequest.send();
                            if (omegaResponse.statusCode == 200 || omegaResponse.statusCode == 201) {
                                var omegaData = Platform.Function.ParseJSON(String(omegaResponse.content));
                                omegaFolderId = omegaData.id;

                                Write('<div class="progress-item success">');
                                Write('<strong>‚úÖ OmegaFramework</strong> folder created (ID: ' + omegaFolderId + ')');
                                Write('</div>');
                            } else {
                                Write('<div class="progress-item error">');
                                Write('<strong>‚ùå Failed to create OmegaFramework folder</strong><br>');
                                Write('Status: ' + omegaResponse.statusCode);
                                Write('</div>');
                            }
                        }

                        folderIds['OmegaFramework'] = omegaFolderId;

                        // Step 2.5: Create subfolders (core, auth, integrations, handlers, tests, examples)
                        if (omegaFolderId) {
                            var subfolders = [
                                { name: 'core', description: 'Core framework modules (ResponseWrapper, ConnectionHandler, TokenCache)' },
                                { name: 'auth', description: 'Authentication strategies (Basic, Bearer, OAuth2)' },
                                { name: 'integrations', description: 'External system integrations (SFMC, DataCloud, Veeva)' },
                                { name: 'handlers', description: 'SFMC operation handlers (Asset, Email, DataExtension, etc.)' },
                                { name: 'tests', description: 'Test suites for all modules' },
                                { name: 'examples', description: 'Complete working examples and tutorials' }
                            ];

                            for (var s = 0; s < subfolders.length; s++) {
                                var subfolder = subfolders[s];
                                var subfolderKey = subfolder.name + '_' + omegaFolderId;
                                var subfolderId = folderMap[subfolderKey];

                                if (subfolderId) {
                                    Write('<div class="progress-item info">');
                                    Write('<strong>‚ÑπÔ∏è ' + subfolder.name + '</strong> subfolder already exists (ID: ' + subfolderId + ')');
                                    Write('</div>');
                                } else {
                                    Write('<div class="progress-item info">');
                                    Write('<strong>üìÅ Creating subfolder:</strong> OmegaFramework/' + subfolder.name + '...');
                                    Write('</div>');

                                    var subfolderPayload = {
                                        name: subfolder.name,
                                        parentId: omegaFolderId,
                                        description: subfolder.description
                                    };

                                    var subfolderRequest = new Script.Util.HttpRequest(folderUrl);
                                    subfolderRequest.emptyContentHandling = 0;
                                    subfolderRequest.retries = 2;
                                    subfolderRequest.continueOnError = true;
                                    subfolderRequest.contentType = 'application/json';
                                    subfolderRequest.method = 'POST';
                                    subfolderRequest.setHeader('Authorization', 'Bearer ' + accessToken);
                                    subfolderRequest.postData = Stringify(subfolderPayload);

                                    var subfolderResponse = subfolderRequest.send();
                                    if (subfolderResponse.statusCode == 200 || subfolderResponse.statusCode == 201) {
                                        var subfolderData = Platform.Function.ParseJSON(String(subfolderResponse.content));
                                        subfolderId = subfolderData.id;

                                        Write('<div class="progress-item success">');
                                        Write('<strong>‚úÖ ' + subfolder.name + '</strong> subfolder created (ID: ' + subfolderId + ')');
                                        Write('</div>');
                                    } else {
                                        Write('<div class="progress-item error">');
                                        Write('<strong>‚ùå Failed to create ' + subfolder.name + ' folder</strong><br>');
                                        Write('Status: ' + subfolderResponse.statusCode);
                                        Write('</div>');
                                    }
                                }

                                folderIds['OmegaFramework/' + subfolder.name] = subfolderId;
                            }

                            // Step 2.6: Create test subfolders (core, auth, handlers, integrations)
                            var testsFolderId = folderIds['OmegaFramework/tests'];
                            if (testsFolderId) {
                                var testSubfolders = [
                                    { name: 'core', description: 'Core module tests' },
                                    { name: 'auth', description: 'Authentication strategy tests' },
                                    { name: 'handlers', description: 'Handler tests' },
                                    { name: 'integrations', description: 'Integration tests' }
                                ];

                                for (var t = 0; t < testSubfolders.length; t++) {
                                    var testSubfolder = testSubfolders[t];
                                    var testSubfolderKey = testSubfolder.name + '_' + testsFolderId;
                                    var testSubfolderId = folderMap[testSubfolderKey];

                                    if (testSubfolderId) {
                                        Write('<div class="progress-item info">');
                                        Write('<strong>‚ÑπÔ∏è tests/' + testSubfolder.name + '</strong> subfolder already exists (ID: ' + testSubfolderId + ')');
                                        Write('</div>');
                                    } else {
                                        Write('<div class="progress-item info">');
                                        Write('<strong>üìÅ Creating test subfolder:</strong> OmegaFramework/tests/' + testSubfolder.name + '...');
                                        Write('</div>');

                                        var testSubfolderPayload = {
                                            name: testSubfolder.name,
                                            parentId: testsFolderId,
                                            description: testSubfolder.description
                                        };

                                        var testSubfolderRequest = new Script.Util.HttpRequest(folderUrl);
                                        testSubfolderRequest.emptyContentHandling = 0;
                                        testSubfolderRequest.retries = 2;
                                        testSubfolderRequest.continueOnError = true;
                                        testSubfolderRequest.contentType = 'application/json';
                                        testSubfolderRequest.method = 'POST';
                                        testSubfolderRequest.setHeader('Authorization', 'Bearer ' + accessToken);
                                        testSubfolderRequest.postData = Stringify(testSubfolderPayload);

                                        var testSubfolderResponse = testSubfolderRequest.send();
                                        if (testSubfolderResponse.statusCode == 200 || testSubfolderResponse.statusCode == 201) {
                                            var testSubfolderData = Platform.Function.ParseJSON(String(testSubfolderResponse.content));
                                            testSubfolderId = testSubfolderData.id;

                                            Write('<div class="progress-item success">');
                                            Write('<strong>‚úÖ tests/' + testSubfolder.name + '</strong> subfolder created (ID: ' + testSubfolderId + ')');
                                            Write('</div>');
                                        } else {
                                            Write('<div class="progress-item error">');
                                            Write('<strong>‚ùå Failed to create tests/' + testSubfolder.name + ' folder</strong><br>');
                                            Write('Status: ' + testSubfolderResponse.statusCode);
                                            Write('</div>');
                                        }
                                    }

                                    folderIds['OmegaFramework/tests/' + testSubfolder.name] = testSubfolderId;
                                }
                            }
                        }

                        Write('<hr>');
                        Write('<div class="progress-item success">');
                        Write('<strong>üìÅ Folder structure ready:</strong><br>');
                        Write('- OmegaFramework (ID: ' + folderIds['OmegaFramework'] + ')<br>');
                        Write('&nbsp;&nbsp;‚îú‚îÄ‚îÄ core (ID: ' + folderIds['OmegaFramework/core'] + ')<br>');
                        Write('&nbsp;&nbsp;‚îú‚îÄ‚îÄ auth (ID: ' + folderIds['OmegaFramework/auth'] + ')<br>');
                        Write('&nbsp;&nbsp;‚îú‚îÄ‚îÄ integrations (ID: ' + folderIds['OmegaFramework/integrations'] + ')<br>');
                        Write('&nbsp;&nbsp;‚îú‚îÄ‚îÄ handlers (ID: ' + folderIds['OmegaFramework/handlers'] + ')<br>');
                        Write('&nbsp;&nbsp;‚îú‚îÄ‚îÄ examples (ID: ' + folderIds['OmegaFramework/examples'] + ')<br>');
                        Write('&nbsp;&nbsp;‚îî‚îÄ‚îÄ tests (ID: ' + folderIds['OmegaFramework/tests'] + ')<br>');
                        Write('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îú‚îÄ‚îÄ core (ID: ' + folderIds['OmegaFramework/tests/core'] + ')<br>');
                        Write('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îú‚îÄ‚îÄ auth (ID: ' + folderIds['OmegaFramework/tests/auth'] + ')<br>');
                        Write('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îú‚îÄ‚îÄ handlers (ID: ' + folderIds['OmegaFramework/tests/handlers'] + ')<br>');
                        Write('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îî‚îÄ‚îÄ integrations (ID: ' + folderIds['OmegaFramework/tests/integrations'] + ')');
                        Write('</div>');
                        Write('<hr>');

                    } catch (folderEx) {
                        Write('<div class="progress-item error">');
                        Write('<strong>‚ùå Error creating folders:</strong> ' + (folderEx.message || folderEx.toString()));
                        Write('</div>');
                    }

                    // Step 3: Define files to install
                    Write('<h2>Step 3: Installing Content Blocks</h2>');

                    var files = [
                        // Core Framework Files (NEW ARCHITECTURE)
                        { key: 'OMG_FW_OmegaFramework', path: 'core/OmegaFramework.ssjs', category: 'OmegaFramework/core' },
                        { key: 'OMG_FW_ResponseWrapper', path: 'core/ResponseWrapper.ssjs', category: 'OmegaFramework/core' },
                        { key: 'OMG_FW_ConnectionHandler', path: 'core/ConnectionHandler.ssjs', category: 'OmegaFramework/core' },
                        { key: 'OMG_FW_DataExtensionTokenCache', path: 'core/DataExtensionTokenCache.ssjs', category: 'OmegaFramework/core' },
                        { key: 'OMG_FW_CredentialStore', path: 'core/CredentialStore.ssjs', category: 'OmegaFramework/core' },

                        // Auth Strategies (NEW ARCHITECTURE)
                        { key: 'OMG_FW_BasicAuthStrategy', path: 'auth/BasicAuthStrategy.ssjs', category: 'OmegaFramework/auth' },
                        { key: 'OMG_FW_BearerAuthStrategy', path: 'auth/BearerAuthStrategy.ssjs', category: 'OmegaFramework/auth' },
                        { key: 'OMG_FW_OAuth2AuthStrategy', path: 'auth/OAuth2AuthStrategy.ssjs', category: 'OmegaFramework/auth' },

                        // Integrations (NEW ARCHITECTURE)
                        { key: 'OMG_FW_BaseIntegration', path: 'integrations/BaseIntegration.ssjs', category: 'OmegaFramework/integrations' },
                        { key: 'OMG_FW_SFMCIntegration', path: 'integrations/SFMCIntegration.ssjs', category: 'OmegaFramework/integrations' },
                        { key: 'OMG_FW_DataCloudIntegration', path: 'integrations/DataCloudIntegration.ssjs', category: 'OmegaFramework/integrations' },
                        { key: 'OMG_FW_VeevaCRMIntegration', path: 'integrations/VeevaCRMIntegration.ssjs', category: 'OmegaFramework/integrations' },
                        { key: 'OMG_FW_VeevaVaultIntegration', path: 'integrations/VeevaVaultIntegration.ssjs', category: 'OmegaFramework/integrations' },

                        // Handlers (NEW ARCHITECTURE)
                        { key: 'OMG_FW_AssetHandler', path: 'handlers/AssetHandler.ssjs', category: 'OmegaFramework/handlers' },
                        { key: 'OMG_FW_DataExtensionHandler', path: 'handlers/DataExtensionHandler.ssjs', category: 'OmegaFramework/handlers' },
                        { key: 'OMG_FW_EmailHandler', path: 'handlers/EmailHandler.ssjs', category: 'OmegaFramework/handlers' },
                        { key: 'OMG_FW_FolderHandler', path: 'handlers/FolderHandler.ssjs', category: 'OmegaFramework/handlers' },
                        { key: 'OMG_FW_JourneyHandler', path: 'handlers/JourneyHandler.ssjs', category: 'OmegaFramework/handlers' },

                        // Examples - Complete Working Examples
                        { key: 'Example_SFMC_Complete_Authentication', path: 'examples/Example_SFMC_Complete_Authentication.html', category: 'OmegaFramework/examples' },
                        { key: 'Example_SFMC_DataExtension_Read', path: 'examples/Example_SFMC_DataExtension_Read.html', category: 'OmegaFramework/examples' },
                        { key: 'Example_SFMC_DataExtension_Write', path: 'examples/Example_SFMC_DataExtension_Write.html', category: 'OmegaFramework/examples' },
                        { key: 'Example_SFMC_Complete_Workflow', path: 'examples/Example_SFMC_Complete_Workflow.html', category: 'OmegaFramework/examples' },

                        // Tests - Core
                        { key: 'Test_ResponseWrapper', path: 'tests/core/Test_ResponseWrapper.ssjs', category: 'OmegaFramework/tests/core' },
                        { key: 'Test_ConnectionHandler', path: 'tests/core/Test_ConnectionHandler.ssjs', category: 'OmegaFramework/tests/core' },
                        { key: 'Test_DataExtensionTokenCache', path: 'tests/core/Test_DataExtensionTokenCache.ssjs', category: 'OmegaFramework/tests/core' },
                        { key: 'Test_CredentialStore', path: 'tests/core/Test_CredentialStore.ssjs', category: 'OmegaFramework/tests/core' },

                        // Tests - Auth Strategies
                        { key: 'Test_BasicAuthStrategy', path: 'tests/auth/Test_BasicAuthStrategy.ssjs', category: 'OmegaFramework/tests/auth' },
                        { key: 'Test_BearerAuthStrategy', path: 'tests/auth/Test_BearerAuthStrategy.ssjs', category: 'OmegaFramework/tests/auth' },
                        { key: 'Test_OAuth2AuthStrategy', path: 'tests/auth/Test_OAuth2AuthStrategy.ssjs', category: 'OmegaFramework/tests/auth' },

                        // Tests - Handlers
                        { key: 'Test_AssetHandler', path: 'tests/handlers/Test_AssetHandler.ssjs', category: 'OmegaFramework/tests/handlers' },
                        { key: 'Test_DataExtensionHandler', path: 'tests/handlers/Test_DataExtensionHandler.ssjs', category: 'OmegaFramework/tests/handlers' },
                        { key: 'Test_EmailHandler', path: 'tests/handlers/Test_EmailHandler.ssjs', category: 'OmegaFramework/tests/handlers' },
                        { key: 'Test_FolderHandler', path: 'tests/handlers/Test_FolderHandler.ssjs', category: 'OmegaFramework/tests/handlers' },
                        { key: 'Test_JourneyHandler', path: 'tests/handlers/Test_JourneyHandler.ssjs', category: 'OmegaFramework/tests/handlers' },

                        // Tests - Integrations
                        { key: 'Test_BaseIntegration', path: 'tests/integrations/Test_BaseIntegration.ssjs', category: 'OmegaFramework/tests/integrations' },
                        { key: 'Test_SFMCIntegration', path: 'tests/integrations/Test_SFMCIntegration.ssjs', category: 'OmegaFramework/tests/integrations' },
                        { key: 'Test_DataCloudIntegration', path: 'tests/integrations/Test_DataCloudIntegration.ssjs', category: 'OmegaFramework/tests/integrations' },
                        { key: 'Test_VeevaCRMIntegration', path: 'tests/integrations/Test_VeevaCRMIntegration.ssjs', category: 'OmegaFramework/tests/integrations' },
                        { key: 'Test_VeevaVaultIntegration', path: 'tests/integrations/Test_VeevaVaultIntegration.ssjs', category: 'OmegaFramework/tests/integrations' }
                    ];
    
                    var successCount = 0;
                    var failCount = 0;
    
                    // Process each file
                    for (var i = 0; i < files.length; i++) {
                        var file = files[i];
    
                        Write('<div class="progress-item info">');
                        Write('<strong>üì¶ Installing ' + (i + 1) + '/' + files.length + ':</strong> ' + file.key + '...');
                        Write('</div>');
    
                        try {
                            // Step 3a: Fetch file from GitHub
                            var fileUrl = githubRepo;
                            if (fileUrl.charAt(fileUrl.length - 1) !== '/') {
                                fileUrl += '/';
                            }
                            fileUrl += file.path;
    
                            var fileRequest = new Script.Util.HttpRequest(fileUrl);
                            fileRequest.emptyContentHandling = 0;
                            fileRequest.retries = 2;
                            fileRequest.continueOnError = true;
                            fileRequest.method = 'GET';
    
                            var fileResponse = fileRequest.send();
    
                            if (fileResponse.statusCode != 200) {
                                Write('<div class="progress-item error">');
                                Write('<strong>‚ùå Failed to fetch from GitHub</strong><br>');
                                Write('URL: ' + fileUrl + '<br>');
                                Write('Status: ' + fileResponse.statusCode);
                                Write('</div>');
                                failCount++;
    
                            }else{
                            var fileContent = String(fileResponse.content);
    
                            // Step 3b: Create Content Block in SFMC
                            var categoryId = folderIds[file.category] || 0;

                            if (categoryId == 0) {
                                Write('<div class="progress-item error">');
                                Write('<strong>‚ö†Ô∏è Warning:</strong> Folder "' + file.category + '" not found, using root folder');
                                Write('</div>');
                            }

                            var assetPayload = {
                                name: file.key,
                                customerKey: file.key,
                                assetType: {
                                    name: 'codesnippetblock',
                                    id: 220
                                },
                                content: fileContent,
                                category: {
                                    id: categoryId
                                }
                            };
    
                            var assetUrl = restInstanceUrl + '/asset/v1/content/assets';
                            var assetRequest = new Script.Util.HttpRequest(assetUrl);
                            assetRequest.emptyContentHandling = 0;
                            assetRequest.retries = 2;
                            assetRequest.continueOnError = true;
                            assetRequest.contentType = 'application/json';
                            assetRequest.method = 'POST';
                            assetRequest.setHeader('Authorization', 'Bearer ' + accessToken);
                            assetRequest.postData = Stringify(assetPayload);
    
                            var assetResponse = assetRequest.send();
    Write(Stringify(assetResponse.content))
    Write(Stringify(assetResponse.statusCode))
    
                            if (assetResponse.statusCode == 200 || assetResponse.statusCode == 201) {
                                Write('<div class="progress-item success">');
                                Write('<strong>‚úÖ ' + file.key + '</strong> installed successfully');
                                Write('</div>');
                                successCount++;
                            } else {
                                Write('<div class="progress-item error">');
                                Write('<strong>‚ùå ' + file.key + '</strong> failed to install<br>');
                                Write('Status: ' + assetResponse.statusCode + '<br>');
                                Write('Response: ' + assetResponse.content.substring(0, 200));
                                Write('</div>');
                                failCount++;
                            }
                            }
    
                        } catch (ex) {
                            Write('<div class="progress-item error">');
                            Write('<strong>‚ùå Exception:</strong> ' + (ex.message || ex.toString()));
                            Write('</div>');
                            failCount++;
                        }
                    }
    
                    // Step 4: Create Data Extensions
                    Write('<hr>');
                    Write('<h2>Step 4: Creating Data Extensions</h2>');

                    var deSuccessCount = 0;
                    var deFailCount = 0;

                    try {
                        // Step 4.1: Create Token Cache Data Extension
                        Write('<div class="progress-item info">');
                        Write('<strong>üìã Creating Data Extension 1/3:</strong> OMG_FW_TokenCache...');
                        Write('</div>');

                        var prox = new Script.Util.WSProxy();

                        // Check if Token Cache DE already exists
                        var tokenCacheProps = ["CustomerKey", "Name"];
                        var tokenCacheFilter = {
                            Property: "CustomerKey",
                            SimpleOperator: "equals",
                            Value: "OMG_FW_TokenCache"
                        };

                        var tokenCacheResult = prox.retrieve("DataExtension", tokenCacheProps, tokenCacheFilter);
                        var tokenCacheExists = tokenCacheResult && tokenCacheResult.Results && tokenCacheResult.Results.length > 0;

                        if (tokenCacheExists) {
                            Write('<div class="progress-item info">');
                            Write('<strong>‚ÑπÔ∏è OMG_FW_TokenCache</strong> already exists - skipping creation');
                            Write('</div>');
                            deSuccessCount++;
                        } else {
                            // Create Token Cache Data Extension
                            var tokenCacheConfig = {
                                "CustomerKey": "OMG_FW_TokenCache",
                                "Name": "OMG_FW_TokenCache",
                                "Description": "OmegaFramework OAuth2 token cache for cross-execution token persistence. DO NOT DELETE.",
                                "Fields": [
                                    {
                                        "Name": "CacheKey",
                                        "FieldType": "Text",
                                        "MaxLength": 200,
                                        "IsPrimaryKey": true,
                                        "IsRequired": true
                                    },
                                    {
                                        "Name": "AccessToken",
                                        "FieldType": "Text",
                                        "MaxLength": 500,
                                        "IsRequired": true
                                    },
                                    {
                                        "Name": "TokenType",
                                        "FieldType": "Text",
                                        "MaxLength": 50,
                                        "DefaultValue": "Bearer"
                                    },
                                    {
                                        "Name": "ExpiresIn",
                                        "FieldType": "Number",
                                        "DefaultValue": 3600
                                    },
                                    {
                                        "Name": "ObtainedAt",
                                        "FieldType": "Decimal",
                                        "Precision": 18,
                                        "Scale": 0,
                                        "IsRequired": true
                                    },
                                    {
                                        "Name": "ExpiresAt",
                                        "FieldType": "Decimal",
                                        "Precision": 18,
                                        "Scale": 0,
                                        "IsRequired": true
                                    },
                                    {
                                        "Name": "Scope",
                                        "FieldType": "Text",
                                        "MaxLength": 500
                                    },
                                    {
                                        "Name": "RestInstanceUrl",
                                        "FieldType": "Text",
                                        "MaxLength": 200
                                    },
                                    {
                                        "Name": "SoapInstanceUrl",
                                        "FieldType": "Text",
                                        "MaxLength": 200
                                    },
                                    {
                                        "Name": "UpdatedAt",
                                        "FieldType": "Date"
                                    }
                                ]
                            };

                            var newTokenCacheDE = DataExtension.Add(tokenCacheConfig);

                            Write('<div class="progress-item success">');
                            Write('<strong>‚úÖ OMG_FW_TokenCache</strong> Data Extension created successfully');
                            Write('</div>');
                            deSuccessCount++;
                        }

                    } catch (tokenEx) {
                        Write('<div class="progress-item error">');
                        Write('<strong>‚ùå Failed to create OMG_FW_TokenCache:</strong> ' + (tokenEx.message || tokenEx.toString()));
                        Write('</div>');
                        deFailCount++;
                    }

                    try {
                        // Step 4.2: Create Credentials Data Extension
                        Write('<div class="progress-item info">');
                        Write('<strong>üìã Creating Data Extension 2/3:</strong> OMG_FW_Credentials...');
                        Write('</div>');

                        // Check if Credentials DE already exists
                        var credsProps = ["CustomerKey", "Name"];
                        var credsFilter = {
                            Property: "CustomerKey",
                            SimpleOperator: "equals",
                            Value: "OMG_FW_Credentials"
                        };

                        var credsResult = prox.retrieve("DataExtension", credsProps, credsFilter);
                        var credsExists = credsResult && credsResult.Results && credsResult.Results.length > 0;

                        if (credsExists) {
                            Write('<div class="progress-item info">');
                            Write('<strong>‚ÑπÔ∏è OMG_FW_Credentials</strong> already exists - skipping creation');
                            Write('</div>');
                            deSuccessCount++;
                        } else {
                            // Create Credentials Data Extension
                            var credsConfig = {
                                "CustomerKey": "OMG_FW_Credentials",
                                "Name": "OMG_FW_Credentials",
                                "Description": "OmegaFramework encrypted API credentials storage for multiple platforms. DO NOT DELETE.",
                                "Fields": [
                                    {"Name": "Name", "FieldType": "Text", "MaxLength": 50, "IsPrimaryKey": true, "IsRequired": true},
                                    {"Name": "Description", "FieldType": "Text", "MaxLength": 500},
                                    {"Name": "AuthType", "FieldType": "Text", "MaxLength": 20, "IsRequired": true},
                                    {"Name": "Platform", "FieldType": "Text", "MaxLength": 50, "IsRequired": false},
                                    {"Name": "IsActive", "FieldType": "Boolean", "DefaultValue": "true"},
                                    {"Name": "ClientId", "FieldType": "Text", "MaxLength": 500},
                                    {"Name": "ClientSecret", "FieldType": "Text", "MaxLength": 500},
                                    {"Name": "Username", "FieldType": "Text", "MaxLength": 500},
                                    {"Name": "Password", "FieldType": "Text", "MaxLength": 500},
                                    {"Name": "StaticToken", "FieldType": "Text", "MaxLength": 1000},
                                    {"Name": "ApiKey", "FieldType": "Text", "MaxLength": 500},
                                    {"Name": "ApiSecret", "FieldType": "Text", "MaxLength": 500},
                                    {"Name": "AuthUrl", "FieldType": "Text", "MaxLength": 250},
                                    {"Name": "TokenEndpoint", "FieldType": "Text", "MaxLength": 250},
                                    {"Name": "GrantType", "FieldType": "Text", "MaxLength": 50, "DefaultValue": "client_credentials"},
                                    {"Name": "Scope", "FieldType": "Text", "MaxLength": 500},
                                    {"Name": "BaseUrl", "FieldType": "Text", "MaxLength": 250},
                                    {"Name": "Domain", "FieldType": "Text", "MaxLength": 250},
                                    {"Name": "CustomField1", "FieldType": "Text", "MaxLength": 500},
                                    {"Name": "CustomField2", "FieldType": "Text", "MaxLength": 500},
                                    {"Name": "CustomField3", "FieldType": "Text", "MaxLength": 500},
                                    {"Name": "CreatedAt", "FieldType": "Date"},
                                    {"Name": "UpdatedAt", "FieldType": "Date"},
                                    {"Name": "CreatedBy", "FieldType": "Text", "MaxLength": 100}
                                ]
                            };

                            var newCredsDE = DataExtension.Add(credsConfig);

                            Write('<div class="progress-item success">');
                            Write('<strong>‚úÖ OMG_FW_Credentials</strong> Data Extension created successfully');
                            Write('</div>');
                            deSuccessCount++;
                        }

                    } catch (credsEx) {
                        Write('<div class="progress-item error">');
                        Write('<strong>‚ùå Failed to create OMG_FW_Credentials:</strong> ' + (credsEx.message || credsEx.toString()));
                        Write('</div>');
                        deFailCount++;
                    }

                    try {
                        // Step 4.3: Create Log Data Extension
                        Write('<div class="progress-item info">');
                        Write('<strong>üìã Creating Data Extension 3/3:</strong> OMG_FW_Log...');
                        Write('</div>');

                        // Check if Log DE already exists
                        var logProps = ["CustomerKey", "Name"];
                        var logFilter = {
                            Property: "CustomerKey",
                            SimpleOperator: "equals",
                            Value: "OMG_FW_Log"
                        };

                        var logResult = prox.retrieve("DataExtension", logProps, logFilter);
                        var logExists = logResult && logResult.Results && logResult.Results.length > 0;

                        if (logExists) {
                            Write('<div class="progress-item info">');
                            Write('<strong>‚ÑπÔ∏è OMG_FW_Log</strong> already exists - skipping creation');
                            Write('</div>');
                            deSuccessCount++;
                        } else {
                            // Create Log Data Extension
                            var logConfig = {
                                "CustomerKey": "OMG_FW_Log",
                                "Name": "OMG_FW_Log",
                                "Description": "OmegaFramework generic log storage for API calls, code errors, and execution traces. DO NOT DELETE.",
                                "Fields": [
                                    {
                                        "Name": "LogId",
                                        "FieldType": "Text",
                                        "MaxLength": 50,
                                        "IsPrimaryKey": true,
                                        "IsRequired": true
                                    },
                                    {
                                        "Name": "Timestamp",
                                        "FieldType": "Date",
                                        "IsRequired": true
                                    },
                                    {
                                        "Name": "LogLevel",
                                        "FieldType": "Text",
                                        "MaxLength": 20,
                                        "IsRequired": true,
                                        "DefaultValue": "INFO"
                                    },
                                    {
                                        "Name": "Source",
                                        "FieldType": "Text",
                                        "MaxLength": 100,
                                        "IsRequired": true
                                    },
                                    {
                                        "Name": "Message",
                                        "FieldType": "Text",
                                        "MaxLength": 1000,
                                        "IsRequired": true
                                    },
                                    {
                                        "Name": "ErrorCode",
                                        "FieldType": "Text",
                                        "MaxLength": 50
                                    },
                                    {
                                        "Name": "StackTrace",
                                        "FieldType": "Text",
                                        "MaxLength": 4000
                                    },
                                    {
                                        "Name": "RequestData",
                                        "FieldType": "Text",
                                        "MaxLength": 4000
                                    },
                                    {
                                        "Name": "ResponseData",
                                        "FieldType": "Text",
                                        "MaxLength": 4000
                                    },
                                    {
                                        "Name": "ExecutionTime",
                                        "FieldType": "Number"
                                    }
                                ]
                            };

                            var newLogDE = DataExtension.Add(logConfig);

                            Write('<div class="progress-item success">');
                            Write('<strong>‚úÖ OMG_FW_Log</strong> Data Extension created successfully');
                            Write('</div>');
                            deSuccessCount++;
                        }

                    } catch (logEx) {
                        Write('<div class="progress-item error">');
                        Write('<strong>‚ùå Failed to create OMG_FW_Log:</strong> ' + (logEx.message || logEx.toString()));
                        Write('</div>');
                        deFailCount++;
                    }

                    Write('<hr>');
                    Write('<div class="progress-item success">');
                    Write('<strong>üìã Data Extensions Summary:</strong><br>');
                    Write('- OMG_FW_TokenCache: ' + (deSuccessCount >= 1 ? '‚úÖ Ready' : '‚ùå Failed') + '<br>');
                    Write('- OMG_FW_Credentials: ' + (deSuccessCount >= 2 ? '‚úÖ Ready' : '‚ùå Failed') + '<br>');
                    Write('- OMG_FW_Log: ' + (deSuccessCount >= 3 ? '‚úÖ Ready' : '‚ùå Failed'));
                    Write('</div>');
                    Write('<hr>');

                    // Summary
                    Write('<div class="summary">');
                    Write('<h2>üìä Installation Summary</h2>');
                    Write('<p><strong>Total Content Blocks:</strong> ' + files.length + '</p>');
                    Write('<p><strong style="color: green;">‚úÖ Successful:</strong> ' + successCount + '</p>');
                    Write('<p><strong style="color: red;">‚ùå Failed:</strong> ' + failCount + '</p>');
                    Write('<p><strong>Total Data Extensions:</strong> 3</p>');
                    Write('<p><strong style="color: green;">‚úÖ Successful:</strong> ' + deSuccessCount + '</p>');
                    Write('<p><strong style="color: red;">‚ùå Failed:</strong> ' + deFailCount + '</p>');
    
                    if (failCount == 0 && deFailCount == 0) {
                        Write('<h3 style="color: green;">üéâ INSTALLATION COMPLETED SUCCESSFULLY!</h3>');
                        Write('<p>All Content Blocks and Data Extensions have been installed.</p>');
                        Write('<p><strong>Next steps:</strong></p>');
                        Write('<ol>');
                        Write('<li>Verify Content Blocks in Content Builder ‚Üí Folders: <strong>OmegaFramework/core</strong>, <strong>auth</strong>, <strong>integrations</strong>, <strong>handlers</strong>, and <strong>tests</strong></li>');
                        Write('<li>Verify Data Extensions in Contact Builder ‚Üí Data Extensions: <strong>OMG_FW_TokenCache</strong>, <strong>OMG_FW_Credentials</strong>, and <strong>OMG_FW_Log</strong></li>');
                        Write('<li>Generate and save Platform Variables in SFMC Key Management (Sym_Cred, Salt_Cred, IV_Cred)</li>');
                        Write('<li>Load required modules in your CloudPage: <code>%%=ContentBlockByKey("OMG_FW_ResponseWrapper")=%%</code></li>');
                        Write('<li>Create an integration instance: <code>var sfmc = new SFMCIntegration(config)</code></li>');
                        Write('<li>Run test files to validate installation (check OmegaFramework/tests folder)</li>');
                        Write('<li>Start building with OmegaFramework!</li>');
                        Write('</ol>');
                    } else if (failCount > 0 || deFailCount > 0) {
                        Write('<h3 style="color: orange;">‚ö†Ô∏è INSTALLATION COMPLETED WITH ERRORS</h3>');
                        if (failCount > 0) {
                            Write('<p><strong>Content Blocks:</strong> ' + failCount + ' failed to install. Please review the errors above.</p>');
                        }
                        if (deFailCount > 0) {
                            Write('<p><strong>Data Extensions:</strong> ' + deFailCount + ' failed to create. You may need to create them manually.</p>');
                        }
                        Write('<p><strong>Troubleshooting:</strong></p>');
                        Write('<ul>');
                        Write('<li>Check your API permissions (Read & Write for Content Builder)</li>');
                        Write('<li>Verify you have permission to create Data Extensions</li>');
                        Write('<li>Verify the GitHub repository URL is correct</li>');
                        Write('<li>Try installing failed blocks manually</li>');
                        Write('<li>Run the installer again for failed components</li>');
                        Write('</ul>');
                    } else {
                        Write('<h3 style="color: green;">‚úÖ INSTALLATION COMPLETED</h3>');
                        Write('<p>All components have been installed successfully. Please verify in SFMC.</p>');
                    }
    
                    Write('</div>');
                }
            }
    
        } catch (ex) {
            Write('<div class="progress-item error">');
            Write('<strong>‚ùå Fatal Error:</strong><br>');
            Write(ex.message || ex.toString());
            Write('</div>');
        }
    
        Write('<hr>');
        Write('<p><a href="#" style="color: #0176d3; text-decoration: none; font-weight: bold;">‚Üê Back to Installer</a></p>');
        Write('</div></body></html>');
    
    } else {
        // FRONTEND MODE: Show HTML form
    </script>
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>OmegaFramework v2.0 - Automated Installer</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 1200px;
                margin: 50px auto;
                padding: 20px;
                background-color: #f5f5f5;
            }
            .container {
                background-color: white;
                padding: 30px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            h1 {
                color: #0176d3;
                border-bottom: 3px solid #0176d3;
                padding-bottom: 10px;
            }
            .section {
                margin: 20px 0;
                padding: 15px;
                background-color: #f9f9f9;
                border-left: 4px solid #0176d3;
            }
            .warning {
                background-color: #fff3cd;
                border-left-color: #ffc107;
                color: #856404;
            }
            .success {
                background-color: #d4edda;
                border-left-color: #28a745;
                color: #155724;
            }
            label {
                display: block;
                margin-top: 15px;
                margin-bottom: 5px;
                font-weight: bold;
            }
            input[type="text"], input[type="password"] {
                width: 100%;
                padding: 10px;
                margin: 5px 0;
                border: 1px solid #ddd;
                border-radius: 4px;
                box-sizing: border-box;
            }
            button {
                background-color: #0176d3;
                color: white;
                padding: 12px 30px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
                margin: 10px 5px 10px 0;
            }
            button:hover {
                background-color: #014b87;
            }
            button:disabled {
                background-color: #ccc;
                cursor: not-allowed;
            }
            .file-list {
                list-style-type: none;
                padding: 0;
            }
            .file-list li {
                padding: 8px;
                margin: 5px 0;
                background-color: #f9f9f9;
                border-left: 3px solid #0176d3;
            }
            .platform-vars-panel {
                display: none;
                margin: 20px 0;
                padding: 20px;
                background-color: #e7f3ff;
                border-left: 4px solid #2196F3;
                border-radius: 4px;
            }
            .platform-vars-panel.show {
                display: block;
            }
            .var-item {
                background-color: #fff;
                padding: 15px;
                margin: 10px 0;
                border-radius: 4px;
                border: 1px solid #ccc;
            }
            .var-item h4 {
                margin-top: 0;
                color: #0176d3;
            }
            .var-value {
                font-family: 'Courier New', monospace;
                background-color: #f5f5f5;
                padding: 10px;
                border-radius: 4px;
                word-break: break-all;
                margin: 5px 0;
            }
            .copy-btn {
                background-color: #28a745;
                padding: 5px 15px;
                font-size: 14px;
                margin-left: 10px;
            }
            .copy-btn:hover {
                background-color: #218838;
            }
            #generatePlatformVarsBtn {
                background-color: #ffc107;
                color: #000;
            }
            #generatePlatformVarsBtn:hover {
                background-color: #e0a800;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üöÄ OmegaFramework v2.0 - Automated Installer</h1>
    
            <div class="section warning">
                <h3>‚ö†Ô∏è Important Prerequisites</h3>
                <ul>
                    <li>You need an <strong>Installed Package</strong> in SFMC with API permissions</li>
                    <li>Required permissions: <strong>Read</strong> and <strong>Write</strong> for Content Builder</li>
                    <li>Required permissions: <strong>Create</strong> permission for Data Extensions</li>
                    <li>This installer will create <strong>35 Content Blocks</strong> via REST API (18 source + 17 tests)</li>
                    <li>This installer will create <strong>3 Data Extensions</strong>: <strong>OMG_FW_TokenCache</strong> (for OAuth2 token caching), <strong>OMG_FW_Credentials</strong> (for encrypted credentials), and <strong>OMG_FW_Log</strong> (for generic logging)</li>
                    <li>Installation happens server-side (no CORS issues)</li>
                    <li>Files will be organized in folders: <strong>OmegaFramework/core</strong>, <strong>auth</strong>, <strong>integrations</strong>, <strong>handlers</strong>, and <strong>tests</strong></li>
                </ul>
            </div>

            <div class="section warning">
                <h3>üîë Step 0: Generate Platform Variables (Required)</h3>
                <p>Before installation, you must create 3 Platform Variables in SFMC Key Management for credential encryption:</p>
                <button type="button" id="generatePlatformVarsBtn">Generate Platform Variables</button>
            </div>

            <div id="platformVarsPanel" class="platform-vars-panel">
                <h3>üîê SFMC Platform Variables to Create</h3>
                <p><strong>‚ö†Ô∏è IMPORTANT:</strong> Copy these values and save them in SFMC Setup ‚Üí Platform Tools ‚Üí Key Management <strong>BEFORE</strong> continuing with the installation.</p>

                <div class="var-item">
                    <h4>1. Symmetric Password</h4>
                    <p><strong>Name:</strong> <code>Symmetric_Password_Integration</code></p>
                    <p><strong>External Key:</strong> <code>Sym_Cred</code></p>
                    <p><strong>Type:</strong> Pre-Shared Key</p>
                    <p><strong>Value:</strong></p>
                    <div class="var-value" id="symCredValue">Click "Generate Platform Variables" button</div>
                    <button type="button" class="copy-btn" onclick="copyToClipboard('symCredValue')">Copy</button>
                </div>

                <div class="var-item">
                    <h4>2. Salt</h4>
                    <p><strong>Name:</strong> <code>Salt_Password_Integration</code></p>
                    <p><strong>External Key:</strong> <code>Salt_Cred</code></p>
                    <p><strong>Type:</strong> Salt</p>
                    <p><strong>Value:</strong></p>
                    <div class="var-value" id="saltCredValue">Click "Generate Platform Variables" button</div>
                    <button type="button" class="copy-btn" onclick="copyToClipboard('saltCredValue')">Copy</button>
                </div>

                <div class="var-item">
                    <h4>3. Initialization Vector (IV)</h4>
                    <p><strong>Name:</strong> <code>IV_Password_Integration</code></p>
                    <p><strong>External Key:</strong> <code>IV_Cred</code></p>
                    <p><strong>Type:</strong> Initialization Vector</p>
                    <p><strong>Value:</strong></p>
                    <div class="var-value" id="ivCredValue">Click "Generate Platform Variables" button</div>
                    <button type="button" class="copy-btn" onclick="copyToClipboard('ivCredValue')">Copy</button>
                </div>

                <div class="section warning" style="margin-top: 15px;">
                    <strong>‚ö†Ô∏è WARNING:</strong> These values are randomly generated and cannot be recovered. Make sure to:
                    <ul>
                        <li>Save these values to SFMC Key Management <strong>before closing this page</strong></li>
                        <li>Store a backup copy in a secure location</li>
                        <li>Without these values, you will not be able to decrypt credentials stored in the framework</li>
                    </ul>
                </div>
            </div>

            <form id="installForm" method="POST" action="">
                <input type="hidden" name="install" value="1">

                <div class="section">
                    <h3>Step 1: SFMC Credentials</h3>
                    <p>Enter your SFMC Installed Package credentials:</p>
    
                    <label for="clientId"><strong>Client ID:</strong></label>
                    <input type="text" id="clientId" name="clientId" placeholder="Enter your Client ID" value="zshou8dj8tykbtc58psf1bxq" required>
    
                    <label for="clientSecret"><strong>Client Secret:</strong></label>
                    <input type="password" id="clientSecret" name="clientSecret" placeholder="Enter your Client Secret" value="" required>
    
                    <label for="authBaseUrl"><strong>Auth Base URL:</strong></label>
                    <input type="text" id="authBaseUrl" name="authBaseUrl" placeholder="https://YOUR_SUBDOMAIN.auth.marketingcloudapis.com/" value="https://mcgwsh19xsfbh858gh-fc-cy7-w4.auth.marketingcloudapis.com/" required>
                </div>
    
                <div class="section">
                    <h3>Step 2: GitHub Repository Configuration</h3>
                    <p>Source files will be loaded from GitHub:</p>
    
                    <label for="githubRepo"><strong>GitHub Repository Base URL:</strong></label>
                    <input type="text" id="githubRepo" name="githubRepo" value="https://raw.githubusercontent.com/oskyar/miniframework-ssjs/main/" required>
    
                    <div class="section warning" style="margin-top: 15px;">
                        <strong>Note:</strong> Files will be organized in SFMC into: core/, handlers/, creators/, and tests/ folders.
                    </div>
                </div>
    
                <div class="section">
                    <h3>Step 3: Content Blocks to Install</h3>
                    <p>The following 35 Content Blocks will be created:</p>

                    <h4 style="margin-top: 20px; color: #0176d3;">üì¶ Core Modules (5 blocks) ‚Üí OmegaFramework/core</h4>
                    <ul class="file-list">
                        <li><strong>OMG_FW_OmegaFramework</strong> - Module Loader with declarative registration (NEW)</li>
                        <li><strong>OMG_FW_ResponseWrapper</strong> - Standardized response handling</li>
                        <li><strong>OMG_FW_ConnectionHandler</strong> - HTTP requests with retry logic</li>
                        <li><strong>OMG_FW_DataExtensionTokenCache</strong> - Persistent token caching</li>
                        <li><strong>OMG_FW_CredentialStore</strong> - Encrypted credential storage and retrieval</li>
                    </ul>

                    <h4 style="margin-top: 20px; color: #6f42c1;">üîê Auth Strategies (3 blocks) ‚Üí OmegaFramework/auth</h4>
                    <ul class="file-list">
                        <li><strong>OMG_FW_BasicAuthStrategy</strong> - HTTP Basic authentication</li>
                        <li><strong>OMG_FW_BearerAuthStrategy</strong> - Bearer token authentication</li>
                        <li><strong>OMG_FW_OAuth2AuthStrategy</strong> - OAuth2 client credentials flow</li>
                    </ul>

                    <h4 style="margin-top: 20px; color: #17a2b8;">üîó Integrations (5 blocks) ‚Üí OmegaFramework/integrations</h4>
                    <ul class="file-list">
                        <li><strong>OMG_FW_BaseIntegration</strong> - Base class for all integrations</li>
                        <li><strong>OMG_FW_SFMCIntegration</strong> - Salesforce Marketing Cloud integration</li>
                        <li><strong>OMG_FW_DataCloudIntegration</strong> - Salesforce Data Cloud integration</li>
                        <li><strong>OMG_FW_VeevaCRMIntegration</strong> - Veeva CRM integration</li>
                        <li><strong>OMG_FW_VeevaVaultIntegration</strong> - Veeva Vault integration</li>
                    </ul>

                    <h4 style="margin-top: 20px; color: #28a745;">üîß Handlers (5 blocks) ‚Üí OmegaFramework/handlers</h4>
                    <ul class="file-list">
                        <li><strong>OMG_FW_AssetHandler</strong> - Content Builder asset management</li>
                        <li><strong>OMG_FW_DataExtensionHandler</strong> - Data Extension operations</li>
                        <li><strong>OMG_FW_EmailHandler</strong> - Email and template management</li>
                        <li><strong>OMG_FW_FolderHandler</strong> - Folder structure management</li>
                        <li><strong>OMG_FW_JourneyHandler</strong> - Journey Builder operations</li>
                    </ul>

                    <h4 style="margin-top: 20px; color: #28a745;">üß™ Test Suites (17 blocks) ‚Üí OmegaFramework/tests/</h4>
                    <ul class="file-list">
                        <li><strong>Core Tests (4):</strong> ResponseWrapper, ConnectionHandler, DataExtensionTokenCache, CredentialStore</li>
                        <li><strong>Auth Tests (3):</strong> BasicAuthStrategy, BearerAuthStrategy, OAuth2AuthStrategy</li>
                        <li><strong>Handler Tests (5):</strong> AssetHandler, DataExtensionHandler, EmailHandler, FolderHandler, JourneyHandler</li>
                        <li><strong>Integration Tests (5):</strong> BaseIntegration, SFMCIntegration, DataCloudIntegration, VeevaCRMIntegration, VeevaVaultIntegration</li>
                    </ul>

                    <p style="margin-top: 20px;"><strong>Total: 35 Content Blocks (18 source + 17 tests)</strong></p>
                </div>

                <div class="section">
                    <h3>Step 4: Data Extensions to Create</h3>
                    <p>The following 3 Data Extensions will be created in Contact Builder:</p>

                    <h4 style="margin-top: 20px; color: #0176d3;">üìã Data Extensions (3)</h4>
                    <ul class="file-list">
                        <li><strong>OMG_FW_TokenCache</strong> - OAuth2 token persistent storage
                            <br><small style="color: #666;">Fields: CacheKey (PK), AccessToken, TokenType, ExpiresIn, ObtainedAt, Scope, RestInstanceUrl, SoapInstanceUrl, UpdatedAt</small>
                        </li>
                        <li><strong>OMG_FW_Credentials</strong> - Encrypted API credentials storage for multiple platforms
                            <br><small style="color: #666;">Fields: Name (PK), Description, AuthType, Platform, IsActive, ClientId, ClientSecret, Username, Password, StaticToken, ApiKey, ApiSecret, AuthUrl, TokenEndpoint, GrantType, Scope, BaseUrl, Domain, CustomFields, CreatedAt, UpdatedAt, CreatedBy</small>
                        </li>
                        <li><strong>OMG_FW_Log</strong> - Generic logging for API calls, errors, and execution traces
                            <br><small style="color: #666;">Fields: LogId (PK), Timestamp, LogLevel, Source, Message, ErrorCode, StackTrace, RequestData, ResponseData, ExecutionTime</small>
                        </li>
                    </ul>

                    <div class="section warning" style="margin-top: 15px;">
                        <strong>Note:</strong> If these Data Extensions already exist, they will be skipped. The installer will not overwrite existing Data Extensions.
                    </div>
                </div>

                <div class="section">
                    <button type="submit">üöÄ Start Installation</button>
                </div>
            </form>
    
            <div class="section success">
                <h3>‚úÖ What This Installer Does</h3>
                <ol>
                    <li>Authenticates with SFMC using your credentials (OAuth2)</li>
                    <li>Creates folder structure in Content Builder (core, auth, integrations, handlers, tests)</li>
                    <li>Fetches each file from GitHub (server-side, no CORS)</li>
                    <li>Creates 34 Content Blocks via REST API (organized in folders)</li>
                    <li>Creates 3 Data Extensions via SOAP API (OMG_FW_TokenCache, OMG_FW_Credentials, and OMG_FW_Log)</li>
                    <li>Shows real-time progress for each step</li>
                    <li>Displays detailed success/error report</li>
                </ol>
                <p style="margin-top: 15px;"><strong>Note:</strong> The installer will skip existing folders, Content Blocks, and Data Extensions to allow safe re-runs.</p>
            </div>
        </div>
    
        %%=Concat('<sc', 'ript>')=%%
            /**
             * Generates a random password with mixed case, numbers, and punctuation
             * @param {number} len - Length of password to generate
             * @returns {string} Generated password
             */
            function createPassword(len) {
                var length = (len) ? (len) : (10);
                var string = "abcdefghijklmnopqrstuvwxyz";
                var numeric = '0123456789';
                var punctuation = '!#$^&%@*';
                var password = "";
                var character = "";
                while (password.length < length) {
                    entity1 = Math.ceil(string.length * Math.random() * Math.random());
                    entity2 = Math.ceil(numeric.length * Math.random() * Math.random());
                    entity3 = Math.ceil(punctuation.length * Math.random() * Math.random());
                    hold = string.charAt(entity1);
                    hold = (password.length % 2 == 0) ? (hold.toUpperCase()) : (hold);
                    character += hold;
                    character += numeric.charAt(entity2);
                    character += punctuation.charAt(entity3);
                    password = character;
                }
                password = password.split('').sort(function() { return 0.5 - Math.random() }).join('');
                return password.substring(0, len);
            }

            /**
             * Generates random bytes using random.org API
             * @param {number} len - Number of bytes to generate
             * @param {string} format - Format (h=hex, f=base64, d=decimal)
             * @returns {string} Random bytes in specified format
             */
            function createRandomBytes(len, format) {
                var format = format || "h";
                try {
                    var xhr = new XMLHttpRequest();
                    xhr.open('GET', "https://www.random.org/cgi-bin/randbyte?nbytes=" + len + "&format=" + format, false);
                    xhr.send();
                    if (xhr.status === 200) {
                        return xhr.responseText.replace(" \n", "").replace(/^\s+|\s+$/g, '');
                    } else {
                        // Fallback to client-side generation if random.org fails
                        var result = '';
                        for (var i = 0; i < len * 2; i++) {
                            result += Math.floor(Math.random() * 16).toString(16);
                        }
                        return result.substring(0, len * 2);
                    }
                } catch (e) {
                    // Fallback to client-side generation
                    var result = '';
                    for (var i = 0; i < len * 2; i++) {
                        result += Math.floor(Math.random() * 16).toString(16);
                    }
                    return result.substring(0, len * 2);
                }
            }

            /**
             * Copy text to clipboard
             * @param {string} elementId - ID of element containing text to copy
             */
            function copyToClipboard(elementId) {
                var element = document.getElementById(elementId);
                var text = element.textContent || element.innerText;

                // Create temporary textarea
                var textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);

                // Select and copy
                textarea.select();
                try {
                    document.execCommand('copy');
                    alert('Copied to clipboard!');
                } catch (err) {
                    alert('Failed to copy. Please copy manually.');
                }

                document.body.removeChild(textarea);
            }

            // Generate Platform Variables button handler
            document.getElementById('generatePlatformVarsBtn').addEventListener('click', function() {
                // Generate values
                var symCred = createPassword(24);
                var saltCred = createRandomBytes(8);
                var ivCred = createRandomBytes(16);

                // Update DOM
                document.getElementById('symCredValue').textContent = symCred;
                document.getElementById('saltCredValue').textContent = saltCred;
                document.getElementById('ivCredValue').textContent = ivCred;

                // Show panel
                document.getElementById('platformVarsPanel').classList.add('show');

                // Scroll to panel
                document.getElementById('platformVarsPanel').scrollIntoView({ behavior: 'smooth', block: 'start' });
            });

            // Simple form validation
            document.getElementById('installForm').addEventListener('submit', function(e) {
                var clientId = document.getElementById('clientId').value;
                var clientSecret = document.getElementById('clientSecret').value;
                var authBaseUrl = document.getElementById('authBaseUrl').value;
                var githubRepo = document.getElementById('githubRepo').value;

                if (!clientId || !clientSecret || !authBaseUrl || !githubRepo) {
                    e.preventDefault();
                    alert('Please fill in all required fields');
                    return false;
                }

                // Confirm before starting
                if (!confirm('Ready to install OmegaFramework v2.0?\n\n‚Ä¢ 34 Content Blocks (17 source + 17 tests)\n‚Ä¢ 3 Data Extensions (TokenCache + Credentials + Log)\n\nThis will take a few minutes.\n\nClick OK to proceed.')) {
                    e.preventDefault();
                    return false;
                }

                // Show loading message
                var button = this.querySelector('button[type="submit"]');
                button.disabled = true;
                button.textContent = '‚è≥ Installing... Please wait...';
            });
        %%=Concat('</sc', 'ript>')=%%
    </body>
    </html>
    <script runat="server">
    }
    }catch(ex){
        Write(Stringify(ex))
    }
    
    </script>
    