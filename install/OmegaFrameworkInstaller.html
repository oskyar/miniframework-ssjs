<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmegaFramework Installer v1.1</title>
    <style>
        * {margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
        .container{background:white;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);max-width:900px;width:100%;overflow:hidden}
        .header{background:linear-gradient(135deg,#0176d3 0%,#0056a3 100%);color:white;padding:40px;text-align:center}
        .header h1{font-size:2.5em;margin-bottom:10px}
        .header p{font-size:1.1em;opacity:0.9}
        .content{padding:40px}
        .step{margin-bottom:30px;padding:20px;background:#f8f9fa;border-left:4px solid #0176d3;border-radius:5px}
        .step h3{color:#0176d3;margin-bottom:15px}
        .form-group{margin-bottom:20px}
        label{display:block;margin-bottom:8px;font-weight:600;color:#333}
        input[type="text"],input[type="url"]{width:100%;padding:12px 15px;border:2px solid #e0e0e0;border-radius:8px;font-size:1em}
        input:focus{outline:none;border-color:#0176d3}
        .help-text{font-size:0.85em;color:#666;margin-top:5px}
        button{padding:12px 30px;border:none;border-radius:8px;font-size:1em;font-weight:600;cursor:pointer;margin:5px}
        .btn-primary{background:#0176d3;color:white}
        .btn-primary:hover{background:#0056a3}
        .alert{padding:15px;border-radius:8px;margin-bottom:20px}
        .alert-info{background:#d1ecf1;border:1px solid #bee5eb;color:#0c5460}
        .alert-success{background:#d4edda;border:1px solid #c3e6cb;color:#155724}
        .alert-danger{background:#f8d7da;border:1px solid #f5c6cb;color:#721c24}
        .log{background:#2d2d2d;color:#f8f8f2;padding:15px;border-radius:8px;max-height:400px;overflow-y:auto;font-family:'Courier New',monospace;font-size:0.9em}
        .log-entry{padding:3px 0}
        .log-success{color:#28a745}
        .log-error{color:#dc3545}
        .log-info{color:#17a2b8}
        .checkbox{display:flex;align-items:center;margin:15px 0}
        .checkbox input{width:auto;margin-right:10px}
        pre{background:#2d2d2d;color:#f8f8f2;padding:15px;border-radius:5px;overflow-x:auto;font-size:0.9em}
    </style>
</head>
<body>

<script runat="server">
Platform.Load("core","1.1.1");

var installAction = Platform.Request.GetFormField("install");
var isInstalling = (installAction === "true");
var installationResults = null;

if (isInstalling) {
    // Get form data
    var clientId = Platform.Request.GetFormField("clientId");
    var clientSecret = Platform.Request.GetFormField("clientSecret");
    var authBaseUrl = Platform.Request.GetFormField("authBaseUrl");
    var githubRepo = Platform.Request.GetFormField("githubRepo") || "";
    var installOptional = (Platform.Request.GetFormField("installOptional") === "true");

    // Configuration
    var config = {
        clientId: clientId,
        clientSecret: clientSecret,
        authBaseUrl: authBaseUrl,
        githubRepo: githubRepo,
        installOptional: installOptional
    };

    // Run installation
    installationResults = runInstallation(config);
}

/**
 * Main installation function
 */
function runInstallation(config) {
    var results = {
        success: true,
        steps: [],
        errors: [],
        installed: 0,
        skipped: 0
    };

    try {
        // Step 1: Get Auth Token
        results.steps.push("üîê Obteniendo token de autenticaci√≥n...");
        var authResult = getAuthToken(config);

        if (!authResult.success) {
            results.success = false;
            results.errors.push("Error de autenticaci√≥n: " + authResult.error);
            return results;
        }

        results.steps.push("‚úÖ Token obtenido correctamente");

        var token = authResult.token;
        var restUrl = authResult.restUrl;

        // Step 2: Create Folder
        results.steps.push("üìÅ Creando carpeta OmegaFramework...");
        var folderResult = createFolder(token, restUrl);

        if (folderResult.success) {
            results.steps.push("‚úÖ Carpeta creada: ID " + folderResult.folderId);
        } else {
            results.steps.push("‚ö†Ô∏è Usando carpeta ra√≠z (ID: 0)");
        }

        var folderId = folderResult.folderId || 0;

        // Step 3: Install Content Blocks
        results.steps.push("üì¶ Instalando Content Blocks...");

        var blocks = getContentBlocksList(config.installOptional);

        for (var i = 0; i < blocks.length; i++) {
            var block = blocks[i];
            var blockResult = createContentBlock(block, folderId, token, restUrl, config.githubRepo);

            if (blockResult.success) {
                if (blockResult.skipped) {
                    results.steps.push("‚è≠Ô∏è " + block.name + " (ya existe)");
                    results.skipped++;
                } else {
                    results.steps.push("‚úÖ " + block.name + " (" + blockResult.source + ")");
                    results.installed++;
                }
            } else {
                results.errors.push("‚ùå " + block.name + ": " + blockResult.error);
                if (block.required) {
                    results.success = false;
                }
            }
        }

        results.steps.push("üéâ Instalaci√≥n completada: " + results.installed + " instalados, " + results.skipped + " omitidos");

    } catch (ex) {
        results.success = false;
        results.errors.push("Excepci√≥n: " + ex.message);
    }

    return results;
}

/**
 * Get authentication token
 */
function getAuthToken(config) {
    try {
        var tokenUrl = config.authBaseUrl + "v2/token";
        var payload = {
            grant_type: "client_credentials",
            client_id: config.clientId,
            client_secret: config.clientSecret
        };

        var req = new Script.Util.HttpRequest(tokenUrl);
        req.method = "POST";
        req.contentType = "application/json";
        req.postData = Stringify(payload);
        var res = req.send();

        if (res.statusCode == 200) {
            var data = Platform.Function.ParseJSON(res.content);
            return {
                success: true,
                token: data.access_token,
                restUrl: data.rest_instance_url
            };
        } else {
            return {
                success: false,
                error: "Status " + res.statusCode + ": " + res.content
            };
        }
    } catch (ex) {
        return {
            success: false,
            error: ex.message || ex.toString()
        };
    }
}

/**
 * Create folder
 */
function createFolder(token, restUrl) {
    try {
        var url = restUrl + "/asset/v1/content/categories";
        var payload = {name: "OmegaFramework", parentId: 0};

        var req = new Script.Util.HttpRequest(url);
        req.method = "POST";
        req.contentType = "application/json";
        req.setHeader("Authorization", "Bearer " + token);
        req.postData = Stringify(payload);
        var res = req.send();

        if (res.statusCode == 201 || res.statusCode == 200) {
            var data = Platform.Function.ParseJSON(res.content);
            return {success: true, folderId: data.id};
        } else {
            return {success: false, error: "Status " + res.statusCode};
        }
    } catch (ex) {
        return {success: false, error: ex.message};
    }
}

/**
 * Create content block
 */
function createContentBlock(block, folderId, token, restUrl, githubRepo) {
    try {
        // Load content
        var content = loadContent(block.file, githubRepo);
        if (!content.success) {
            return {success: false, error: "No se pudo cargar el contenido"};
        }

        var url = restUrl + "/asset/v1/content/assets";
        var payload = {
            name: block.name,
            customerKey: block.key,
            assetType: {name: "codesnippetblock", id: 220},
            content: content.data,
            category: {id: folderId}
        };

        var req = new Script.Util.HttpRequest(url);
        req.method = "POST";
        req.contentType = "application/json";
        req.setHeader("Authorization", "Bearer " + token);
        req.postData = Stringify(payload);
        var res = req.send();

        if (res.statusCode == 201 || res.statusCode == 200) {
            return {success: true, source: content.source};
        } else if (res.statusCode == 400 || res.statusCode == 409) {
            return {success: true, skipped: true};
        } else {
            return {success: false, error: "Status " + res.statusCode};
        }
    } catch (ex) {
        return {success: false, error: ex.message};
    }
}

/**
 * Load content from GitHub or embedded
 */
function loadContent(file, githubRepo) {
    // Try GitHub first
    if (githubRepo && githubRepo !== "") {
        try {
            var url = githubRepo + file;
            var req = new Script.Util.HttpRequest(url);
            req.method = "GET";
            var res = req.send();

            if (res.statusCode == 200 && res.content) {
                return {success: true, data: res.content, source: "GitHub"};
            }
        } catch (ex) {
            // Continue to embedded
        }
    }

    // Use embedded content
    var embeddedContent = getEmbeddedContent(file);
    if (embeddedContent) {
        return {success: true, data: embeddedContent, source: "embebido"};
    }

    return {success: false};
}

/**
 * Get embedded content (fallback)
 */
function getEmbeddedContent(file) {
    // For this example, return placeholder
    // In production, you would embed the actual file contents here
    return '<script runat="server">\n// ' + file + '\n// Contenido del archivo aqu√≠\n</script>';
}

/**
 * Get list of content blocks to install
 */
function getContentBlocksList(includeOptional) {
    var blocks = [
        {name:"ResponseWrapper", key:"OMG_FW_ResponseWrapper", file:"src/ResponseWrapper.ssjs", required:true},
        {name:"Settings", key:"OMG_FW_Settings", file:"src/Settings.ssjs", required:true},
        {name:"AuthHandler", key:"OMG_FW_AuthHandler", file:"src/AuthHandler.ssjs", required:true},
        {name:"ConnectionHandler", key:"OMG_FW_ConnectionHandler", file:"src/ConnectionHandler.ssjs", required:true},
        {name:"Core", key:"OMG_FW_Core", file:"src/Core.ssjs", required:true},
        {name:"EmailHandler", key:"OMG_FW_EmailHandler", file:"src/EmailHandler.ssjs", required:false},
        {name:"DataExtensionHandler", key:"OMG_FW_DataExtensionHandler", file:"src/DataExtensionHandler.ssjs", required:false},
        {name:"AssetHandler", key:"OMG_FW_AssetHandler", file:"src/AssetHandler.ssjs", required:false},
        {name:"FolderHandler", key:"OMG_FW_FolderHandler", file:"src/FolderHandler.ssjs", required:false},
        {name:"LogHandler", key:"OMG_FW_LogHandler", file:"src/LogHandler.ssjs", required:false}
    ];

    if (includeOptional) {
        blocks.push({name:"AssetCreator", key:"OMG_FW_AssetCreator", file:"src/AssetCreator.ssjs", required:false});
        blocks.push({name:"JourneyCreator", key:"OMG_FW_JourneyCreator", file:"src/JourneyCreator.ssjs", required:false});
    }

    return blocks;
}

</script>

<div class="container">
    <div class="header">
        <h1>üöÄ OmegaFramework</h1>
        <p>Quick Installer v1.1.0 - Instalaci√≥n Autom√°tica</p>
    </div>

    <div class="content">
        %%[ IF @installAction == "true" THEN ]%%

            <script runat="server">
            if (installationResults) {
                if (installationResults.success) {
                    Write('<div class="alert alert-success">');
                    Write('<strong>‚úÖ Instalaci√≥n Completada</strong><br>');
                    Write('OmegaFramework v1.1 ha sido instalado correctamente.');
                    Write('</div>');
                } else {
                    Write('<div class="alert alert-danger">');
                    Write('<strong>‚ùå Instalaci√≥n con Errores</strong><br>');
                    Write('Algunos componentes no pudieron ser instalados.');
                    Write('</div>');
                }

                Write('<div class="step">');
                Write('<h3>üìã Registro de Instalaci√≥n</h3>');
                Write('<div class="log">');

                for (var i = 0; i < installationResults.steps.length; i++) {
                    Write('<div class="log-entry">' + installationResults.steps[i] + '</div>');
                }

                if (installationResults.errors.length > 0) {
                    for (var j = 0; j < installationResults.errors.length; j++) {
                        Write('<div class="log-entry log-error">' + installationResults.errors[j] + '</div>');
                    }
                }

                Write('</div>');
                Write('</div>');

                if (installationResults.success) {
                    Write('<div class="step">');
                    Write('<h3>üéâ ¬°Felicidades!</h3>');
                    Write('<p>Los siguientes Content Blocks han sido creados en tu instancia de SFMC:</p>');
                    Write('<ul style="margin-left:20px;margin-top:10px">');
                    Write('<li>OMG_FW_Core - Wrapper principal</li>');
                    Write('<li>OMG_FW_Settings - Configuraci√≥n</li>');
                    Write('<li>OMG_FW_ResponseWrapper - Base</li>');
                    Write('<li>OMG_FW_AuthHandler - Autenticaci√≥n</li>');
                    Write('<li>OMG_FW_ConnectionHandler - HTTP</li>');
                    Write('<li>Y ' + (installationResults.installed - 5) + ' handlers adicionales</li>');
                    Write('</ul>');
                    Write('</div>');

                    Write('<div class="step">');
                    Write('<h3>üìñ Ejemplo de Uso</h3>');
                    Write('<pre>');
                    Write('%%=ContentBlockByKey("OMG_FW_Core")=%%\n');
                    Write('<script runat="server">\n\n');
                    Write('// Configurar el framework\n');
                    Write('OmegaFramework.configure({\n');
                    Write('    auth: {\n');
                    Write('        clientId: "' + config.clientId + '",\n');
                    Write('        clientSecret: "' + config.clientSecret + '",\n');
                    Write('        authBaseUrl: "' + config.authBaseUrl + '"\n');
                    Write('    }\n');
                    Write('});\n\n');
                    Write('// Cargar y usar un handler\n');
                    Write('OmegaFramework.load("EmailHandler");\n');
                    Write('var emailHandler = new EmailHandler();\n');
                    Write('var result = emailHandler.list();\n\n');
                    Write('Write("Framework version: " + OmegaFramework.getInfo().version);\n\n');
                    Write('<' + '/script>');
                    Write('</pre>');
                    Write('</div>');
                }

                Write('<button type="button" class="btn-primary" onclick="window.location.reload()">Nueva Instalaci√≥n</button>');
            }
            </script>

        %%[ ELSE ]%%

            <form method="post" id="installerForm">

                <div class="alert alert-info">
                    <strong>üì¶ Instalaci√≥n Autom√°tica</strong><br>
                    Este instalador crear√° autom√°ticamente todos los Content Blocks de OmegaFramework v1.1 en tu instancia de Salesforce Marketing Cloud.
                </div>

                <div class="step">
                    <h3>üîë Credenciales de API</h3>

                    <div class="form-group">
                        <label for="clientId">Client ID *</label>
                        <input type="text" id="clientId" name="clientId" required>
                        <div class="help-text">Client ID de tu Installed Package</div>
                    </div>

                    <div class="form-group">
                        <label for="clientSecret">Client Secret *</label>
                        <input type="text" id="clientSecret" name="clientSecret" required>
                        <div class="help-text">Client Secret de tu Installed Package</div>
                    </div>

                    <div class="form-group">
                        <label for="authBaseUrl">Auth Base URL *</label>
                        <input type="url" id="authBaseUrl" name="authBaseUrl" required>
                        <div class="help-text">Ejemplo: https://YOUR_SUBDOMAIN.auth.marketingcloudapis.com/</div>
                    </div>
                </div>

                <div class="step">
                    <h3>‚öôÔ∏è Opciones Avanzadas</h3>

                    <div class="form-group">
                        <label for="githubRepo">Repositorio GitHub (opcional)</label>
                        <input type="url" id="githubRepo" name="githubRepo"
                               placeholder="https://raw.githubusercontent.com/USER/REPO/main/">
                        <div class="help-text">Si vac√≠o, se usar√° c√≥digo embebido</div>
                    </div>

                    <div class="checkbox">
                        <input type="checkbox" id="installOptional" name="installOptional" value="true">
                        <label for="installOptional">Instalar m√≥dulos opcionales (AssetCreator, JourneyCreator)</label>
                    </div>
                </div>

                <input type="hidden" name="install" value="true">
                <button type="submit" class="btn-primary">üöÄ Iniciar Instalaci√≥n</button>
            </form>

        %%[ ENDIF ]%%

    </div>
</div>

</body>
</html>
