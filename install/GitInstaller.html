<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniFramework - Git Installer</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #0176d3;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            background: #0176d3;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #014486;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        pre {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .progress {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            margin: 20px 0;
            overflow: hidden;
        }
        .progress-bar {
            background: #28a745;
            height: 100%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <script runat="server">
        Platform.Load("core", "1.1.1");
        
        function GitInstaller() {
            var baseUrl = "https://raw.githubusercontent.com/oskyar/miniframework-ssjs/main/src/";
            
            // Content Blocks to install with their GitHub paths
            var contentBlocks = [
                {
                    name: "MF_ResponseWrapper",
                    url: baseUrl + "ResponseWrapper.ssjs",
                    description: "Standard response wrapper for all handlers"
                },
                {
                    name: "MF_AuthHandler", 
                    url: baseUrl + "AuthHandler.ssjs",
                    description: "Authentication handler for SFMC REST API"
                },
                {
                    name: "MF_ConnectionHandler",
                    url: baseUrl + "ConnectionHandler.ssjs",
                    description: "HTTP connection handler with retry logic"
                },
                {
                    name: "MF_DataExtensionHandler",
                    url: baseUrl + "DataExtensionHandler.ssjs",
                    description: "Data Extension management (CRUD operations)"
                },
                {
                    name: "MF_EmailHandler",
                    url: baseUrl + "EmailHandler.ssjs", 
                    description: "Email management (CRUD operations)"
                },
                {
                    name: "MF_AssetHandler",
                    url: baseUrl + "AssetHandler.ssjs",
                    description: "Asset management for Content Builder"
                },
                {
                    name: "MF_FolderHandler",
                    url: baseUrl + "FolderHandler.ssjs",
                    description: "Folder management for organization"
                },
                {
                    name: "MF_LogHandler",
                    url: baseUrl + "LogHandler.ssjs",
                    description: "Logging with multi-destination support"
                },
                {
                    name: "MF_AssetCreator",
                    url: baseUrl + "AssetCreator.ssjs",
                    description: "Creates Data Extensions and Templates"
                }
            ];
            
            function getAuthToken(authConfig) {
                try {
                    var tokenUrl = authConfig.authBaseUrl + "v2/token";
                    var tokenPayload = {
                        "grant_type": "client_credentials",
                        "client_id": authConfig.clientId,
                        "client_secret": authConfig.clientSecret
                    };
                    
                    var request = new Script.Util.HttpRequest(tokenUrl);
                    request.emptyContentHandling = 0;
                    request.retries = 2;
                    request.continueOnError = true;
                    request.contentType = "application/json";
                    request.method = "POST";
                    request.postData = Stringify(tokenPayload);
                    
                    var response = request.send();
                    
                    if (response.statusCode == 200) {
                        var tokenData = Platform.Function.ParseJSON(response.content);
                        return {
                            success: true,
                            accessToken: tokenData.access_token,
                            restUrl: tokenData.rest_instance_url
                        };
                    } else {
                        return {
                            success: false,
                            error: "Authentication failed: " + response.statusCode + " - " + response.content
                        };
                    }
                } catch (ex) {
                    return {
                        success: false,
                        error: "Auth exception: " + ex.message
                    };
                }
            }
            
            function fetchFromGit(url) {
                try {
                    var request = new Script.Util.HttpRequest(url);
                    request.emptyContentHandling = 0;
                    request.retries = 2;
                    request.continueOnError = true;
                    request.method = "GET";
                    
                    var response = request.send();
                    
                    if (response.statusCode == 200) {
                        return {
                            success: true,
                            content: response.content
                        };
                    } else {
                        return {
                            success: false,
                            error: "Failed to fetch from Git: " + response.statusCode
                        };
                    }
                } catch (ex) {
                    return {
                        success: false,
                        error: "Git fetch exception: " + ex.message
                    };
                }
            }
            
            function createContentBlock(authConfig, blockName, blockDescription, sourceCode) {
                try {
                    var authResult = getAuthToken(authConfig);
                    if (!authResult.success) {
                        return authResult;
                    }
                    
                    var createUrl = authResult.restUrl + "/asset/v1/content/assets";
                    var payload = {
                        "name": blockName,
                        "assetType": {
                            "name": "codesnippetblock",
                            "id": 220
                        },
                        "content": sourceCode,
                        "meta": {
                            "framework": "MiniFramework",
                            "version": "1.0.0",
                            "description": blockDescription
                        }
                    };
                    
                    var request = new Script.Util.HttpRequest(createUrl);
                    request.emptyContentHandling = 0;
                    request.retries = 1;
                    request.continueOnError = true;
                    request.contentType = "application/json";
                    request.method = "POST";
                    request.setHeader("Authorization", "Bearer " + authResult.accessToken);
                    request.postData = Stringify(payload);
                    
                    var response = request.send();
                    
                    if (response.statusCode >= 200 && response.statusCode < 300) {
                        var responseData = Platform.Function.ParseJSON(response.content);
                        return {
                            success: true,
                            id: responseData.id,
                            name: responseData.name
                        };
                    } else {
                        return {
                            success: false,
                            error: "Create failed: " + response.statusCode + " - " + response.content
                        };
                    }
                } catch (ex) {
                    return {
                        success: false,
                        error: "Create exception: " + ex.message
                    };
                }
            }
            
            function installFromGit(authConfig) {
                var results = {
                    timestamp: new Date().toISOString(),
                    success: false,
                    created: [],
                    errors: [],
                    progress: []
                };
                
                try {
                    // Test authentication first
                    var authTest = getAuthToken(authConfig);
                    if (!authTest.success) {
                        results.errors.push("Authentication failed: " + authTest.error);
                        return results;
                    }
                    results.progress.push("Authentication successful");
                    
                    // Install each Content Block
                    var createdCount = 0;
                    for (var i = 0; i < contentBlocks.length; i++) {
                        var block = contentBlocks[i];
                        results.progress.push("Processing " + block.name + "...");
                        
                        // Fetch source code from Git
                        var fetchResult = fetchFromGit(block.url);
                        if (!fetchResult.success) {
                            results.errors.push(block.name + ": " + fetchResult.error);
                            continue;
                        }
                        results.progress.push("Fetched " + block.name + " from Git");
                        
                        // Create Content Block
                        var createResult = createContentBlock(authConfig, block.name, block.description, fetchResult.content);
                        if (createResult.success) {
                            results.created.push({
                                name: block.name,
                                id: createResult.id
                            });
                            createdCount++;
                            results.progress.push("Created " + block.name + " successfully");
                        } else {
                            results.errors.push(block.name + ": " + createResult.error);
                        }
                    }
                    
                    results.success = createdCount > 0;
                    results.summary = "Created " + createdCount + " of " + contentBlocks.length + " Content Blocks";
                    
                } catch (ex) {
                    results.errors.push("Installation exception: " + ex.message);
                }
                
                return results;
            }
            
            return {
                install: installFromGit,
                getContentBlocks: function() { return contentBlocks; }
            };
        }
        
        // Handle form submission
        var action = Platform.Request.GetFormField("action");
        var clientId = Platform.Request.GetFormField("clientId");
        var clientSecret = Platform.Request.GetFormField("clientSecret");
        var authBaseUrl = Platform.Request.GetFormField("authBaseUrl");
        var gitBaseUrl = Platform.Request.GetFormField("gitBaseUrl");
        
        if (action === "install" && clientId && clientSecret && authBaseUrl) {
            var authConfig = {
                clientId: clientId,
                clientSecret: clientSecret,
                authBaseUrl: authBaseUrl
            };
            
            // Update base URL if provided
            if (gitBaseUrl) {
                // Custom Git URL logic would go here
            }
            
            var installer = new GitInstaller();
            var result = installer.install(authConfig);
            
            Variable.SetValue("@installResult", Stringify(result, null, 2));
        }
    </script>

    <div class="container">
        <h1>üöÄ MiniFramework - Git Installer</h1>
        
        <div class="info">
            <h3>üìã Instalaci√≥n directa desde GitHub</h3>
            <p>Este instalador descarga los Content Blocks directamente desde GitHub y los crea en tu SFMC.</p>
            <p><strong>Componentes a instalar:</strong></p>
            <ul>
                <li>9 Content Blocks del framework</li>
                <li>Descarga autom√°tica desde repositorio Git</li>
                <li>Sin c√≥digo embebido - siempre la √∫ltima versi√≥n</li>
            </ul>
        </div>

        <form method="POST">
            <div class="form-group">
                <label for="clientId">Client ID *</label>
                <input type="text" id="clientId" name="clientId" required placeholder="Tu Client ID de SFMC">
            </div>
            
            <div class="form-group">
                <label for="clientSecret">Client Secret *</label>
                <input type="password" id="clientSecret" name="clientSecret" required placeholder="Tu Client Secret">
            </div>
            
            <div class="form-group">
                <label for="authBaseUrl">Auth Base URL *</label>
                <input type="text" id="authBaseUrl" name="authBaseUrl" required value="https://YOUR_SUBDOMAIN.auth.marketingcloudapis.com/" placeholder="https://YOUR_SUBDOMAIN.auth.marketingcloudapis.com/">
            </div>
            
            <div class="form-group">
                <label for="gitBaseUrl">Git Base URL (opcional)</label>
                <input type="text" id="gitBaseUrl" name="gitBaseUrl" placeholder="https://raw.githubusercontent.com/oskyar/miniframework-ssjs/main/src/" value="https://raw.githubusercontent.com/oskyar/miniframework-ssjs/main/src/">
            </div>
            
            <button type="submit" name="action" value="install">üöÄ Instalar desde Git</button>
        </form>

        <script runat="server">
            var installResult = Variable.GetValue("@installResult");
            
            if (installResult) {
                var result = Platform.Function.ParseJSON(installResult);
                
                if (result.success) {
                    Write('<div class="success">');
                    Write('<h3>‚úÖ Instalaci√≥n Completada</h3>');
                    Write('<p><strong>' + result.summary + '</strong></p>');
                    
                    if (result.created && result.created.length > 0) {
                        Write('<h4>Content Blocks creados:</h4>');
                        Write('<ul>');
                        for (var i = 0; i < result.created.length; i++) {
                            Write('<li>' + result.created[i].name + ' (ID: ' + result.created[i].id + ')</li>');
                        }
                        Write('</ul>');
                    }
                    
                    if (result.errors && result.errors.length > 0) {
                        Write('<h4>‚ö†Ô∏è Errores encontrados:</h4>');
                        Write('<ul>');
                        for (var j = 0; j < result.errors.length; j++) {
                            Write('<li>' + result.errors[j] + '</li>');
                        }
                        Write('</ul>');
                    }
                    
                    Write('<div class="info">');
                    Write('<h4>üìã Pr√≥ximos pasos:</h4>');
                    Write('<ol>');
                    Write('<li>Ve a Content Builder ‚Üí Content Blocks</li>');
                    Write('<li>Verifica los bloques con prefijo "MF_"</li>');
                    Write('<li>Ejecuta AssetCreator para crear Data Extensions</li>');
                    Write('<li>¬°El framework est√° listo para usar!</li>');
                    Write('</ol>');
                    Write('</div>');
                    Write('</div>');
                    
                } else {
                    Write('<div class="error">');
                    Write('<h3>‚ùå Error en la instalaci√≥n</h3>');
                    
                    if (result.errors && result.errors.length > 0) {
                        Write('<h4>Errores:</h4>');
                        Write('<ul>');
                        for (var k = 0; k < result.errors.length; k++) {
                            Write('<li>' + result.errors[k] + '</li>');
                        }
                        Write('</ul>');
                    }
                    Write('</div>');
                }
                
                if (result.progress && result.progress.length > 0) {
                    Write('<details style="margin-top: 20px;">');
                    Write('<summary>Ver progreso detallado</summary>');
                    Write('<pre>');
                    for (var l = 0; l < result.progress.length; l++) {
                        Write(result.progress[l] + '\\n');
                    }
                    Write('</pre>');
                    Write('</details>');
                }
                
                Write('<details style="margin-top: 10px;">');
                Write('<summary>Ver respuesta t√©cnica completa</summary>');
                Write('<pre>' + installResult + '</pre>');
                Write('</details>');
            }
        </script>
    </div>
</body>
</html>