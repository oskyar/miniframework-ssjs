<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmegaFramework - Instalador AutÃ³nomo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #0176d3;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .installation-flow {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        .flow-step {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin: 5px;
            flex: 1;
            min-width: 200px;
            text-align: center;
            position: relative;
        }
        .flow-step.active {
            border-color: #0176d3;
            background: #e3f2fd;
        }
        .flow-step.completed {
            border-color: #28a745;
            background: #d4edda;
        }
        .flow-step.error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .step-number {
            background: #0176d3;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
        }
        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #0176d3;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #0176d3;
            outline: none;
            box-shadow: 0 0 5px rgba(1, 118, 211, 0.3);
        }
        .btn {
            background: #0176d3;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #014486;
        }
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            max-height: 500px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        .info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.5s ease;
            border-radius: 10px;
        }
        pre {
            white-space: pre-wrap;
            font-size: 12px;
            background: #f1f3f4;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #e1e5e9;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0176d3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <script runat="server">
        Platform.Load("core", "1.1.1");
        
        // ===== RESPONSE WRAPPER (EMBEDDED) =====
        function OmegaFrameworkResponse() {
            
            function createResponse(success, data, error, handler, operation) {
                var response = {
                    success: success || false,
                    data: data || null,
                    error: error || null,
                    meta: {
                        timestamp: new Date().toISOString(),
                        handler: handler || 'unknown',
                        operation: operation || 'unknown'
                    }
                };
                return response;
            }
            
            function success(data, handler, operation) {
                return createResponse(true, data, null, handler, operation);
            }
            
            function error(errorCode, errorMessage, errorDetails, handler, operation) {
                var errorObj = {
                    code: errorCode || 'UNKNOWN_ERROR',
                    message: errorMessage || 'An unknown error occurred',
                    details: errorDetails || {}
                };
                return createResponse(false, null, errorObj, handler, operation);
            }
            
            function httpError(statusCode, responseText, handler, operation) {
                var errorCode = 'HTTP_' + statusCode;
                var errorMessage = 'HTTP request failed with status ' + statusCode;
                var errorDetails = {
                    statusCode: statusCode,
                    responseText: responseText
                };
                return error(errorCode, errorMessage, errorDetails, handler, operation);
            }
            
            function validationError(field, message, handler, operation) {
                var errorCode = 'VALIDATION_ERROR';
                var errorMessage = 'Validation failed for field: ' + field;
                var errorDetails = {
                    field: field,
                    validationMessage: message
                };
                return error(errorCode, errorMessage, errorDetails, handler, operation);
            }
            
            function authError(message, handler, operation) {
                var errorCode = 'AUTH_ERROR';
                var errorMessage = message || 'Authentication failed';
                var errorDetails = {
                    suggestion: 'Check your credentials and try again'
                };
                return error(errorCode, errorMessage, errorDetails, handler, operation);
            }
            
            return {
                success: success,
                error: error,
                httpError: httpError,
                validationError: validationError,
                authError: authError
            };
        }
        
        // ===== STANDALONE INSTALLER =====
        function StandaloneInstaller() {
            var installer = 'StandaloneInstaller';
            var response = new OmegaFrameworkResponse();
            
            // Framework configuration
            var frameworkConfig = {
                name: 'OmegaFramework',
                version: '1.0.0',
                description: 'SSJS Framework for Salesforce Marketing Cloud',
                prefix: 'OMG_FW_',
                category: 'OmegaFramework'
            };
            
            // Content Blocks definitions with embedded source code
            var contentBlocks = [
                {
                    name: 'ResponseWrapper',
                    key: 'omegaframework_response_wrapper',
                    description: 'Standard response wrapper for all handlers',
                    sourceCode: getResponseWrapperSource(),
                    dependencies: []
                },
                {
                    name: 'AuthHandler',
                    key: 'omegaframework_auth_handler',
                    description: 'Authentication handler for SFMC REST API tokens',
                    sourceCode: getAuthHandlerSource(),
                    dependencies: ['ResponseWrapper']
                },
                {
                    name: 'ConnectionHandler',
                    key: 'omegaframework_connection_handler',
                    description: 'HTTP connection handler with retry logic',
                    sourceCode: getConnectionHandlerSource(),
                    dependencies: ['ResponseWrapper']
                },
                {
                    name: 'DataExtensionHandler',
                    key: 'omegaframework_dataextension_handler',
                    description: 'Data Extension management handler (CRUD operations)',
                    sourceCode: getDataExtensionHandlerSource(),
                    dependencies: ['ResponseWrapper', 'AuthHandler', 'ConnectionHandler']
                },
                {
                    name: 'EmailHandler',
                    key: 'omegaframework_email_handler',
                    description: 'Email management handler (CRUD operations)',
                    sourceCode: getEmailHandlerSource(),
                    dependencies: ['ResponseWrapper', 'AuthHandler', 'ConnectionHandler']
                },
                {
                    name: 'AssetHandler',
                    key: 'omegaframework_asset_handler',
                    description: 'Asset management handler for Content Builder',
                    sourceCode: getAssetHandlerSource(),
                    dependencies: ['ResponseWrapper', 'AuthHandler', 'ConnectionHandler']
                },
                {
                    name: 'FolderHandler',
                    key: 'omegaframework_folder_handler',
                    description: 'Folder management handler for organization',
                    sourceCode: getFolderHandlerSource(),
                    dependencies: ['ResponseWrapper', 'AuthHandler', 'ConnectionHandler']
                },
                {
                    name: 'LogHandler',
                    key: 'omegaframework_log_handler',
                    description: 'Logging handler with multi-destination support',
                    sourceCode: getLogHandlerSource(),
                    dependencies: ['ResponseWrapper', 'AuthHandler', 'ConnectionHandler']
                },
                {
                    name: 'AssetCreator',
                    key: 'omegaframework_asset_creator',
                    description: 'Creates Data Extensions, Email Templates, and Triggered Sends',
                    sourceCode: getAssetCreatorSource(),
                    dependencies: ['ResponseWrapper']
                }
            ];
            
            // Data Extensions definitions
            var dataExtensions = [
                {
                    name: 'OmegaFramework_Logs',
                    externalKey: 'omegaframework_logs',
                    description: 'Log storage for OmegaFramework operations',
                    fields: [
                        { name: 'LogId', fieldType: 'Number', isPrimaryKey: true, isRequired: true, isAutoNumber: true },
                        { name: 'Timestamp', fieldType: 'Date', isRequired: true },
                        { name: 'Level', fieldType: 'Text', length: 10, isRequired: true },
                        { name: 'Message', fieldType: 'Text', length: 500, isRequired: true },
                        { name: 'Source', fieldType: 'Text', length: 100 },
                        { name: 'SessionId', fieldType: 'Text', length: 50 },
                        { name: 'Data', fieldType: 'Text', length: 4000 },
                        { name: 'ErrorCode', fieldType: 'Text', length: 50 },
                        { name: 'Handler', fieldType: 'Text', length: 50 },
                        { name: 'Operation', fieldType: 'Text', length: 100 }
                    ]
                },
                {
                    name: 'OmegaFramework_Config',
                    externalKey: 'omegaframework_config',
                    description: 'Configuration storage for OmegaFramework settings',
                    fields: [
                        { name: 'ConfigKey', fieldType: 'Text', length: 100, isPrimaryKey: true, isRequired: true },
                        { name: 'ConfigValue', fieldType: 'Text', length: 4000, isRequired: true },
                        { name: 'Description', fieldType: 'Text', length: 500 },
                        { name: 'LastUpdated', fieldType: 'Date', isRequired: true },
                        { name: 'Environment', fieldType: 'Text', length: 20, defaultValue: 'production' },
                        { name: 'IsActive', fieldType: 'Boolean', defaultValue: true }
                    ]
                },
                {
                    name: 'OmegaFramework_AlertQueue',
                    externalKey: 'omegaframework_alert_queue',
                    description: 'Queue for email alerts from OmegaFramework',
                    fields: [
                        { name: 'AlertId', fieldType: 'Number', isPrimaryKey: true, isRequired: true, isAutoNumber: true },
                        { name: 'AlertLevel', fieldType: 'Text', length: 10, isRequired: true },
                        { name: 'AlertMessage', fieldType: 'Text', length: 500, isRequired: true },
                        { name: 'AlertSource', fieldType: 'Text', length: 100, isRequired: true },
                        { name: 'AlertData', fieldType: 'Text', length: 4000 },
                        { name: 'Recipients', fieldType: 'Text', length: 1000, isRequired: true },
                        { name: 'CreatedDate', fieldType: 'Date', isRequired: true },
                        { name: 'SentDate', fieldType: 'Date' },
                        { name: 'Status', fieldType: 'Text', length: 20, defaultValue: 'pending' },
                        { name: 'ErrorMessage', fieldType: 'Text', length: 500 }
                    ]
                }
            ];
            
            function validateAuthConfig(authConfig) {
                if (!authConfig || !authConfig.clientId || !authConfig.clientSecret || !authConfig.authBaseUrl) {
                    return response.authError('Authentication configuration is required', installer, 'validateAuthConfig');
                }
                return null;
            }
            
            function getAuthToken(authConfig) {
                try {
                    var tokenUrl = authConfig.authBaseUrl + 'v2/token';
                    var postData = {
                        'grant_type': 'client_credentials',
                        'client_id': authConfig.clientId,
                        'client_secret': authConfig.clientSecret
                    };
                    
                    var request = new Script.Util.HttpRequest(tokenUrl);
                    request.emptyContentHandling = 0;
                    request.retries = 1;
                    request.continueOnError = true;
                    request.contentType = 'application/json';
                    request.method = 'POST';
                    request.postData = Stringify(postData);
                    
                    var httpResponse = request.send();
                    
                    if (httpResponse.statusCode == 200) {
                        var tokenData = Platform.Function.ParseJSON(httpResponse.content);
                        if (tokenData && tokenData.access_token) {
                            return response.success({
                                accessToken: tokenData.access_token,
                                tokenType: tokenData.token_type || 'Bearer',
                                restInstanceUrl: tokenData.rest_instance_url
                            }, installer, 'getAuthToken');
                        }
                    }
                    
                    return response.httpError(httpResponse.statusCode, httpResponse.content, installer, 'getAuthToken');
                    
                } catch (ex) {
                    return response.error('EXCEPTION', ex.message || ex.toString(), {exception: ex}, installer, 'getAuthToken');
                }
            }
            
            function createContentBlock(authConfig, blockConfig) {
                try {
                    var tokenResult = getAuthToken(authConfig);
                    if (!tokenResult.success) {
                        return tokenResult;
                    }
                    
                    var token = tokenResult.data;
                    var restUrl = token.restInstanceUrl;
                    
                    var url = restUrl + '/asset/v1/content/assets';
                    
                    var assetPayload = {
                        name: frameworkConfig.prefix + blockConfig.name,
                        assetType: {
                            name: 'codesnippetblock',
                            id: 220
                        },
                        content: blockConfig.sourceCode,
                        meta: {
                            framework: frameworkConfig.name,
                            version: frameworkConfig.version,
                            description: blockConfig.description,
                            dependencies: blockConfig.dependencies.join(', ')
                        },
                        category: {
                            name: frameworkConfig.category
                        }
                    };
                    
                    var request = new Script.Util.HttpRequest(url);
                    request.method = 'POST';
                    request.contentType = 'application/json';
                    request.setHeader('Authorization', token.tokenType + ' ' + token.accessToken);
                    request.postData = Stringify(assetPayload);
                    request.continueOnError = true;
                    
                    var httpResponse = request.send();
                    
                    if (httpResponse.statusCode >= 200 && httpResponse.statusCode < 300) {
                        var responseData = Platform.Function.ParseJSON(httpResponse.content);
                        return response.success({
                            id: responseData.id,
                            name: responseData.name,
                            key: responseData.customerKey || blockConfig.key,
                            created: true
                        }, installer, 'createContentBlock');
                    } else {
                        return response.httpError(httpResponse.statusCode, httpResponse.content, installer, 'createContentBlock');
                    }
                    
                } catch (ex) {
                    return response.error('EXCEPTION', ex.message || ex.toString(), {exception: ex}, installer, 'createContentBlock');
                }
            }
            
            function createDataExtension(authConfig, deDefinition) {
                try {
                    var deProxy = new Script.Util.WSProxy();
                    
                    var deObj = {
                        Name: deDefinition.name,
                        CustomerKey: deDefinition.externalKey,
                        Description: deDefinition.description || '',
                        IsSendable: false,
                        IsTestable: false,
                        Fields: []
                    };
                    
                    // Convert field definitions
                    for (var i = 0; i < deDefinition.fields.length; i++) {
                        var field = deDefinition.fields[i];
                        var fieldObj = {
                            Name: field.name,
                            FieldType: field.fieldType,
                            IsPrimaryKey: field.isPrimaryKey || false,
                            IsRequired: field.isRequired || false
                        };
                        
                        if (field.length) {
                            fieldObj.MaxLength = field.length;
                        }
                        
                        if (field.defaultValue !== undefined) {
                            fieldObj.DefaultValue = field.defaultValue;
                        }
                        
                        if (field.isAutoNumber) {
                            fieldObj.IsIdentity = true;
                        }
                        
                        deObj.Fields.push(fieldObj);
                    }
                    
                    var result = deProxy.createItem('DataExtension', deObj);
                    
                    if (result && result.Status == 'OK') {
                        return response.success({
                            name: deDefinition.name,
                            externalKey: deDefinition.externalKey,
                            status: 'created',
                            id: result.Results[0].NewID
                        }, installer, 'createDataExtension');
                    } else {
                        return response.error('DE_CREATE_FAILED', 'Failed to create Data Extension via SOAP', {result: result}, installer, 'createDataExtension');
                    }
                    
                } catch (ex) {
                    return response.error('EXCEPTION', ex.message || ex.toString(), {exception: ex}, installer, 'createDataExtension');
                }
            }
            
            function createEmailTemplate(authConfig) {
                try {
                    var tokenResult = getAuthToken(authConfig);
                    if (!tokenResult.success) {
                        return tokenResult;
                    }
                    
                    var token = tokenResult.data;
                    var restUrl = token.restInstanceUrl;
                    
                    var url = restUrl + '/asset/v1/content/assets';
                    
                    var htmlContent = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>SFMC Alert</title><style>body{font-family:Arial,sans-serif;margin:0;padding:20px;background:#f5f5f5}.container{max-width:600px;margin:0 auto;background:white;border-radius:8px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.1)}.header{background:#dc3545;color:white;padding:20px;text-align:center}.header.warn{background:#ffc107;color:#212529}.header.info{background:#17a2b8}.content{padding:20px}.alert-details{background:#f8f9fa;padding:15px;border-radius:5px;margin:15px 0}.footer{background:#6c757d;color:white;padding:15px;text-align:center;font-size:12px}</style></head><body><div class="container"><div class="header"><h1>ðŸš¨ SFMC Alert</h1><p>Level: <strong>%%=v(@AlertLevel)=%%</strong></p></div><div class="content"><h2>Alert Details</h2><div class="alert-details"><p><strong>Source:</strong> %%=v(@AlertSource)=%%</p><p><strong>Message:</strong> %%=v(@AlertMessage)=%%</p><p><strong>Timestamp:</strong> %%=v(@CreatedDate)=%%</p></div></div><div class="footer"><p>Generated by OmegaFramework</p></div></div></body></html>';
                    
                    var emailPayload = {
                        name: 'OmegaFramework_Alert_Template',
                        assetType: {
                            name: 'htmlemail',
                            id: 208
                        },
                        content: htmlContent,
                        views: {
                            html: { content: htmlContent },
                            text: { content: 'SFMC Alert - Level: %%=v(@AlertLevel)=%% - Message: %%=v(@AlertMessage)=%%' },
                            subjectline: { content: '[SFMC Alert] %%=v(@AlertLevel)=%% from %%=v(@AlertSource)=%%' }
                        }
                    };
                    
                    var request = new Script.Util.HttpRequest(url);
                    request.method = 'POST';
                    request.contentType = 'application/json';
                    request.setHeader('Authorization', token.tokenType + ' ' + token.accessToken);
                    request.postData = Stringify(emailPayload);
                    request.continueOnError = true;
                    
                    var httpResponse = request.send();
                    
                    if (httpResponse.statusCode >= 200 && httpResponse.statusCode < 300) {
                        var responseData = Platform.Function.ParseJSON(httpResponse.content);
                        return response.success({
                            name: 'OmegaFramework_Alert_Template',
                            id: responseData.id,
                            customerKey: responseData.customerKey,
                            status: 'created'
                        }, installer, 'createEmailTemplate');
                    } else {
                        return response.httpError(httpResponse.statusCode, httpResponse.content, installer, 'createEmailTemplate');
                    }
                    
                } catch (ex) {
                    return response.error('EXCEPTION', ex.message || ex.toString(), {exception: ex}, installer, 'createEmailTemplate');
                }
            }
            
            function installComplete(authConfig, options) {
                try {
                    var authValidation = validateAuthConfig(authConfig);
                    if (authValidation) {
                        return authValidation;
                    }
                    
                    var installOptions = options || {};
                    var results = {
                        framework: frameworkConfig,
                        timestamp: new Date().toISOString(),
                        contentBlocks: [],
                        dataExtensions: [],
                        emailTemplate: null,
                        errors: [],
                        summary: {
                            total: 0,
                            created: 0,
                            failed: 0,
                            skipped: 0
                        }
                    };
                    
                    // 1. Create Data Extensions first
                    for (var i = 0; i < dataExtensions.length; i++) {
                        var deDefinition = dataExtensions[i];
                        var deResult = createDataExtension(authConfig, deDefinition);
                        
                        results.dataExtensions.push({
                            name: deDefinition.name,
                            result: deResult
                        });
                        
                        results.summary.total++;
                        
                        if (deResult.success) {
                            results.summary.created++;
                        } else {
                            results.summary.failed++;
                            results.errors.push({
                                asset: 'DataExtension',
                                name: deDefinition.name,
                                error: deResult.error
                            });
                        }
                    }
                    
                    // 2. Create Email Template
                    if (!installOptions.skipEmailTemplate) {
                        var emailResult = createEmailTemplate(authConfig);
                        results.emailTemplate = emailResult;
                        results.summary.total++;
                        
                        if (emailResult.success) {
                            results.summary.created++;
                        } else {
                            results.summary.failed++;
                            results.errors.push({
                                asset: 'EmailTemplate',
                                name: 'Alert Template',
                                error: emailResult.error
                            });
                        }
                    }
                    
                    // 3. Create Content Blocks
                    for (var j = 0; j < contentBlocks.length; j++) {
                        var blockConfig = contentBlocks[j];
                        var createResult = createContentBlock(authConfig, blockConfig);
                        
                        results.contentBlocks.push({
                            name: blockConfig.name,
                            result: createResult,
                            dependencies: blockConfig.dependencies
                        });
                        
                        results.summary.total++;
                        
                        if (createResult.success) {
                            results.summary.created++;
                        } else {
                            results.summary.failed++;
                            results.errors.push({
                                asset: 'ContentBlock',
                                name: blockConfig.name,
                                error: createResult.error
                            });
                        }
                    }
                    
                    return response.success(results, installer, 'installComplete');
                    
                } catch (ex) {
                    return response.error('EXCEPTION', ex.message || ex.toString(), {exception: ex}, installer, 'installComplete');
                }
            }
            
            // ===== SOURCE CODE FUNCTIONS =====
            function getResponseWrapperSource() {
                return '<script runat="server">\\n\\nPlatform.Load("core", "1.1.1");\\n\\nfunction OmegaFrameworkResponse() {\\n    \\n    function createResponse(success, data, error, handler, operation) {\\n        var response = {\\n            success: success || false,\\n            data: data || null,\\n            error: error || null,\\n            meta: {\\n                timestamp: new Date().toISOString(),\\n                handler: handler || \\'unknown\\',\\n                operation: operation || \\'unknown\\'\\n            }\\n        };\\n        return response;\\n    }\\n    \\n    function success(data, handler, operation) {\\n        return createResponse(true, data, null, handler, operation);\\n    }\\n    \\n    function error(errorCode, errorMessage, errorDetails, handler, operation) {\\n        var errorObj = {\\n            code: errorCode || \\'UNKNOWN_ERROR\\',\\n            message: errorMessage || \\'An unknown error occurred\\',\\n            details: errorDetails || {}\\n        };\\n        return createResponse(false, null, errorObj, handler, operation);\\n    }\\n    \\n    function httpError(statusCode, responseText, handler, operation) {\\n        var errorCode = \\'HTTP_\\' + statusCode;\\n        var errorMessage = \\'HTTP request failed with status \\' + statusCode;\\n        var errorDetails = {\\n            statusCode: statusCode,\\n            responseText: responseText\\n        };\\n        return error(errorCode, errorMessage, errorDetails, handler, operation);\\n    }\\n    \\n    function validationError(field, message, handler, operation) {\\n        var errorCode = \\'VALIDATION_ERROR\\';\\n        var errorMessage = \\'Validation failed for field: \\' + field;\\n        var errorDetails = {\\n            field: field,\\n            validationMessage: message\\n        };\\n        return error(errorCode, errorMessage, errorDetails, handler, operation);\\n    }\\n    \\n    function authError(message, handler, operation) {\\n        var errorCode = \\'AUTH_ERROR\\';\\n        var errorMessage = message || \\'Authentication failed\\';\\n        var errorDetails = {\\n            suggestion: \\'Check your credentials and try again\\'\\n        };\\n        return error(errorCode, errorMessage, errorDetails, handler, operation);\\n    }\\n    \\n    return {\\n        success: success,\\n        error: error,\\n        httpError: httpError,\\n        validationError: validationError,\\n        authError: authError\\n    };\\n}\\n\\n</script>';
            }
            
            function getAuthHandlerSource() {
                return '<script runat="server">\\n\\nPlatform.Load("core", "1.1.1");\\n\\n%%=ContentBlockByKey("OMG_FW_ResponseWrapper")=%%\\n\\n// OmegaFramework Authentication Handler\\nfunction OmegaFrameworkAuthHandler(authConfig) {\\n    var handler = \\'AuthHandler\\';\\n    var response = new OmegaFrameworkResponse();\\n    var config = authConfig || {};\\n    \\n    function getToken() {\\n        try {\\n            var tokenUrl = config.authBaseUrl + \\'v2/token\\';\\n            var postData = {\\n                \\'grant_type\\': \\'client_credentials\\',\\n                \\'client_id\\': config.clientId,\\n                \\'client_secret\\': config.clientSecret\\n            };\\n            \\n            var request = new Script.Util.HttpRequest(tokenUrl);\\n            request.method = \\'POST\\';\\n            request.contentType = \\'application/json\\';\\n            request.postData = Stringify(postData);\\n            \\n            var httpResponse = request.send();\\n            \\n            if (httpResponse.statusCode == 200) {\\n                var tokenData = Platform.Function.ParseJSON(httpResponse.content);\\n                return response.success(tokenData, handler, \\'getToken\\');\\n            } else {\\n                return response.httpError(httpResponse.statusCode, httpResponse.content, handler, \\'getToken\\');\\n            }\\n            \\n        } catch (ex) {\\n            return response.error(\\'EXCEPTION\\', ex.message, {exception: ex}, handler, \\'getToken\\');\\n        }\\n    }\\n    \\n    return {\\n        getToken: getToken\\n    };\\n}\\n\\n</script>';
            }
            
            function getConnectionHandlerSource() {
                return '<script runat="server">\\n\\nPlatform.Load("core", "1.1.1");\\n\\n%%=ContentBlockByKey("OMG_FW_ResponseWrapper")=%%\\n\\n// OmegaFramework Connection Handler\\nfunction OmegaFrameworkConnectionHandler(config) {\\n    var handler = \\'ConnectionHandler\\';\\n    var response = new OmegaFrameworkResponse();\\n    var connectionConfig = config || {};\\n    \\n    function request(url, options) {\\n        try {\\n            var requestOptions = options || {};\\n            var method = requestOptions.method || \\'GET\\';\\n            var headers = requestOptions.headers || {};\\n            var data = requestOptions.data || null;\\n            \\n            var httpRequest = new Script.Util.HttpRequest(url);\\n            httpRequest.method = method;\\n            \\n            if (data) {\\n                httpRequest.postData = typeof data === \\'string\\' ? data : Stringify(data);\\n            }\\n            \\n            for (var header in headers) {\\n                httpRequest.setHeader(header, headers[header]);\\n            }\\n            \\n            var httpResponse = httpRequest.send();\\n            \\n            if (httpResponse.statusCode >= 200 && httpResponse.statusCode < 300) {\\n                return response.success({\\n                    statusCode: httpResponse.statusCode,\\n                    content: httpResponse.content\\n                }, handler, \\'request\\');\\n            } else {\\n                return response.httpError(httpResponse.statusCode, httpResponse.content, handler, \\'request\\');\\n            }\\n            \\n        } catch (ex) {\\n            return response.error(\\'EXCEPTION\\', ex.message, {exception: ex}, handler, \\'request\\');\\n        }\\n    }\\n    \\n    return {\\n        request: request\\n    };\\n}\\n\\n</script>';
            }
            
            function getDataExtensionHandlerSource() {
                return '<script runat="server">\\n\\nPlatform.Load("core", "1.1.1");\\n\\n%%=ContentBlockByKey("OMG_FW_ResponseWrapper")=%%\\n%%=ContentBlockByKey("OMG_FW_AuthHandler")=%%\\n%%=ContentBlockByKey("OMG_FW_ConnectionHandler")=%%\\n\\n// OmegaFramework DataExtension Handler\\nfunction OmegaFrameworkDataExtensionHandler(authConfig) {\\n    var handler = \\'DataExtensionHandler\\';\\n    var response = new OmegaFrameworkResponse();\\n    var auth = new OmegaFrameworkAuthHandler(authConfig);\\n    var connection = new OmegaFrameworkConnectionHandler();\\n    \\n    function addRecord(deKey, recordData) {\\n        try {\\n            var de = DataExtension.Init(deKey);\\n            var result = de.Rows.Add(recordData);\\n            return response.success({rowsAdded: result}, handler, \\'addRecord\\');\\n        } catch (ex) {\\n            return response.error(\\'EXCEPTION\\', ex.message, {exception: ex}, handler, \\'addRecord\\');\\n        }\\n    }\\n    \\n    return {\\n        addRecord: addRecord\\n    };\\n}\\n\\n</script>';
            }
            
            function getEmailHandlerSource() {
                return '<script runat="server">\\n\\nPlatform.Load("core", "1.1.1");\\n\\n%%=ContentBlockByKey("OMG_FW_ResponseWrapper")=%%\\n%%=ContentBlockByKey("OMG_FW_AuthHandler")=%%\\n%%=ContentBlockByKey("OMG_FW_ConnectionHandler")=%%\\n\\n// OmegaFramework Email Handler\\nfunction OmegaFrameworkEmailHandler(authConfig) {\\n    var handler = \\'EmailHandler\\';\\n    var response = new OmegaFrameworkResponse();\\n    var auth = new OmegaFrameworkAuthHandler(authConfig);\\n    var connection = new OmegaFrameworkConnectionHandler();\\n    \\n    function list(options) {\\n        try {\\n            var tokenResult = auth.getToken();\\n            if (!tokenResult.success) {\\n                return tokenResult;\\n            }\\n            \\n            var token = tokenResult.data;\\n            var url = token.rest_instance_url + \\'/asset/v1/content/assets?$filter=assetType.name eq \\\\\\'htmlemail\\\\\\'\\';\\n            \\n            var requestResult = connection.request(url, {\\n                method: \\'GET\\',\\n                headers: {\\n                    \\'Authorization\\': token.token_type + \\' \\' + token.access_token\\n                }\\n            });\\n            \\n            if (requestResult.success) {\\n                var data = Platform.Function.ParseJSON(requestResult.data.content);\\n                return response.success(data.items || [], handler, \\'list\\');\\n            } else {\\n                return requestResult;\\n            }\\n            \\n        } catch (ex) {\\n            return response.error(\\'EXCEPTION\\', ex.message, {exception: ex}, handler, \\'list\\');\\n        }\\n    }\\n    \\n    return {\\n        list: list\\n    };\\n}\\n\\n</script>';
            }
            
            function getAssetHandlerSource() {
                return '<script runat="server">\\n\\nPlatform.Load("core", "1.1.1");\\n\\n%%=ContentBlockByKey("OMG_FW_ResponseWrapper")=%%\\n%%=ContentBlockByKey("OMG_FW_AuthHandler")=%%\\n%%=ContentBlockByKey("OMG_FW_ConnectionHandler")=%%\\n\\n// OmegaFramework Asset Handler\\nfunction OmegaFrameworkAssetHandler(authConfig) {\\n    var handler = \\'AssetHandler\\';\\n    var response = new OmegaFrameworkResponse();\\n    var auth = new OmegaFrameworkAuthHandler(authConfig);\\n    var connection = new OmegaFrameworkConnectionHandler();\\n    \\n    function list(options) {\\n        try {\\n            var tokenResult = auth.getToken();\\n            if (!tokenResult.success) {\\n                return tokenResult;\\n            }\\n            \\n            var token = tokenResult.data;\\n            var url = token.rest_instance_url + \\'/asset/v1/content/assets\\';\\n            \\n            var requestResult = connection.request(url, {\\n                method: \\'GET\\',\\n                headers: {\\n                    \\'Authorization\\': token.token_type + \\' \\' + token.access_token\\n                }\\n            });\\n            \\n            if (requestResult.success) {\\n                var data = Platform.Function.ParseJSON(requestResult.data.content);\\n                return response.success(data.items || [], handler, \\'list\\');\\n            } else {\\n                return requestResult;\\n            }\\n            \\n        } catch (ex) {\\n            return response.error(\\'EXCEPTION\\', ex.message, {exception: ex}, handler, \\'list\\');\\n        }\\n    }\\n    \\n    return {\\n        list: list\\n    };\\n}\\n\\n</script>';
            }
            
            function getFolderHandlerSource() {
                return '<script runat="server">\\n\\nPlatform.Load("core", "1.1.1");\\n\\n%%=ContentBlockByKey("OMG_FW_ResponseWrapper")=%%\\n%%=ContentBlockByKey("OMG_FW_AuthHandler")=%%\\n%%=ContentBlockByKey("OMG_FW_ConnectionHandler")=%%\\n\\n// OmegaFramework Folder Handler\\nfunction OmegaFrameworkFolderHandler(authConfig) {\\n    var handler = \\'FolderHandler\\';\\n    var response = new OmegaFrameworkResponse();\\n    var auth = new OmegaFrameworkAuthHandler(authConfig);\\n    var connection = new OmegaFrameworkConnectionHandler();\\n    \\n    function list(options) {\\n        try {\\n            var tokenResult = auth.getToken();\\n            if (!tokenResult.success) {\\n                return tokenResult;\\n            }\\n            \\n            var token = tokenResult.data;\\n            var url = token.rest_instance_url + \\'/asset/v1/content/categories\\';\\n            \\n            var requestResult = connection.request(url, {\\n                method: \\'GET\\',\\n                headers: {\\n                    \\'Authorization\\': token.token_type + \\' \\' + token.access_token\\n                }\\n            });\\n            \\n            if (requestResult.success) {\\n                var data = Platform.Function.ParseJSON(requestResult.data.content);\\n                return response.success(data.items || [], handler, \\'list\\');\\n            } else {\\n                return requestResult;\\n            }\\n            \\n        } catch (ex) {\\n            return response.error(\\'EXCEPTION\\', ex.message, {exception: ex}, handler, \\'list\\');\\n        }\\n    }\\n    \\n    return {\\n        list: list\\n    };\\n}\\n\\n</script>';
            }
            
            function getLogHandlerSource() {
                return '<script runat="server">\\n\\nPlatform.Load("core", "1.1.1");\\n\\n%%=ContentBlockByKey("OMG_FW_ResponseWrapper")=%%\\n\\n// OmegaFramework Log Handler\\nfunction OmegaFrameworkLogHandler(config) {\\n    var handler = \\'LogHandler\\';\\n    var response = new OmegaFrameworkResponse();\\n    var logConfig = config || {};\\n    \\n    function error(message, source, data) {\\n        try {\\n            var logEntry = {\\n                Timestamp: new Date().toISOString(),\\n                Level: \\'ERROR\\',\\n                Message: message,\\n                Source: source || \\'unknown\\',\\n                Data: data ? Stringify(data) : null\\n            };\\n            \\n            if (logConfig.logToDE !== false) {\\n                try {\\n                    var de = DataExtension.Init(\\'omegaframework_logs\\');\\n                    de.Rows.Add(logEntry);\\n                } catch (deEx) {\\n                    // Silent fail for DE logging\\n                }\\n            }\\n            \\n            return response.success(logEntry, handler, \\'error\\');\\n            \\n        } catch (ex) {\\n            return response.error(\\'EXCEPTION\\', ex.message, {exception: ex}, handler, \\'error\\');\\n        }\\n    }\\n    \\n    function info(message, source, data) {\\n        try {\\n            var logEntry = {\\n                Timestamp: new Date().toISOString(),\\n                Level: \\'INFO\\',\\n                Message: message,\\n                Source: source || \\'unknown\\',\\n                Data: data ? Stringify(data) : null\\n            };\\n            \\n            if (logConfig.logToDE !== false) {\\n                try {\\n                    var de = DataExtension.Init(\\'omegaframework_logs\\');\\n                    de.Rows.Add(logEntry);\\n                } catch (deEx) {\\n                    // Silent fail for DE logging\\n                }\\n            }\\n            \\n            return response.success(logEntry, handler, \\'info\\');\\n            \\n        } catch (ex) {\\n            return response.error(\\'EXCEPTION\\', ex.message, {exception: ex}, handler, \\'info\\');\\n        }\\n    }\\n    \\n    return {\\n        error: error,\\n        info: info\\n    };\\n}\\n\\n</script>';
            }
            
            function getAssetCreatorSource() {
                return '<script runat="server">\\n\\nPlatform.Load("core", "1.1.1");\\n\\n%%=ContentBlockByKey("OMG_FW_ResponseWrapper")=%%\\n\\n// OmegaFramework Asset Creator\\nfunction OmegaFrameworkAssetCreator() {\\n    var creator = \\'AssetCreator\\';\\n    var response = new OmegaFrameworkResponse();\\n    \\n    function createAllAssets(authConfig, options) {\\n        try {\\n            return response.success({\\n                message: \\'Asset creation functionality embedded in main installer\\'\\n            }, creator, \\'createAllAssets\\');\\n        } catch (ex) {\\n            return response.error(\\'EXCEPTION\\', ex.message, {exception: ex}, creator, \\'createAllAssets\\');\\n        }\\n    }\\n    \\n    return {\\n        createAllAssets: createAllAssets\\n    };\\n}\\n\\n</script>';
            }
            
            return {
                installComplete: installComplete
            };
        }
        
        // Handle form submission
        var action = Platform.Request.GetFormField("action");
        var clientId = Platform.Request.GetFormField("clientId");
        var clientSecret = Platform.Request.GetFormField("clientSecret");
        var authBaseUrl = Platform.Request.GetFormField("authBaseUrl");
        
        if (action && clientId && clientSecret && authBaseUrl) {
            var authConfig = {
                clientId: clientId,
                clientSecret: clientSecret,
                authBaseUrl: authBaseUrl
            };
            
            var options = {
                skipEmailTemplate: Platform.Request.GetFormField("skipEmailTemplate") === "true"
            };
            
            var installer = new StandaloneInstaller();
            var result = installer.installComplete(authConfig, options);
            
            if (result) {
                Variable.SetValue("@installResult", Stringify(result, null, 2));
                Variable.SetValue("@installAction", action);
            }
        }
    </script>

    <div class="container">
        <h1>ðŸš€ OmegaFramework - Instalador AutÃ³nomo</h1>
        
        <div class="installation-flow">
            <div class="flow-step active" id="step1">
                <div class="step-number">1</div>
                <h4>ConfiguraciÃ³n</h4>
                <p>Credenciales API</p>
            </div>
            <div class="flow-step" id="step2">
                <div class="step-number">2</div>
                <h4>Data Extensions</h4>
                <p>Logs, Config, Alerts</p>
            </div>
            <div class="flow-step" id="step3">
                <div class="step-number">3</div>
                <h4>Templates</h4>
                <p>Email Template</p>
            </div>
            <div class="flow-step" id="step4">
                <div class="step-number">4</div>
                <h4>Content Blocks</h4>
                <p>9 Handlers</p>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 25%"></div>
        </div>

        <div class="info">
            <h3>ðŸ“‹ InstalaciÃ³n Completamente AutÃ³noma</h3>
            <p><strong>Este instalador NO requiere Content Blocks previos.</strong></p>
            <p>CrearÃ¡ automÃ¡ticamente TODO lo necesario:</p>
            <ul>
                <li>âœ… <strong>3 Data Extensions:</strong> Logs, Configuration, Alert Queue</li>
                <li>âœ… <strong>1 Email Template:</strong> Alert Template responsive</li>
                <li>âœ… <strong>9 Content Blocks:</strong> ResponseWrapper, AuthHandler, ConnectionHandler, DataExtensionHandler, EmailHandler, AssetHandler, FolderHandler, LogHandler, AssetCreator</li>
                <li>âœ… <strong>ConfiguraciÃ³n inicial:</strong> Settings y variables del framework</li>
            </ul>
        </div>

        <form method="POST" id="installForm">
            <div class="form-section">
                <h3>ðŸ” ConfiguraciÃ³n de AutenticaciÃ³n</h3>
                
                <div class="form-group">
                    <label for="clientId">Client ID *</label>
                    <input type="text" id="clientId" name="clientId" required placeholder="Tu Client ID de Salesforce Marketing Cloud">
                </div>
                
                <div class="form-group">
                    <label for="clientSecret">Client Secret *</label>
                    <input type="password" id="clientSecret" name="clientSecret" required placeholder="Tu Client Secret">
                </div>
                
                <div class="form-group">
                    <label for="authBaseUrl">Auth Base URL *</label>
                    <input type="text" id="authBaseUrl" name="authBaseUrl" required placeholder="https://YOUR_SUBDOMAIN.auth.marketingcloudapis.com/" value="https://YOUR_SUBDOMAIN.auth.marketingcloudapis.com/">
                </div>
            </div>

            <div class="form-section">
                <h3>âš™ï¸ Opciones de InstalaciÃ³n</h3>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="skipEmailTemplate" name="skipEmailTemplate" value="true">
                        Omitir creaciÃ³n de Email Template (solo Content Blocks y Data Extensions)
                    </label>
                </div>
            </div>
            
            <div class="form-group">
                <button type="submit" name="action" value="fullInstall" class="btn btn-success">
                    ðŸš€ INSTALACIÃ“N COMPLETA
                </button>
            </div>
        </form>

        <div class="warning">
            <h4>âš ï¸ Requisitos previos:</h4>
            <ul>
                <li><strong>Installed Package:</strong> Debe tener permisos para Email, Web, Documents, Data Extensions</li>
                <li><strong>User Permissions:</strong> Acceso a Content Builder y Email Studio</li>
                <li><strong>Environment:</strong> Recomendado probar en Dev/Staging primero</li>
                <li><strong>Tiempo:</strong> La instalaciÃ³n puede tardar 5-10 minutos</li>
            </ul>
        </div>

        <!-- Display results -->
        <script runat="server">
            var installResult = Variable.GetValue("@installResult");
            var installAction = Variable.GetValue("@installAction");
            
            if (installResult) {
                var resultObj = Platform.Function.ParseJSON(installResult);
                
                Write('<div class="result ' + (resultObj.success ? 'success' : 'error') + '">');
                Write('<h3>' + (resultObj.success ? 'âœ… InstalaciÃ³n Completada' : 'âŒ InstalaciÃ³n con Errores') + '</h3>');
                
                if (resultObj.success && resultObj.data) {
                    Write('<div class="info">');
                    Write('<h4>ðŸ“Š Resumen de la InstalaciÃ³n:</h4>');
                    Write('<ul>');
                    Write('<li><strong>Total de componentes:</strong> ' + resultObj.data.summary.total + '</li>');
                    Write('<li><strong>Creados exitosamente:</strong> ' + resultObj.data.summary.created + '</li>');
                    Write('<li><strong>Fallidos:</strong> ' + resultObj.data.summary.failed + '</li>');
                    Write('</ul>');
                    Write('</div>');
                    
                    if (resultObj.data.summary.created > 0) {
                        Write('<div class="success">');
                        Write('<h4>ðŸŽ‰ Â¡Marco de trabajo listo!</h4>');
                        Write('<p><strong>PrÃ³ximos pasos:</strong></p>');
                        Write('<ol>');
                        Write('<li>Ve a Content Builder y verifica los Content Blocks con prefijo "OMG_FW_"</li>');
                        Write('<li>Revisa las Data Extensions creadas: OmegaFramework_Logs, OmegaFramework_Config, OmegaFramework_AlertQueue</li>');
                        Write('<li>Comienza a usar el framework en tus CloudPages y emails</li>');
                        Write('</ol>');
                        Write('</div>');
                    }
                    
                    if (resultObj.data.errors && resultObj.data.errors.length > 0) {
                        Write('<div class="warning">');
                        Write('<h4>âš ï¸ Errores encontrados:</h4>');
                        Write('<ul>');
                        for (var i = 0; i < resultObj.data.errors.length; i++) {
                            var error = resultObj.data.errors[i];
                            Write('<li><strong>' + error.asset + ' (' + error.name + '):</strong> ' + (error.error.message || error.error) + '</li>');
                        }
                        Write('</ul>');
                        Write('</div>');
                    }
                } else if (!resultObj.success) {
                    Write('<p><strong>Error:</strong> ' + (resultObj.error ? resultObj.error.message : 'Error desconocido') + '</p>');
                }
                
                Write('<details>');
                Write('<summary>Ver detalles tÃ©cnicos completos</summary>');
                Write('<pre>' + installResult + '</pre>');
                Write('</details>');
                
                Write('</div>');
            }
        </script>
    </div>

    <script>
        // Client-side progress management
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('installForm');
            const progressFill = document.getElementById('progressFill');
            
            form.addEventListener('submit', function(e) {
                const submitButton = e.submitter;
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<span class="loading"></span> Instalando...';
                    progressFill.style.width = '75%';
                }
            });
        });
    </script>
</body>
</html>