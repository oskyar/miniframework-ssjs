<script runat="server">
    Platform.Load("core", "1.1.1");

    /**
     * FolderStructureManager v2.0 - Advanced Folder Management for SFMC
     *
     * Features:
     * - Load existing folder structure via REST API
     * - Visual folder selection interface
     * - Create folder hierarchies with API calls
     * - Automatic existence checking
     *
     * @version 2.0.0
     */

    var action = Request.GetQueryStringParameter('action') || Request.GetFormField('action');
    if (!String.prototype.trim) { // Polyfill for trim
        String.prototype.trim = function() {
            return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g, '');
        };
    }
    if (action === 'loadFolders') {
        // ============================================
        // API MODE: Return folders as JSON
        // ============================================

        Platform.Response.SetResponseHeader("Content-Type", "application/json");

        var clientId = Request.GetFormField('clientId');
        var clientSecret = Request.GetFormField('clientSecret');
        var authBaseUrl = Request.GetFormField('authBaseUrl');
        var targetMID = Request.GetFormField('targetMID');
        var categoryType = Request.GetFormField('categoryType') || 'asset';

        try {
            // Get token
            var tokenUrl = authBaseUrl;
            if (tokenUrl.charAt(tokenUrl.length - 1) !== '/') {
                tokenUrl += '/';
            }
            tokenUrl += 'v2/token';

            var tokenPayload = {
                grant_type: 'client_credentials',
                client_id: clientId,
                client_secret: clientSecret
            };

            if(targetMID && targetMID.length > 0) {
                tokenPayload.account_id = targetMID;
            }

            var tokenRequest = new Script.Util.HttpRequest(tokenUrl);
            tokenRequest.emptyContentHandling = 0;
            tokenRequest.retries = 2;
            tokenRequest.continueOnError = true;
            tokenRequest.contentType = 'application/json';
            tokenRequest.method = 'POST';
            tokenRequest.postData = Stringify(tokenPayload);

            var tokenResponse = tokenRequest.send();

            if (tokenResponse.statusCode != 200) {
                Write(Stringify({
                    success: false,
                    error: 'Authentication failed with status: ' + tokenResponse.statusCode
                }));
            } else {
                var tokenData = Platform.Function.ParseJSON(String(tokenResponse.content));
                var accessToken = tokenData.access_token;
                var restInstanceUrl = tokenData.rest_instance_url;

                // Load all folders (no filter - we'll use categoryType only when creating)
                var allFolders = [];
                var pageSize = 500;
                var page = 1;
                var hasMore = true;

                while (hasMore && page < 10) {
                    var foldersUrl = restInstanceUrl + '/asset/v1/content/categories?$pageSize=' + pageSize + '&$page=' + page;
                    var foldersRequest = new Script.Util.HttpRequest(foldersUrl);
                    foldersRequest.emptyContentHandling = 0;
                    foldersRequest.retries = 2;
                    foldersRequest.continueOnError = true;
                    foldersRequest.method = 'GET';
                    foldersRequest.setHeader('Authorization', 'Bearer ' + accessToken);

                    // Add MID header if specified
                    if (targetMID && targetMID.length > 0) {
                        foldersRequest.setHeader('fuelapi-EnterpriseId', targetMID);
                    }

                    var foldersResponse = foldersRequest.send();

                    if (foldersResponse.statusCode == 200) {
                        var foldersData = Platform.Function.ParseJSON(String(foldersResponse.content));

                        if (foldersData.items && foldersData.items.length > 0) {
                            for (var f = 0; f < foldersData.items.length; f++) {
                                allFolders.push(foldersData.items[f]);
                            }

                            if (foldersData.count > page * pageSize) {
                                page++;
                            } else {
                                hasMore = false;
                            }
                        } else {
                            hasMore = false;
                        }
                    } else {
                        hasMore = false;
                    }
                }

                // Return JSON response
                Write(Stringify({
                    success: true,
                    folders: allFolders,
                    token: accessToken,
                    restUrl: restInstanceUrl,
                    targetMID: targetMID || ''
                }));
            }

        } catch (ex) {
            Write(Stringify({
                success: false,
                error: 'Error: ' + (ex.message || ex.toString())
            }));
        }

    } else if (action === 'loadFoldersWSProxy') {
        // ============================================
        // WSProxy MODE: Return folders using SSJS WSProxy
        // ============================================

        Platform.Response.SetResponseHeader("Content-Type", "application/json");

        var categoryType = Request.GetFormField('categoryType') || 'asset';
        var targetMID = Request.GetFormField('targetMID');

        try {
            // Initialize WSProxy with ClientID if targetMID is specified
            var prox = {
                context: {}
            };

            if (targetMID && targetMID.length > 0) {
                prox.context.ClientID = targetMID;
            }

            var api = new Script.Util.WSProxy();

            // Retrieve folders using WSProxy
            var request = api.retrieve("DataFolder",
                [
                    "Name",
                    "ID",
                    "ContentType",
                    "ParentFolder.ID",
                    "ParentFolder.Name",
                    "CustomerKey"
                ],
                {
                    Property: "ContentType",
                    SimpleOperator: "equals",
                    Value: categoryType
                }
            );

            if (request.Status === "OK" || request.Status === "MoreDataAvailable") {
                var allFolders = [];

                // Process results
                for (var i = 0; i < request.Results.length; i++) {
                    var folder = request.Results[i];
                    allFolders.push({
                        id: folder.ID,
                        name: folder.Name,
                        parentId: folder.ParentFolder ? folder.ParentFolder.ID : 0,
                        contentType: folder.ContentType,
                        customerKey: folder.CustomerKey || ''
                    });
                }

                // Handle pagination if more data available
                while (request.Status === "MoreDataAvailable") {
                    request = api.getNextBatch();

                    if (request.Status === "OK" || request.Status === "MoreDataAvailable") {
                        for (var j = 0; j < request.Results.length; j++) {
                            var folderBatch = request.Results[j];
                            allFolders.push({
                                id: folderBatch.ID,
                                name: folderBatch.Name,
                                parentId: folderBatch.ParentFolder ? folderBatch.ParentFolder.ID : 0,
                                contentType: folderBatch.ContentType,
                                customerKey: folderBatch.CustomerKey || ''
                            });
                        }
                    }
                }

                Write(Stringify({
                    success: true,
                    folders: allFolders,
                    method: 'WSProxy',
                    totalFolders: allFolders.length
                }));

            } else {
                Write(Stringify({
                    success: false,
                    error: 'WSProxy retrieve failed with status: ' + request.Status
                }));
            }

        } catch (ex) {
            Write(Stringify({
                success: false,
                error: 'WSProxy Error: ' + (ex.message || ex.toString())
            }));
        }

    } else if (action === 'createFoldersWSProxy') {
        // ============================================
        // WSProxy MODE: Create folder structure using SSJS
        // ============================================

        Write('<!DOCTYPE html><html><head><meta charset="UTF-8">');
        Write('<title>Creating Folder Structure...</title>');
        Write('<style>');
        Write('body { font-family: Arial, sans-serif; max-width: 1000px; margin: 40px auto; padding: 20px; background: #f5f5f5; }');
        Write('.header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 20px; }');
        Write('.progress { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }');
        Write('.item { padding: 10px; margin: 8px 0; border-radius: 5px; border-left: 4px solid #ccc; }');
        Write('.success { background-color: #d4edda; border-left-color: #28a745; }');
        Write('.info { background-color: #d1ecf1; border-left-color: #0c5460; }');
        Write('.exists { background-color: #cfe2ff; border-left-color: #0d6efd; }');
        Write('.error { background-color: #f8d7da; border-left-color: #dc3545; }');
        Write('.summary { margin-top: 20px; padding: 20px; background: #e7f3ff; border-radius: 8px; }');
        Write('</style></head><body>');
        Write('<div class="header"><h1>üìÅ Creating Folder Structure (WSProxy)</h1></div>');
        Write('<div class="progress">');

        try {
            var parentFolderId = Request.GetFormField('parentFolderId');
            var folderStructure = Request.GetFormField('folderStructure');
            var allFoldersJson = Request.GetFormField('allFolders');
            var categoryType = Request.GetFormField('categoryType') || 'asset';

            if (!folderStructure) {
                throw new Error('No folder structure provided');
            }

            // Parse existing folders
            var existingFolders = Platform.Function.ParseJSON(allFoldersJson);
            var folderMap = {};
            for (var i = 0; i < existingFolders.length; i++) {
                var folder = existingFolders[i];
                var key = folder.name + '_' + folder.parentId;
                folderMap[key] = folder.id;
            }

            Write('<div class="item info">üìã Loaded ' + existingFolders.length + ' existing folders</div>');
            Write('<div class="item info">üìÅ Parent folder ID: ' + parentFolderId + '</div>');
            Write('<div class="item info">üìÇ Category Type: ' + categoryType + '</div>');
            Write('<hr style="margin: 20px 0;">');

            // Initialize WSProxy with ClientID if targetMID is specified
            var prox = {
                context: {}
            };

            var targetMID = Request.GetFormField('targetMID');
            if (targetMID && targetMID.length > 0) {
                prox.context.ClientID = targetMID;
                Write('<div class="item info">üéØ Target MID: ' + targetMID + '</div>');
            }

            var api = new Script.Util.WSProxy(prox);
            var lines = folderStructure.split('\n');
            var folderStack = [];
            var createdCount = 0;
            var existingCount = 0;
            var errorCount = 0;

            for (var i = 0; i < lines.length; i++) {
                var line = lines[i];

                if (!line || line.trim() == '') {
                    continue;
                }

                var indentMatch = line.match(/^(\s*)/);
                var indentLevel = 0;
                if (indentMatch && indentMatch[1]) {
                    indentLevel = Math.floor(indentMatch[1].length / 2);
                }

                var folderName = line.trim();

                if (!folderName) {
                    continue;
                }

                try {
                    var currentParent = null;
                    if (indentLevel == 0) {
                        currentParent = parentFolderId;
                        folderStack = [];
                    } else if (indentLevel > 0 && folderStack.length >= indentLevel) {
                        currentParent = folderStack[indentLevel - 1];
                    } else {
                        currentParent = parentFolderId;
                    }

                    var folderKey = folderName + '_' + currentParent;
                    var existingId = folderMap[folderKey];

                    if (existingId) {
                        Write('<div class="item exists">‚ÑπÔ∏è Already exists: ' + folderName + ' (ID: ' + existingId + ')</div>');
                        folderStack[indentLevel] = existingId;
                        existingCount++;
                    } else {
                        Write('<div class="item info">üîÑ Creating: ' + folderName + '...</div>');

                        // Generate unique customer key
                        var customerKey = 'folder_' + folderName.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase() + '_' + new Date().getTime();

                        var newFolder = {
                            Name: folderName,
                            CustomerKey: customerKey,
                            Description: 'Created by FolderStructureManager',
                            ContentType: categoryType,
                            IsActive: true,
                            IsEditable: true,
                            AllowChildren: true
                        };

                        if (currentParent && currentParent != '0') {
                            newFolder.ParentFolder = {
                                ID: parseInt(currentParent)
                            };
                        }

                        var result = api.createItem("DataFolder", newFolder);

                        if (result.Status === "OK" && result.Results && result.Results.length > 0) {
                            var newFolderId = result.Results[0].NewID || result.Results[0].Object.ID;
                            Write('<div class="item success">‚úÖ Created: ' + folderName + ' (ID: ' + newFolderId + ', Key: ' + customerKey + ')</div>');
                            folderStack[indentLevel] = newFolderId;
                            folderMap[folderKey] = newFolderId;
                            createdCount++;
                        } else {
                            var errorMsg = result.StatusMessage || 'Unknown error';
                            if (result.Results && result.Results[0] && result.Results[0].StatusMessage) {
                                errorMsg = result.Results[0].StatusMessage;
                            }
                            Write('<div class="item error">‚ùå Failed: ' + folderName + ' - ' + errorMsg + '</div>');
                            Write('<div class="item error">Debug: Status=' + result.Status + ', StatusCode=' + result.StatusCode + '</div>');
                            errorCount++;
                        }
                    }

                } catch (folderEx) {
                    Write('<div class="item error">‚ùå Error: ' + folderName + ' - ' + Stringify(folderEx) + '</div>');
                    errorCount++;
                }
            }

            Write('<hr style="margin: 20px 0;">');
            Write('<div class="summary">');
            Write('<h3>üìä Summary</h3>');
            Write('<p><strong>Total:</strong> ' + (createdCount + existingCount + errorCount) + ' folders</p>');
            Write('<p><strong>‚úÖ Created:</strong> ' + createdCount + '</p>');
            Write('<p><strong>‚ÑπÔ∏è Already existed:</strong> ' + existingCount + '</p>');
            Write('<p><strong>‚ùå Errors:</strong> ' + errorCount + '</p>');

            if (errorCount == 0) {
                Write('<p style="color: green; font-weight: bold; font-size: 1.2em; margin-top: 15px;">üéâ Folder structure created successfully!</p>');
            } else {
                Write('<p style="color: orange; font-weight: bold;">‚ö†Ô∏è Completed with some errors</p>');
            }
            Write('</div>');

        } catch (ex) {
            Write('<div class="item error"><h3>‚ùå Fatal Error</h3><p>' + ex.message + '</p></div>');
        }

        Write('</div>');
        Write('<a href="?" style="display: inline-block; margin: 20px; padding: 12px 24px; background: #667eea; color: white; text-decoration: none; border-radius: 8px;">‚Üê Back to Form</a>');
        Write('</body></html>');

    } else if (action === 'createFolders') {
        // ============================================
        // API MODE: Create folder structure using REST API
        // ============================================

        Write('<!DOCTYPE html><html><head><meta charset="UTF-8">');
        Write('<title>Creating Folder Structure...</title>');
        Write('<style>');
        Write('body { font-family: Arial, sans-serif; max-width: 1000px; margin: 40px auto; padding: 20px; background: #f5f5f5; }');
        Write('.header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 20px; }');
        Write('.progress { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }');
        Write('.item { padding: 10px; margin: 8px 0; border-radius: 5px; border-left: 4px solid #ccc; }');
        Write('.success { background-color: #d4edda; border-left-color: #28a745; }');
        Write('.info { background-color: #d1ecf1; border-left-color: #0c5460; }');
        Write('.exists { background-color: #cfe2ff; border-left-color: #0d6efd; }');
        Write('.error { background-color: #f8d7da; border-left-color: #dc3545; }');
        Write('.summary { margin-top: 20px; padding: 20px; background: #e7f3ff; border-radius: 8px; }');
        Write('</style></head><body>');
        Write('<div class="header"><h1>üìÅ Creating Folder Structure</h1></div>');
        Write('<div class="progress">');

        try {
            var accessToken = Request.GetFormField('accessToken');
            var restInstanceUrl = Request.GetFormField('restInstanceUrl');
            var parentFolderId = Request.GetFormField('parentFolderId');
            var folderStructure = Request.GetFormField('folderStructure');
            var allFoldersJson = Request.GetFormField('allFolders');
            var targetMID = Request.GetFormField('targetMID');
            var categoryType = Request.GetFormField('categoryType') || 'asset';

            if (!folderStructure) {
                throw new Error('No folder structure provided');
            }

            // Parse existing folders
            var existingFolders = Platform.Function.ParseJSON(allFoldersJson);
            var folderMap = {};
            for (var i = 0; i < existingFolders.length; i++) {
                var folder = existingFolders[i];
                var key = folder.name + '_' + folder.parentId;
                folderMap[key] = folder.id;
            }

            Write('<div class="item info">üìã Loaded ' + existingFolders.length + ' existing folders</div>');
            Write('<div class="item info">üìÅ Parent folder ID: ' + parentFolderId + '</div>');
            Write('<hr style="margin: 20px 0;">');

            // Parse folder structure
            var lines = folderStructure.split('\n');
            var folderStack = [];
            var createdCount = 0;
            var existingCount = 0;
            var errorCount = 0;

            for (var i = 0; i < lines.length; i++) {
                var line = lines[i];

                if (!line || line.trim() == '') {
                    continue;
                }

                // Calculate indentation (2 spaces = 1 level)
                var indentMatch = line.match(/^(\s*)/);
                var indentLevel = 0;
                if (indentMatch && indentMatch[1]) {
                    indentLevel = Math.floor(indentMatch[1].length / 2);
                }

                var folderName = line.trim();

                if (!folderName) {
                    continue;
                }

                try {
                    // Determine parent
                    var currentParent = null;
                    if (indentLevel == 0) {
                        currentParent = parentFolderId;
                        folderStack = [];
                    } else if (indentLevel > 0 && folderStack.length >= indentLevel) {
                        currentParent = folderStack[indentLevel - 1];
                    } else {
                        currentParent = parentFolderId;
                    }

                    // Check if exists
                    var folderKey = folderName + '_' + currentParent;
                    var existingId = folderMap[folderKey];

                    if (existingId) {
                        Write('<div class="item exists">‚ÑπÔ∏è Already exists: ' + folderName + ' (ID: ' + existingId + ')</div>');
                        folderStack[indentLevel] = existingId;
                        existingCount++;
                    } else {
                        // Create folder
                        Write('<div class="item info">üîÑ Creating: ' + folderName + '...</div>');

                        var folderPayload = {
                            name: folderName,
                            parentId: parseInt(currentParent),
                            categoryType: categoryType,
                            description: 'Created by FolderStructureManager'
                        };

                        var folderUrl = restInstanceUrl + '/asset/v1/content/categories';
                        var folderRequest = new Script.Util.HttpRequest(folderUrl);
                        folderRequest.emptyContentHandling = 0;
                        folderRequest.retries = 2;
                        folderRequest.continueOnError = true;
                        folderRequest.contentType = 'application/json';
                        folderRequest.method = 'POST';
                        folderRequest.setHeader('Authorization', 'Bearer ' + accessToken);

                        // Add MID header if specified
                        if (targetMID && targetMID.length > 0) {
                            folderRequest.setHeader('fuelapi-EnterpriseId', targetMID);
                        }

                        folderRequest.postData = Stringify(folderPayload);

                        var folderResponse = folderRequest.send();

                        if (folderResponse.statusCode == 200 || folderResponse.statusCode == 201) {
                            var folderData = Platform.Function.ParseJSON(String(folderResponse.content));
                            var newFolderId = folderData.id;

                            Write('<div class="item success">‚úÖ Created: ' + folderName + ' (ID: ' + newFolderId + ')</div>');
                            folderStack[indentLevel] = newFolderId;
                            folderMap[folderKey] = newFolderId;
                            createdCount++;
                        } else {
                            Write('<div class="item error">‚ùå Failed: ' + folderName + ' - Status: ' + folderResponse.statusCode + '</div>');
                            errorCount++;
                        }
                    }

                } catch (folderEx) {
                    Write('<div class="item error">‚ùå Error: ' + folderName + ' - ' + folderEx.message + '</div>');
                    errorCount++;
                }
            }

            // Summary
            Write('<hr style="margin: 20px 0;">');
            Write('<div class="summary">');
            Write('<h3>üìä Summary</h3>');
            Write('<p><strong>Total:</strong> ' + (createdCount + existingCount + errorCount) + ' folders</p>');
            Write('<p><strong>‚úÖ Created:</strong> ' + createdCount + '</p>');
            Write('<p><strong>‚ÑπÔ∏è Already existed:</strong> ' + existingCount + '</p>');
            Write('<p><strong>‚ùå Errors:</strong> ' + errorCount + '</p>');

            if (errorCount == 0) {
                Write('<p style="color: green; font-weight: bold; font-size: 1.2em; margin-top: 15px;">üéâ Folder structure created successfully!</p>');
            } else {
                Write('<p style="color: orange; font-weight: bold;">‚ö†Ô∏è Completed with some errors</p>');
            }
            Write('</div>');

        } catch (ex) {
            Write('<div class="item error"><h3>‚ùå Fatal Error</h3><p>' + ex.message + '</p></div>');
        }

        Write('</div>');
        Write('<a href="?" style="display: inline-block; margin: 20px; padding: 12px 24px; background: #667eea; color: white; text-decoration: none; border-radius: 8px;">‚Üê Back to Form</a>');
        Write('</body></html>');

    } else {
        // ============================================
        // MODE: Show form
        // ============================================
</script>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SFMC Folder Structure Manager v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .step {
            display: none;
            animation: fadeIn 0.5s;
        }

        .step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .step-item {
            flex: 1;
            text-align: center;
            padding: 15px;
            position: relative;
            color: #999;
            font-weight: 600;
        }

        .step-item.active {
            color: #667eea;
        }

        .step-item.completed {
            color: #28a745;
        }

        .step-item::before {
            content: attr(data-step);
            display: block;
            width: 40px;
            height: 40px;
            line-height: 40px;
            margin: 0 auto 10px;
            background: #e0e0e0;
            color: white;
            border-radius: 50%;
            font-weight: bold;
        }

        .step-item.active::before {
            background: #667eea;
        }

        .step-item.completed::before {
            background: #28a745;
            content: "‚úì";
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group textarea {
            font-family: 'Courier New', monospace;
            resize: vertical;
            min-height: 250px;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .folder-tree {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }

        .folder-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .folder-controls .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: #667eea;
            color: white;
            transition: all 0.2s;
        }

        .folder-controls .btn-small:hover {
            background: #5568d3;
        }

        .folder-controls select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
        }

        .folder-controls label {
            font-weight: 600;
            color: #333;
            margin-left: auto;
        }

        .folder-item-wrapper {
            margin: 2px 0;
        }

        .folder-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }

        .folder-item:hover {
            background: #e7f3ff;
        }

        .folder-item.selected {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .folder-item.level-0 { padding-left: 12px; }
        .folder-item.level-1 { padding-left: 32px; }
        .folder-item.level-2 { padding-left: 52px; }
        .folder-item.level-3 { padding-left: 72px; }
        .folder-item.level-4 { padding-left: 92px; }
        .folder-item.level-5 { padding-left: 112px; }

        .expand-icon {
            display: inline-block;
            width: 16px;
            margin-right: 5px;
            cursor: pointer;
            user-select: none;
            font-size: 12px;
            transition: transform 0.2s;
        }

        .expand-icon.expanded {
            transform: rotate(90deg);
        }

        .folder-children {
            display: none;
        }

        .folder-children.expanded {
            display: block;
        }

        .btn {
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loading.active {
            display: flex;
        }

        .loading-content {
            text-align: center;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.1em;
            color: #333;
            font-weight: 600;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #0d6efd;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .selected-folder {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .example-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .example-box pre {
            font-family: 'Courier New', monospace;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÅ Folder Structure Manager v2.0</h1>
            <p>Advanced folder management for Salesforce Marketing Cloud</p>
        </div>

        <div class="content">
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step-item active" data-step="1">
                    <span>Authentication</span>
                </div>
                <div class="step-item" data-step="2">
                    <span>Select Parent</span>
                </div>
                <div class="step-item" data-step="3">
                    <span>Define Structure</span>
                </div>
            </div>

            <!-- Step 1: Authentication -->
            <div class="step active" id="step1">
                <h2>Step 1: Configuration</h2>
                <p style="margin-bottom: 20px; color: #666;">Configure the method to load and manage folder structure.</p>

                <div class="form-group">
                    <label for="loadMethod">Load Method</label>
                    <select id="loadMethod" onchange="updateMethodFields()">
                        <option value="wsproxy">WSProxy (SSJS - No credentials needed)</option>
                        <option value="api">REST API (Content Builder only)</option>
                    </select>
                    <div class="help-text" style="color: #666; font-size: 0.9em; margin-top: 5px;">
                        <strong>WSProxy:</strong> Fast, no API credentials needed. Works with all folder types except Content Builder.<br>
                        <strong>REST API:</strong> Requires credentials. Only for Content Builder folders.
                    </div>
                </div>

                <!-- WSProxy Fields -->
                <div id="wsproxyFields">
                    <div class="form-group">
                        <label for="targetMID">Target MID (Optional)</label>
                        <input type="text" id="targetMID" placeholder="Leave empty for current BU">
                        <div class="help-text" style="color: #666; font-size: 0.9em; margin-top: 5px;">
                            Enter the MID of the Business Unit. Leave empty to use current BU.
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="categoryType">Folder Type</label>
                        <select id="categoryType">
                            <option value="asset">Content Builder</option>
                            <option value="dataextension">Data Extensions</option>
                            <option value="shared_dataextension">Shared Data Extensions</option>
                            <option value="email">Emails</option>
                            <option value="template">Templates</option>
                            <option value="list">Lists</option>
                            <option value="automations">Automation Studio</option>
                        </select>
                    </div>
                </div>

                <!-- API Fields -->
                <div id="apiFields" style="display: none;">
                    <div class="form-group">
                        <label for="clientId">Client ID <span style="color: red;">*</span></label>
                        <input type="text" id="clientId" placeholder="Enter your Client ID" required>
                    </div>

                    <div class="form-group">
                        <label for="clientSecret">Client Secret <span style="color: red;">*</span></label>
                        <input type="password" id="clientSecret" placeholder="Enter your Client Secret" required>
                    </div>

                    <div class="form-group">
                        <label for="authBaseUrl">Auth Base URL <span style="color: red;">*</span></label>
                        <input type="text" id="authBaseUrl" placeholder="https://YOUR_SUBDOMAIN.auth.marketingcloudapis.com/" required>
                    </div>

                    <div class="form-group">
                        <label for="targetMIDApi">Target MID (Optional)</label>
                        <input type="text" id="targetMIDApi" placeholder="Leave empty for current BU">
                    </div>

                    <div class="form-group">
                        <label>Folder Type</label>
                        <input type="text" value="Content Builder" disabled style="background: #e9ecef;">
                        <input type="hidden" id="categoryTypeApi" value="asset">
                    </div>
                </div>

                <button class="btn btn-primary" onclick="loadFolders()">Load Folders ‚Üí</button>
            </div>

            <!-- Step 2: Select Parent Folder -->
            <div class="step" id="step2">
                <h2>Step 2: Select Parent Folder</h2>
                <p style="margin-bottom: 20px; color: #666;">Choose where to create the folder structure. Click on a folder to select it.</p>

                <div class="info-box">
                    <strong>üìÇ Category Type:</strong> <span id="categoryTypeDisplay"></span>
                </div>

                <div class="selected-folder" id="selectedFolderInfo" style="display: none;">
                    <strong>üìÅ Selected:</strong> <span id="selectedFolderName"></span> (ID: <span id="selectedFolderId"></span>)
                </div>

                <div class="folder-controls">
                    <button class="btn-small" onclick="collapseAll()">Collapse All</button>
                    <button class="btn-small" onclick="expandAll()">Expand All</button>
                    <label for="maxLevel">Max Level:</label>
                    <select id="maxLevel" onchange="updateMaxLevel()">
                        <option value="99">All Levels</option>
                        <option value="1">Level 1</option>
                        <option value="2">Level 2</option>
                        <option value="3">Level 3</option>
                        <option value="4">Level 4</option>
                        <option value="5">Level 5</option>
                    </select>
                </div>

                <div class="folder-tree" id="folderTree">
                    <p style="text-align: center; color: #999;">Loading folders...</p>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="showStep(1)">‚Üê Back</button>
                    <button class="btn btn-primary" onclick="showStep(3)" id="btnNext2" disabled>Next ‚Üí</button>
                </div>
            </div>

            <!-- Step 3: Define Folder Structure -->
            <div class="step" id="step3">
                <h2>Step 3: Define Folder Structure</h2>
                <p style="margin-bottom: 20px; color: #666;">Enter the folder structure to create. Use 2 spaces for each indentation level.</p>

                <div class="selected-folder">
                    <strong>üìÅ Creating inside:</strong> <span id="finalFolderName"></span> (ID: <span id="finalFolderId"></span>)
                </div>

                <div class="form-group">
                    <label for="folderStructure">Folder Structure</label>
                    <textarea id="folderStructure" placeholder="Enter folder structure..."></textarea>
                </div>

                <div class="example-box">
                    <h4>Example:</h4>
                    <pre>Marketing
  Campaigns
    2024
      Q1
      Q2
  Newsletters
Analytics
  Reports</pre>
                </div>

                <form method="POST" id="createForm">
                    <input type="hidden" name="action" id="hiddenAction" value="createFolders">
                    <input type="hidden" name="accessToken" id="hiddenToken">
                    <input type="hidden" name="restInstanceUrl" id="hiddenRestUrl">
                    <input type="hidden" name="parentFolderId" id="hiddenParentId">
                    <input type="hidden" name="folderStructure" id="hiddenStructure">
                    <input type="hidden" name="allFolders" id="hiddenAllFolders">
                    <input type="hidden" name="targetMID" id="hiddenTargetMID">
                    <input type="hidden" name="categoryType" id="hiddenCategoryType">
                    <input type="hidden" name="loadMethod" id="hiddenLoadMethod">

                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button type="button" class="btn btn-secondary" onclick="showStep(2)">‚Üê Back to Select Parent</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">üîÑ Back to Form</button>
                        <button type="submit" class="btn btn-primary" style="margin-left: auto;">üöÄ Create Structure</button>
                    </div>
                </form>
            </div>

            <!-- Loading indicator -->
            <div class="loading" id="loading">
                <div class="loading-content">
                    <div class="spinner"></div>
                    <p class="loading-text">Loading folders from SFMC...</p>
                    <p style="color: #999; font-size: 0.9em; margin-top: 10px;">This may take a few seconds</p>
                </div>
            </div>
        </div>
    </div>

    %%=Concat('<s','cript>')=%%
        var currentStep = 1;
        var loadedFolders = [];
        var accessToken = '';
        var restInstanceUrl = '';
        var selectedFolderId = null;
        var selectedFolderName = '';
        var targetMID = '';
        var categoryType = 'asset';
        var loadMethod = 'wsproxy';
        var currentMaxLevel = 99;
        var folderHierarchy = null;

        function renderFolderTree(folders) {
            var treeContainer = document.getElementById('folderTree');
            treeContainer.innerHTML = '';

            if (!folders || folders.length === 0) {
                treeContainer.innerHTML = '<p style="text-align: center; color: #999;">No folders found</p>';
                return;
            }

            // Build folder hierarchy
            var folderMap = {};
            var rootFolders = [];

            // First pass: create map
            for (var i = 0; i < folders.length; i++) {
                var folder = folders[i];
                folder.children = [];
                folderMap[folder.id] = folder;
            }

            // Second pass: build hierarchy
            for (var i = 0; i < folders.length; i++) {
                var folder = folders[i];
                if (folder.parentId && folderMap[folder.parentId]) {
                    folderMap[folder.parentId].children.push(folder);
                } else {
                    rootFolders.push(folder);
                }
            }

            // Store hierarchy for later use
            folderHierarchy = {
                folderMap: folderMap,
                rootFolders: rootFolders
            };

            // Sort folders alphabetically
            rootFolders.sort(function(a, b) {
                return a.name.localeCompare(b.name);
            });

            // Render tree
            var html = '';
            for (var i = 0; i < rootFolders.length; i++) {
                html += renderFolderItem(rootFolders[i], 0);
            }

            treeContainer.innerHTML = html;
        }

        function renderFolderItem(folder, level) {
            // Check max level
            if (level > currentMaxLevel) {
                return '';
            }

            var hasChildren = folder.children && folder.children.length > 0;
            var folderId = 'folder_' + folder.id;

            // Determine if should be expanded by default (only Content Builder children)
            var shouldExpand = false;
            if (folder.name === 'Content Builder' || (folder.parentName && folder.parentName === 'Content Builder')) {
                shouldExpand = true;
            }

            var html = '<div class="folder-item-wrapper">';

            // Folder item
            html += '<div class="folder-item level-' + Math.min(level, 5) + '" data-folder-id="' + folder.id + '" data-folder-name="' + escapeHtml(folder.name) + '">';

            // Expand/collapse icon (only if has children)
            if (hasChildren) {
                html += '<span class="expand-icon ' + (shouldExpand ? 'expanded' : '') + '" data-target-folder="' + folderId + '" onclick="toggleFolderById(this)" id="icon_' + folderId + '">&#9654;</span>';
            } else {
                html += '<span style="display: inline-block; width: 16px; margin-right: 5px;"></span>';
            }

            // Folder name and ID (clickable for selection)
            html += '<span onclick="selectFolderByClick(this)" style="flex: 1; cursor: pointer;">';
            html += '&#128193; ' + escapeHtml(folder.name) + ' <span style="color: #999; font-size: 0.9em;">(ID: ' + folder.id + ')</span>';
            html += '</span>';

            html += '</div>';

            // Render children
            if (hasChildren && level < currentMaxLevel) {
                folder.children.sort(function(a, b) {
                    return a.name.localeCompare(b.name);
                });

                html += '<div class="folder-children ' + (shouldExpand ? 'expanded' : '') + '" id="' + folderId + '">';
                for (var i = 0; i < folder.children.length; i++) {
                    folder.children[i].parentName = folder.name;
                    html += renderFolderItem(folder.children[i], level + 1);
                }
                html += '</div>';
            }

            html += '</div>';
            return html;
        }

        function escapeHtml(text) {
            var map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        function updateMethodFields() {
            var loadMethod = document.getElementById('loadMethod').value;
            var wsproxyFields = document.getElementById('wsproxyFields');
            var apiFields = document.getElementById('apiFields');

            if (loadMethod === 'wsproxy') {
                wsproxyFields.style.display = 'block';
                apiFields.style.display = 'none';
            } else {
                wsproxyFields.style.display = 'none';
                apiFields.style.display = 'block';
            }
        }

        function resetForm() {
            if (confirm('¬øVolver al inicio? Se perder√°n los datos cargados.')) {
                location.reload();
            }
        }

        function showStep(step) {
            // Update step indicator
            document.querySelectorAll('.step-item').forEach(function(item, index) {
                item.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    item.classList.add('completed');
                } else if (index + 1 === step) {
                    item.classList.add('active');
                }
            });

            // Show step content
            document.querySelectorAll('.step').forEach(function(stepEl) {
                stepEl.classList.remove('active');
            });
            document.getElementById('step' + step).classList.add('active');

            currentStep = step;

            // Update final folder info in step 3
            if (step === 3) {
                document.getElementById('finalFolderName').textContent = selectedFolderName;
                document.getElementById('finalFolderId').textContent = selectedFolderId;
            }
        }

        function loadFolders() {
            var loadMethod = document.getElementById('loadMethod').value;
            var categoryTypeValue;
            var targetMIDValue;

            // Show loading
            document.getElementById('loading').classList.add('active');

            if (loadMethod === 'wsproxy') {
                // WSProxy method - use categoryType and targetMID from WSProxy fields
                categoryTypeValue = document.getElementById('categoryType').value;
                targetMIDValue = document.getElementById('targetMID').value.trim();
                loadFoldersWithWSProxy(categoryTypeValue);
            } else {
                // API method - use categoryTypeApi and targetMIDApi, requires credentials
                categoryTypeValue = document.getElementById('categoryTypeApi').value;
                targetMIDValue = document.getElementById('targetMIDApi').value.trim();

                var clientId = document.getElementById('clientId').value.trim();
                var clientSecret = document.getElementById('clientSecret').value.trim();
                var authBaseUrl = document.getElementById('authBaseUrl').value.trim();

                if (!clientId || !clientSecret || !authBaseUrl) {
                    alert('Please fill in all required fields (Client ID, Client Secret, Auth Base URL)');
                    document.getElementById('loading').classList.remove('active');
                    return;
                }

                loadFoldersWithAPI(clientId, clientSecret, authBaseUrl, targetMIDValue, categoryTypeValue);
            }
        }

        function loadFoldersWithWSProxy(categoryTypeValue) {
            // Make AJAX request using WSProxy
            var formData = new FormData();
            formData.append('action', 'loadFoldersWSProxy');
            formData.append('categoryType', categoryTypeValue);

            fetch(window.location.href, {
                method: 'POST',
                body: formData
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                handleFoldersResponse(data, categoryTypeValue);
            })
            .catch(function(error) {
                handleFoldersError(error);
            });
        }

        function loadFoldersWithAPI(clientId, clientSecret, authBaseUrl, targetMIDValue, categoryTypeValue) {
            // Make AJAX request using REST API
            var formData = new FormData();
            formData.append('action', 'loadFolders');
            formData.append('clientId', clientId);
            formData.append('clientSecret', clientSecret);
            formData.append('authBaseUrl', authBaseUrl);
            formData.append('targetMID', targetMIDValue);
            formData.append('categoryType', categoryTypeValue);

            fetch(window.location.href, {
                method: 'POST',
                body: formData
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                // Store API credentials if successful
                if (data.success) {
                    accessToken = data.token;
                    restInstanceUrl = data.restUrl;
                    targetMID = data.targetMID || '';
                }
                handleFoldersResponse(data, categoryTypeValue);
            })
            .catch(function(error) {
                handleFoldersError(error);
            });
        }

        function handleFoldersResponse(data, categoryTypeValue) {
            // Hide loading
            document.getElementById('loading').classList.remove('active');

            if (data.success) {
                // Store data in memory
                loadedFolders = data.folders;
                categoryType = categoryTypeValue;
                loadMethod = data.method === 'WSProxy' ? 'wsproxy' : 'api';

                // Update category type display
                var categoryTypeText;
                var currentLoadMethod = document.getElementById('loadMethod').value;

                if (currentLoadMethod === 'wsproxy') {
                    var select = document.getElementById('categoryType');
                    categoryTypeText = select.options[select.selectedIndex].text;
                } else {
                    categoryTypeText = 'Content Builder';
                }

                // Show method used
                var methodBadge = data.method === 'WSProxy' ?
                    '<span style="background: #28a745; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.85em; margin-left: 10px;">WSProxy</span>' :
                    '<span style="background: #007bff; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.85em; margin-left: 10px;">REST API</span>';

                document.getElementById('categoryTypeDisplay').innerHTML = categoryTypeText + methodBadge;

                // Render folder tree
                renderFolderTree(loadedFolders);

                // Go to step 2
                showStep(2);
            } else {
                // Show error
                alert('Error loading folders: ' + (data.error || 'Unknown error'));
            }
        }

        function handleFoldersError(error) {
            // Hide loading
            document.getElementById('loading').classList.remove('active');
            document.getElementById('step1').style.display = 'block';

            alert('Network error: ' + error.message);
        }

        function toggleFolderById(iconElement) {
            var targetFolderId = iconElement.getAttribute('data-target-folder');
            var childrenContainer = document.getElementById(targetFolderId);
            var icon = iconElement;

            if (childrenContainer) {
                if (childrenContainer.classList.contains('expanded')) {
                    childrenContainer.classList.remove('expanded');
                    icon.classList.remove('expanded');
                } else {
                    childrenContainer.classList.add('expanded');
                    icon.classList.add('expanded');
                }
            }
        }

        function collapseAll() {
            var allChildren = document.querySelectorAll('.folder-children');
            var allIcons = document.querySelectorAll('.expand-icon');

            allChildren.forEach(function(child) {
                child.classList.remove('expanded');
            });

            allIcons.forEach(function(icon) {
                icon.classList.remove('expanded');
            });
        }

        function expandAll() {
            var allChildren = document.querySelectorAll('.folder-children');
            var allIcons = document.querySelectorAll('.expand-icon');

            allChildren.forEach(function(child) {
                child.classList.add('expanded');
            });

            allIcons.forEach(function(icon) {
                icon.classList.add('expanded');
            });
        }

        function updateMaxLevel() {
            var select = document.getElementById('maxLevel');
            currentMaxLevel = parseInt(select.value);

            // Re-render tree with new max level
            if (folderHierarchy) {
                var html = '';
                for (var i = 0; i < folderHierarchy.rootFolders.length; i++) {
                    html += renderFolderItem(folderHierarchy.rootFolders[i], 0);
                }
                document.getElementById('folderTree').innerHTML = html;
            }
        }

        function selectFolderByClick(spanElement) {
            var folderItem = spanElement.closest('.folder-item');
            selectedFolderId = folderItem.getAttribute('data-folder-id');
            selectedFolderName = folderItem.getAttribute('data-folder-name');

            // Update UI
            document.querySelectorAll('.folder-item').forEach(function(item) {
                item.classList.remove('selected');
            });
            folderItem.classList.add('selected');

            // Show selected info
            document.getElementById('selectedFolderInfo').style.display = 'block';
            document.getElementById('selectedFolderName').textContent = selectedFolderName;
            document.getElementById('selectedFolderId').textContent = selectedFolderId;

            // Enable next button
            document.getElementById('btnNext2').disabled = false;
        }

        // Handle form submission
        document.getElementById('createForm').addEventListener('submit', function(e) {
            var structure = document.getElementById('folderStructure').value.trim();

            if (!structure) {
                e.preventDefault();
                alert('Please enter a folder structure');
                return false;
            }

            // Set correct action based on method used
            var action = loadMethod === 'wsproxy' ? 'createFoldersWSProxy' : 'createFolders';
            document.getElementById('hiddenAction').value = action;

            // Fill hidden fields
            document.getElementById('hiddenToken').value = accessToken || '';
            document.getElementById('hiddenRestUrl').value = restInstanceUrl || '';
            document.getElementById('hiddenParentId').value = selectedFolderId;
            document.getElementById('hiddenStructure').value = structure;
            document.getElementById('hiddenAllFolders').value = JSON.stringify(loadedFolders);
            document.getElementById('hiddenTargetMID').value = targetMID || '';
            document.getElementById('hiddenCategoryType').value = categoryType;
            document.getElementById('hiddenLoadMethod').value = loadMethod;

            return true;
        });

        // Initialize method fields on page load
        window.addEventListener('DOMContentLoaded', function() {
            updateMethodFields();
        });
    %%=Concat('</s','cript>')=%%
</body>
</html>
<script runat="server">
    }
</script>
