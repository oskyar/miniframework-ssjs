<script runat="server">
    Platform.Load("Core","1.1.1");
    try{
    </script>
    %%[
    VAR @submitted, @name, @type, @domain, @description, @key, @password, @token, @authUrl, @expirationDate
    VAR @keyEnc, @passwordEnc, @tokenEnc, @success
    VAR @passwordExtKey, @saltExtKey, @initVectorExtKey
    
    SET @success = "false"
    
    SET @passwordExtKey = "Sym_Cred"
    SET @saltExtKey = "Salt_Cred"
    SET @initVectorExtKey = "IV_Cred"
    
    IF RequestParameter("submitted") == "true" THEN
      SET @name = RequestParameter("name")
      SET @type = RequestParameter("type")
      SET @domain = RequestParameter("domain")
      SET @description = RequestParameter("description")
      SET @key = RequestParameter("key")
      SET @password = RequestParameter("password")
      SET @token = RequestParameter("token")
      
    
      SET @keyEnc = IIF(NOT EMPTY(@key), EncryptSymmetric(@key, "aes", @passwordExtKey, null, @saltExtKey, null, @initVectorExtKey, null), "")
      SET @passwordEnc = IIF(NOT EMPTY(@password), EncryptSymmetric(@password, "aes", @passwordExtKey, null, @saltExtKey, null, @initVectorExtKey, null), "")
      SET @tokenEnc = IIF(NOT EMPTY(@token), EncryptSymmetric(@token, "aes", @passwordExtKey, null, @saltExtKey, null, @initVectorExtKey, null), "")
    
      
      IF @type == "client" THEN
        SET @type = "Client ID & Client Secret"
      ELSEIF @type == "userpass" THEN
        SET @type = "Username & Password"
      ELSEIF @type == "token" THEN
        SET @type = "Access Token"
      ENDIF
    
          InsertData("DE_AM_AH_API_Integrations",
          "name", @name,
          "type", @type,
          "domain", @domain,
          "description", @description,
          "key", @keyEnc,
          "password", @passwordEnc,
          "token", @tokenEnc
        )
       
        
      
    
    ]%%
      <div class="success-message">
            <p><strong>Data saved successfully and encrypted.</strong></p>
        </div>
    %%[
    ENDIF
    ]%%
    
    
    <script runat="server">
    }catch(e){
    Write(Stringify(e));
    }
    </script>
    
    <!DOCTYPE html>
    <html lang="es">
    <head>
      <meta charset="UTF-8">
      <title>Formulario API</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 40px; background-color: #f5f5f5; }
        form { background: #fff; padding: 20px; border-radius: 8px; max-width: 600px; margin: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        label { display: block; margin-top: 15px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .hidden { display: none; }
        .success-message {
          background-color: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
          padding: 10px;
          margin: 20px auto;
          border-radius: 5px;
          max-width: 600px;
          text-align: center;
        }
        input[type="submit"] {
          margin-top: 20px;
          background-color: #00E47C;
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 4px;
          cursor: pointer;
        }
        input[type="submit"]:hover { background-color: #0056b3; }
      </style>
    </head>
    <body>
    
    <h1 style="text-align:center;">API Integrations</h1>
    
    
    <form action="%%=RequestParameter('PAGEURL')=%%" method="post" >
        <input type="hidden" name="submitted" value="true" />
      
      <label for="name">Name:</label>
      <input type="text" id="name" name="name" required placeholder="Enter a name">
     <label for="domain">Host: (URL with https://)</label>
      <input type="text" id="domain" name="domain" required placeholder="https://endpoint.domain.com">
    
      <label for="type">Type:</label>
      <select id="type" name="type" required>
        <option value="">-- Select a type --</option>
        <option value="client">Client ID and Client Secret</option>
        <option value="userpass">Username and Password</option>
        <option value="token">Access Token</option>
      </select>
    
     
      <label for="description">Description:</label>
      <textarea id="description" name="description" rows="3" placeholder="Enter a short description"></textarea>
    
      <!-- Client ID / Client Secret -->
      <div id="clientFields" class="hidden">
        <label for="key-client">Client ID:</label>
        <input type="text" id="key-client" name="key" placeholder="Enter Client ID">
    
        <label for="password-client">Client Secret:</label>
        <input type="text" id="password-client" name="password" placeholder="Enter Client Secret">
      </div>
    
      <!-- Username / Password -->
      <div id="userPassFields" class="hidden">
        <label for="key-user">Username:</label>
        <input type="text" id="key-user" name="key" placeholder="Enter username">
    
        <label for="password-user">Password:</label>
        <input type="password" id="password-user" name="password" placeholder="Enter password">
      </div>
    
      <!-- Token -->
      <div id="tokenField" class="hidden">
        <label for="token">Token:</label>
        <input type="text" id="token" name="token" placeholder="[Bearer|Basic] + AccessToken">
    
      </div>
    
      <input type="submit" value="Save" class="boton">
    </form>
    
    <script>
    document.addEventListener("DOMContentLoaded", function () {
      const nameInput = document.getElementById("name");
      const domainInput = document.getElementById("domain");
      const typeSelect = document.getElementById("type");
    
      const clientFields = document.getElementById("clientFields");
      const userPassFields = document.getElementById("userPassFields");
      const tokenField = document.getElementById("tokenField");
    
      typeSelect.addEventListener("change", function () {
        const name = nameInput.value.trim();
        const domain = domainInput.value.trim();
    
        clientFields.classList.add("hidden");
        userPassFields.classList.add("hidden");
        tokenField.classList.add("hidden");
    
        if (!name || !domain) {
          alert("Please complete both 'Name' and 'Domain' before selecting a type.");
          this.value = "";
          return;
        }
    
        if (this.value === "client") {
          clientFields.classList.remove("hidden");
        } else if (this.value === "userpass") {
          userPassFields.classList.remove("hidden");
        } else if (this.value === "token") {
          tokenField.classList.remove("hidden");
        }
      });
    });
    </script>
    
    </body>
    </html>