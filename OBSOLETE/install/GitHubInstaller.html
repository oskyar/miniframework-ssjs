<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmegaFramework GitHub Installer</title>
    <style>
        * {margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
        .container{max-width:900px;margin:0 auto;background:white;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden}
        .header{background:linear-gradient(135deg,#0176d3 0%,#0056a3 100%);color:white;padding:40px;text-align:center}
        .header h1{font-size:2.5em;margin-bottom:10px}
        .header p{font-size:1.1em;opacity:0.9}
        .content{padding:40px}
        .step{margin-bottom:30px;padding:20px;background:#f8f9fa;border-left:4px solid #0176d3;border-radius:5px}
        .step h3{color:#0176d3;margin-bottom:15px}
        .form-group{margin-bottom:20px}
        label{display:block;margin-bottom:8px;font-weight:600;color:#333}
        input[type="text"],input[type="url"]{width:100%;padding:12px 15px;border:2px solid #e0e0e0;border-radius:8px;font-size:1em}
        input:focus{outline:none;border-color:#0176d3}
        .help-text{font-size:0.85em;color:#666;margin-top:5px}
        button{padding:12px 30px;border:none;border-radius:8px;font-size:1em;font-weight:600;cursor:pointer;margin:5px}
        .btn-primary{background:#0176d3;color:white}
        .btn-primary:hover{background:#0056a3;transform:translateY(-2px);transition:all 0.3s}
        .btn-primary:disabled{background:#ccc;cursor:not-allowed;transform:none}
        .alert{padding:15px;border-radius:8px;margin-bottom:20px}
        .alert-info{background:#d1ecf1;border:1px solid #bee5eb;color:#0c5460}
        .alert-success{background:#d4edda;border:1px solid #c3e6cb;color:#155724}
        .alert-danger{background:#f8d7da;border:1px solid #f5c6cb;color:#721c24}
        .alert-warning{background:#fff3cd;border:1px solid #ffeeba;color:#856404}
        .log{background:#2d2d2d;color:#f8f8f2;padding:15px;border-radius:8px;max-height:500px;overflow-y:auto;font-family:'Courier New',monospace;font-size:0.9em;line-height:1.6}
        .log-entry{padding:3px 0}
        .log-success{color:#28a745}
        .log-error{color:#dc3545}
        .log-info{color:#17a2b8}
        .log-warning{color:#ffc107}
        .checkbox{display:flex;align-items:center;margin:15px 0}
        .checkbox input{width:auto;margin-right:10px}
        pre{background:#2d2d2d;color:#f8f8f2;padding:15px;border-radius:5px;overflow-x:auto;font-size:0.9em;margin-top:10px}
        .progress{height:30px;background:#e0e0e0;border-radius:15px;overflow:hidden;margin:20px 0}
        .progress-bar{height:100%;background:linear-gradient(90deg,#0176d3,#28a745);transition:width 0.5s;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold}
        ul{margin-left:20px;margin-top:10px}
        li{margin:5px 0}
    </style>
</head>
<body>

<script runat="server">
Platform.Load("core","1.1.1");

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var FRAMEWORK_VERSION = "1.1.1";
var FRAMEWORK_PREFIX = "OMG_FW_";

// Default GitHub repository (can be overridden by user)
// IMPORTANTE: Debe ser raw.githubusercontent.com, NO github.com
var DEFAULT_GITHUB_REPO = "https://raw.githubusercontent.com/oskyar/miniframework-ssjs/main/";

// Content Blocks configuration
var CONTENT_BLOCKS_CONFIG = [
    {name:"ResponseWrapper", key:"OMG_FW_ResponseWrapper", file:"src/ResponseWrapper.ssjs", required:true, order:1},
    {name:"Settings", key:"OMG_FW_Settings", file:"src/Settings.ssjs", required:true, order:2},
    {name:"AuthHandler", key:"OMG_FW_AuthHandler", file:"src/AuthHandler.ssjs", required:true, order:3},
    {name:"ConnectionHandler", key:"OMG_FW_ConnectionHandler", file:"src/ConnectionHandler.ssjs", required:true, order:4},
    {name:"BaseHandler", key:"OMG_FW_BaseHandler", file:"src/BaseHandler.ssjs", required:true, order:5},
    {name:"Core", key:"OMG_FW_Core", file:"src/Core.ssjs", required:true, order:6},
    {name:"EmailHandler", key:"OMG_FW_EmailHandler", file:"src/EmailHandler.ssjs", required:false, order:7},
    {name:"DataExtensionHandler", key:"OMG_FW_DataExtensionHandler", file:"src/DataExtensionHandler.ssjs", required:false, order:8},
    {name:"AssetHandler", key:"OMG_FW_AssetHandler", file:"src/AssetHandler.ssjs", required:false, order:9},
    {name:"FolderHandler", key:"OMG_FW_FolderHandler", file:"src/FolderHandler.ssjs", required:false, order:10},
    {name:"LogHandler", key:"OMG_FW_LogHandler", file:"src/LogHandler.ssjs", required:false, order:11},
    {name:"AssetCreator", key:"OMG_FW_AssetCreator", file:"src/AssetCreator.ssjs", optional:true, order:12},
    {name:"JourneyCreator", key:"OMG_FW_JourneyCreator", file:"src/JourneyCreator.ssjs", optional:true, order:13}
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN INSTALLATION LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var installAction = Platform.Request.GetFormField("install");
var installationResults = null;

if (installAction === "true") {
    var config = {
        clientId: Platform.Request.GetFormField("clientId"),
        clientSecret: Platform.Request.GetFormField("clientSecret"),
        authBaseUrl: Platform.Request.GetFormField("authBaseUrl"),
        githubRepo: Platform.Request.GetFormField("githubRepo") || DEFAULT_GITHUB_REPO,
        installOptional: (Platform.Request.GetFormField("installOptional") === "on")
    };

    installationResults = runInstallation(config);
}

/**
 * Main installation function
 */
function runInstallation(config) {
    var results = {
        success: true,
        steps: [],
        errors: [],
        warnings: [],
        installed: 0,
        skipped: 0,
        failed: 0
    };

    try {
        addLog(results, "info", "ğŸš€ Iniciando instalaciÃ³n de OmegaFramework v" + FRAMEWORK_VERSION);
        addLog(results, "info", "ğŸ“ Repositorio: " + config.githubRepo);

        // Step 1: Get Auth Token
        addLog(results, "info", "ğŸ” Obteniendo token de autenticaciÃ³n...");
        var authResult = getAuthToken(config.clientId, config.clientSecret, config.authBaseUrl);

        if (!authResult.success) {
            addLog(results, "error", "âŒ Error de autenticaciÃ³n: " + authResult.error);
            results.success = false;
            return results;
        }

        addLog(results, "success", "âœ… Token obtenido correctamente");
        var token = authResult.token;
        var restUrl = authResult.restUrl;

        // Step 2: Create Folder
        addLog(results, "info", "ğŸ“ Creando carpeta OmegaFramework...");
        var folderResult = createFolder("OmegaFramework", 0, token, restUrl);

        if (folderResult.success) {
            addLog(results, "success", "âœ… Carpeta creada (ID: " + folderResult.folderId + ")");
        } else {
            addLog(results, "warning", "âš ï¸ No se pudo crear carpeta, usando raÃ­z (ID: 0)");
            results.warnings.push("Carpeta no creada: " + folderResult.error);
        }

        var folderId = folderResult.folderId || 0;

        // Step 3: Install Content Blocks
        addLog(results, "info", "ğŸ“¦ Instalando Content Blocks desde GitHub...");

        var blocksToInstall = getBlocksToInstall(config.installOptional);

        for (var i = 0; i < blocksToInstall.length; i++) {
            var block = blocksToInstall[i];
            var progress = Math.round(((i + 1) / blocksToInstall.length) * 100);

            addLog(results, "info", "[" + (i + 1) + "/" + blocksToInstall.length + "] " + block.name + "...");

            var blockResult = installContentBlock(block, folderId, token, restUrl, config.githubRepo);

            if (blockResult.success) {
                if (blockResult.skipped) {
                    addLog(results, "info", "    â­ï¸ Ya existe, omitido");
                    results.skipped++;
                } else {
                    addLog(results, "success", "    âœ… Instalado correctamente");
                    results.installed++;
                }
            } else {
                addLog(results, "error", "    âŒ Error: " + blockResult.error);
                results.errors.push(block.name + ": " + blockResult.error);
                results.failed++;

                if (block.required) {
                    results.success = false;
                }
            }
        }

        // Final summary
        addLog(results, "info", "");
        addLog(results, "info", "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

        if (results.success) {
            addLog(results, "success", "ğŸ‰ InstalaciÃ³n completada exitosamente");
        } else {
            addLog(results, "error", "âš ï¸ InstalaciÃ³n completada con errores");
        }

        addLog(results, "info", "ğŸ“Š Resumen:");
        addLog(results, "info", "   â€¢ Instalados: " + results.installed);
        addLog(results, "info", "   â€¢ Omitidos: " + results.skipped);
        addLog(results, "info", "   â€¢ Fallidos: " + results.failed);

    } catch (ex) {
        results.success = false;
        addLog(results, "error", "ğŸ’¥ ExcepciÃ³n crÃ­tica: " + ex.message);
        results.errors.push("ExcepciÃ³n: " + ex.message);
    }

    return results;
}

/**
 * Get authentication token
 */
function getAuthToken(clientId, clientSecret, authBaseUrl) {
    try {
        var tokenUrl = authBaseUrl + "v2/token";
        var payload = {
            grant_type: "client_credentials",
            client_id: clientId,
            client_secret: clientSecret
        };

        var req = new Script.Util.HttpRequest(tokenUrl);
        req.method = "POST";
        req.contentType = "application/json";
        req.postData = Stringify(payload);
        var res = req.send();

        if (res.statusCode == 200) {
            var data = Platform.Function.ParseJSON(res.content);
            return {
                success: true,
                token: data.access_token,
                restUrl: data.rest_instance_url
            };
        } else {
            return {
                success: false,
                error: "HTTP " + res.statusCode
            };
        }
    } catch (ex) {
        return {
            success: false,
            error: ex.message || ex.toString()
        };
    }
}

/**
 * Create folder in Content Builder
 */
function createFolder(folderName, parentId, token, restUrl) {
    try {
        var url = restUrl + "/asset/v1/content/categories";

        // First try to find existing folder
        var searchUrl = url + "?$filter=Name eq '" + folderName + "'";
        var searchReq = new Script.Util.HttpRequest(searchUrl);
        searchReq.method = "GET";
        searchReq.setHeader("Authorization", "Bearer " + token);
        var searchRes = searchReq.send();

        if (searchRes.statusCode == 200) {
            var searchData = Platform.Function.ParseJSON(searchRes.content);
            if (searchData.items && searchData.items.length > 0) {
                return {success: true, folderId: searchData.items[0].id, existed: true};
            }
        }

        // Create new folder
        var payload = {name: folderName, parentId: parentId};
        var req = new Script.Util.HttpRequest(url);
        req.method = "POST";
        req.contentType = "application/json";
        req.setHeader("Authorization", "Bearer " + token);
        req.postData = Stringify(payload);
        var res = req.send();

        if (res.statusCode == 201 || res.statusCode == 200) {
            var data = Platform.Function.ParseJSON(res.content);
            return {success: true, folderId: data.id};
        } else {
            return {success: false, error: "HTTP " + res.statusCode};
        }
    } catch (ex) {
        return {success: false, error: ex.message};
    }
}

/**
 * Install a content block
 */
function installContentBlock(block, folderId, token, restUrl, githubRepo) {
    try {
        // Step 1: Download content from GitHub
        var fileUrl = githubRepo + block.file;
        var contentResult = downloadFromGitHub(fileUrl);

        if (!contentResult.success) {
            return {success: false, error: "No se pudo descargar desde GitHub: " + contentResult.error};
        }

        // Step 2: Create Content Block via REST API
        var url = restUrl + "/asset/v1/content/assets";
        var payload = {
            name: block.name,
            customerKey: block.key,
            assetType: {name: "codesnippetblock", id: 220},
            content: contentResult.content,
            category: {id: folderId}
        };

        var req = new Script.Util.HttpRequest(url);
        req.method = "POST";
        req.contentType = "application/json";
        req.setHeader("Authorization", "Bearer " + token);
        req.postData = Stringify(payload);
        var res = req.send();

        if (res.statusCode == 201 || res.statusCode == 200) {
            return {success: true};
        } else if (res.statusCode == 400 || res.statusCode == 409) {
            // Already exists
            return {success: true, skipped: true};
        } else {
            return {success: false, error: "HTTP " + res.statusCode};
        }
    } catch (ex) {
        return {success: false, error: ex.message};
    }
}

/**
 * Download file from GitHub
 */
function downloadFromGitHub(url) {
    try {
        var req = new Script.Util.HttpRequest(url);
        req.method = "GET";
        req.retries = 2;
        var res = req.send();

        if (res.statusCode == 200 && res.content) {
            return {success: true, content: res.content};
        } else {
            return {success: false, error: "HTTP " + res.statusCode};
        }
    } catch (ex) {
        return {success: false, error: ex.message};
    }
}

/**
 * Get list of blocks to install
 */
function getBlocksToInstall(includeOptional) {
    var blocks = [];
    for (var i = 0; i < CONTENT_BLOCKS_CONFIG.length; i++) {
        var block = CONTENT_BLOCKS_CONFIG[i];
        if (block.optional && !includeOptional) {
            continue;
        }
        blocks.push(block);
    }
    return blocks;
}

/**
 * Add log entry to results
 */
function addLog(results, type, message) {
    results.steps.push({type: type, message: message});
}

</script>

<div class="container">
    <div class="header">
        <h1>ğŸš€ OmegaFramework</h1>
        <p>GitHub Installer v1.1.1 - 100% desde Repositorio</p>
    </div>

    <div class="content">
        <script runat="server">

        // Show installation results if we just ran installation
        if (installAction === "true" && installationResults) {
                // Show results
                if (installationResults.success) {
                    Write('<div class="alert alert-success">');
                    Write('<strong>âœ… InstalaciÃ³n Completada Exitosamente</strong><br>');
                    Write('OmegaFramework v1.1 ha sido instalado desde GitHub.');
                    Write('</div>');
                } else {
                    Write('<div class="alert alert-danger">');
                    Write('<strong>âŒ InstalaciÃ³n Completada con Errores</strong><br>');
                    Write('Algunos componentes no pudieron ser instalados.');
                    Write('</div>');
                }

                // Progress bar
                var total = installationResults.installed + installationResults.skipped + installationResults.failed;
                var successPercent = total > 0 ? Math.round((installationResults.installed / total) * 100) : 0;

                Write('<div class="progress">');
                Write('<div class="progress-bar" style="width:' + successPercent + '%">');
                Write(successPercent + '%');
                Write('</div>');
                Write('</div>');

                // Summary
                Write('<div class="step">');
                Write('<h3>ğŸ“Š Resumen de InstalaciÃ³n</h3>');
                Write('<ul>');
                Write('<li><strong>Instalados:</strong> <span style="color:#28a745">' + installationResults.installed + '</span></li>');
                Write('<li><strong>Omitidos:</strong> <span style="color:#ffc107">' + installationResults.skipped + '</span></li>');
                Write('<li><strong>Fallidos:</strong> <span style="color:#dc3545">' + installationResults.failed + '</span></li>');
                Write('</ul>');
                Write('</div>');

                // Log
                Write('<div class="step">');
                Write('<h3>ğŸ“‹ Log de InstalaciÃ³n</h3>');
                Write('<div class="log">');

                for (var i = 0; i < installationResults.steps.length; i++) {
                    var step = installationResults.steps[i];
                    var cssClass = "log-" + step.type;
                    Write('<div class="log-entry ' + cssClass + '">' + step.message + '</div>');
                }

                Write('</div>');
                Write('</div>');

                // Next steps
                if (installationResults.success) {
                    Write('<div class="step">');
                    Write('<h3>ğŸ¯ PrÃ³ximos Pasos</h3>');
                    Write('<ol>');
                    Write('<li>Ve a <strong>Content Builder</strong> en SFMC</li>');
                    Write('<li>Busca la carpeta <strong>"OmegaFramework"</strong></li>');
                    Write('<li>Verifica que todos los Content Blocks estÃ©n creados</li>');
                    Write('<li>Crea una CloudPage de prueba con el cÃ³digo de ejemplo</li>');
                    Write('</ol>');
                    Write('</div>');

                    Write('<div class="step">');
                    Write('<h3>ğŸ“– Ejemplo de Uso</h3>');
                    Write('<pre>');
                    Write('%%=ContentBlockByKey("OMG_FW_Core")=%%\n');
                    Write('&lt;script runat="server"&gt;\n\n');
                    Write('OmegaFramework.configure({\n');
                    Write('    auth: {\n');
                    Write('        clientId: "' + config.clientId + '",\n');
                    Write('        clientSecret: "' + config.clientSecret + '",\n');
                    Write('        authBaseUrl: "' + config.authBaseUrl + '"\n');
                    Write('    }\n');
                    Write('});\n\n');
                    Write('var info = OmegaFramework.getInfo();\n');
                    Write('Write("Version: " + info.version);\n\n');
                    Write('&lt;/script&gt;');
                    Write('</pre>');
                    Write('</div>');
                }

                Write('<button type="button" class="btn-primary" onclick="window.location.href=window.location.pathname">Nueva InstalaciÃ³n</button>');

        } else {
            // Show installation form
            </script>

            <form method="post" action="" id="installerForm">

                <div class="alert alert-info">
                    <strong>ğŸ“¦ InstalaciÃ³n 100% desde GitHub</strong><br>
                    Este instalador descarga todos los archivos directamente desde tu repositorio de GitHub y crea los Content Blocks automÃ¡ticamente en SFMC.
                    <br><br>
                    <strong>âš¡ Ventajas:</strong>
                    <ul>
                        <li>Siempre instala la Ãºltima versiÃ³n del cÃ³digo</li>
                        <li>FÃ¡cil de mantener: solo actualiza GitHub</li>
                        <li>No requiere actualizar el instalador</li>
                        <li>Transparente: puedes ver el cÃ³digo en GitHub</li>
                    </ul>
                </div>

                <div class="step">
                    <h3>ğŸ”‘ Credenciales de API</h3>

                    <div class="form-group">
                        <label for="clientId">Client ID *</label>
                        <input type="text" id="clientId" name="clientId" required value="46dk2matjf2x53yndqdu206z"
                               placeholder="xxxxxxxxxxxxxxxxxxxxxxxx">
                        <div class="help-text">Desde tu Installed Package en SFMC</div>
                    </div>

                    <div class="form-group">
                        <label for="clientSecret">Client Secret *</label>
                        <input type="text" id="clientSecret" name="clientSecret" required
                               placeholder="xxxxxxxxxxxxxxxxxxxxxxxx">
                        <div class="help-text">Desde tu Installed Package en SFMC</div>
                    </div>

                    <div class="form-group">
                        <label for="authBaseUrl">Auth Base URL *</label>
                        <input type="url" id="authBaseUrl" name="authBaseUrl" required value="https://mcgwsh19xsfbh858gh-fc-cy7-w4.auth.marketingcloudapis.com/"
                               placeholder="https://YOUR_SUBDOMAIN.auth.marketingcloudapis.com/">
                        <div class="help-text">Termina en .auth.marketingcloudapis.com/</div>
                    </div>
                </div>

                <div class="step">
                    <h3>ğŸ“ Repositorio GitHub</h3>

                    <div class="form-group">
                        <label for="githubRepo">URL del Repositorio GitHub *</label>
                        <input type="url" id="githubRepo" name="githubRepo" required
                               value="https://raw.githubusercontent.com/oskyar/miniframework-ssjs/main/"
                               placeholder="https://raw.githubusercontent.com/oskyar/miniframework-ssjs/main/">
                        <div class="help-text">
                            <strong>Importante:</strong> Debe ser la URL <strong>raw.githubusercontent.com</strong> y terminar en <strong>/</strong>
                            <br>
                            <strong>Ejemplo:</strong> https://raw.githubusercontent.com/tuusuario/omegaframework/main/
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <strong>âš ï¸ Antes de continuar:</strong>
                        <ol>
                            <li>AsegÃºrate de que el repositorio sea <strong>pÃºblico</strong> o configura acceso</li>
                            <li>Verifica que la URL termine en <strong>/</strong> (slash final)</li>
                            <li>Prueba la URL en tu navegador: debe mostrar cÃ³digo, no HTML</li>
                        </ol>
                    </div>

                    <div class="checkbox">
                        <input type="checkbox" id="installOptional" name="installOptional">
                        <label for="installOptional">Instalar mÃ³dulos opcionales (AssetCreator, JourneyCreator)</label>
                    </div>
                </div>

                <input type="hidden" name="install" value="true">
                <button type="submit" class="btn-primary">ğŸš€ Instalar desde GitHub</button>
            </form>

            <div class="step" style="margin-top:30px">
                <h3>â“ Â¿CÃ³mo preparar tu repositorio GitHub?</h3>
                <ol>
                    <li>Crea un repositorio pÃºblico en GitHub (o usa uno existente)</li>
                    <li>Sube todos los archivos del framework manteniendo la estructura:
                        <pre>omegaframework/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ Core.ssjs
â”‚   â”œâ”€â”€ Settings.ssjs
â”‚   â”œâ”€â”€ ResponseWrapper.ssjs
â”‚   â””â”€â”€ ...</pre>
                    </li>
                    <li>AsegÃºrate de que los archivos sean accesibles pÃºblicamente</li>
                    <li>Copia la URL raw: <code>https://raw.githubusercontent.com/USERNAME/REPO/main/</code></li>
                    <li>PÃ©gala arriba y haz clic en "Instalar desde GitHub"</li>
                </ol>
            </div>

            <script runat="server">
        } // End else
        </script>

    </div>
</div>

<script>
// Prevenir mÃºltiples envÃ­os del formulario
document.addEventListener('DOMContentLoaded', function() {
    var form = document.getElementById('installerForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            var submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                // Deshabilitar botÃ³n
                submitBtn.disabled = true;
                submitBtn.textContent = 'â³ Instalando... Por favor espera';
                submitBtn.style.opacity = '0.7';
                submitBtn.style.cursor = 'not-allowed';
            }
            // El formulario se enviarÃ¡ normalmente despuÃ©s de esto
        });
    }
});
</script>

</body>
</html>
